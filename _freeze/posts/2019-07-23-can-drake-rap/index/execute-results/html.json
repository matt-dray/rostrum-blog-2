{
  "hash": "e874bd4677dd6c51ed7ad77413c956c4",
  "result": {
    "markdown": "---\ntitle: Can {drake} RAP?\ndate: 2019-07-23\nslug: can-drake-rap\ncategories:\n  - drake\n  - r\n  - reproducibility\n---\n\n::: {.cell}\n\n:::\n\n\n![A drake, Sir Drake, Drake, Drake, Drake and {drake}.](resources/hall-of-fame.jpeg){fig-alt=\"Six images: a male duck, Sir Francis Drake, Drake from the Drake & Josh TV show, Nathan Drake from the Uncharted video games, Drake the musical artist, and the hex sticker for the drake package.\" width=\"75%\"}\n\n## tl;dr\n\n[The {drake} package](https://github.com/ropensci/drake) records file interdependecies in your analysis. When files are changed, {drake} only re-runs the parts that need to be re-run. This saves time and reduces error.\n\nThis could be useful for [Reproducible Analytical Pipelines (RAP)](https://analysisfunction.civilservice.gov.uk/support/reproducible-analytical-pipelines/), an automated approach to producing UK government statistics that minimises error and speeds production.\n\n## Make it to make it\n\nAnalysis projects can become complicated as multiple inputs, script files and outputs build up.\n\nCan you remember exactly which scripts need to be re-executed after a file changes? Or will you have to re-run the entire project from scratch? This is tedious and open to error if you miss something.\n\nA ['makefile'](https://en.wikipedia.org/wiki/Makefile) can help you. In short, it's a text file in which you write each step of your analysis in a recipe-like format. Dependencies between data, code and outputs are recorded.\n\nA makefile ensures that only the affected file and those downstream from it will be re-executed. This saves compute time and means you don't have to remember any dependencies yourself.\n\n## {drake} it to make it\n\n[{drake}](https://github.com/ropensci/drake) is a package by [Will Landau](https://wlandau.github.io/) that gives you makefiles with R syntax. It can be installed with `install.packages(\"drake)`.\n\nThis post contains a very simple example of {drake} in action, but there's so much more to it. Fortunately, there's lots of information:\n\n* [user manual](https://ropenscilabs.github.io/drake-manual/)\n* [documentation](https://ropensci.github.io/drake/)\n* [cheat sheet](https://github.com/krlmlr/drake-sib-zurich/blob/master/cheat-sheet.pdf) by [Kirill Müller](https://twitter.com/krlmlr)\n* ['drake for workflow happiness'](https://aedobbyn.github.io/nyc-fires/index.html#1) slides by [Amanda Dobbyn](https://dobb.ae/) -- which embraces the [Drake meme](https://imgflip.com/memegenerator/91998305/Drake-Blank)\n* [Garrick Aden-Buie]()'s introductory [talk](https://www.garrickadenbuie.com/talk/drake-intro-biodataclub/), including [slides](https://pkg.garrickadenbuie.com/drake-intro/#1) and an [RStudio Cloud Project](https://login.rstudio.cloud/login?setup=1&redirect=%2Foauth%2Fauthorize%3Fredirect_uri%3Dhttps%253A%252F%252Frstudio.cloud%252Flogin%26show_auth%3D0%26show_login%3D1%26response_type%3Dcode%26client_id%3Drstudio-cloud)\n\nWill Landau has also put together:\n\n* the [{learndrake} package](https://github.com/wlandau/learndrake) to... learn {drake}\n* a [Shiny app for planning {drake} projects](https://github.com/wlandau/drakeplanner)\n\n## Demo: {drake} lays an egg\n\nI think there's potential for {drake} in [Reproducible Analytical Pipelines (RAP)](https://ukgovdatascience.github.io/rap-website/): a wholly code-based method for producing [the UK government's statistical reports](https://www.gov.uk/search/research-and-statistics) that improves reproducibility and automation, minimises errors and speeds-up production.\n\nI've made a very simple {drake} demo for an imaginary RAP project. The demo recreates a very small part of a [statistical publication that tracks UK egg production](https://www.gov.uk/government/statistics/egg-statistics)[^egg].\n\n[The demo code is on GitHub](https://github.com/matt-dray/drake-egg-rap) and [the demo report has also been published to the web](https://matt-dray.github.io/drake-egg-rap/egg-report.html). Here's a screenshot of the demo:\n\n![](resources/demo-report-page-short.png){fig-alt=\"A screenshot of the top section of the demo report, with the title 'UK egg statistics' and sections for 'background' and 'throughput'. The top of a chart tracking egg production is visible.\" width=\"100%\"}\n\nBig shout-out to [Duncan Garmonsway](https://www.twitter.com/nacnudus) for [the {govdown} package](https://github.com/ukgovdatascience/govdown/) that recreates the style of [GOV.UK](https://www.gov.uk/)—the website of the UK government—in R Markdown.\n\nThe rest of this post explains the steps in the demo:\n\n1. [Prepare R scripts](#prep)\n2. [Load the scripts](#source)\n3. [Visualise](#viz)\n4. [Make the plan](#make)\n5. [Make a change](#change)\n\n### 1. Prepare the scripts {#prep}\n\nThe repo has [three simple scripts](https://github.com/matt-dray/drake-egg-rap/tree/master/R)[^scripts] containing the code for the analysis:\n\n1. [`packages.R`](https://github.com/matt-dray/drake-egg-rap/blob/master/R/packages.R) loads the packages we need for our analysis with `library()`\n1. [`functions.R`](https://github.com/matt-dray/drake-egg-rap/blob/master/R/functions.R) contains our own custom functions\n1. [egg-report.Rmd](https://github.com/matt-dray/drake-egg-rap/blob/master/egg-report.Rmd) is the R Markdown report that will be output to HTML\n1. [`plan.R`](https://github.com/matt-dray/drake-egg-rap/blob/master/R/plan.R) is where the steps of the analysis are written\n\nThe `plan.R` file needs a little more explanation. It contains the `drake_plan()` function, to which you pass each function required for the analysis. The functions can be in any order; {drake} works out the order from the dependencies between the scripts and outputs.\n\nThe demo plan is very simple, with only four functions wrapped inside `drake_plan()`:\n\n\n::: {.cell}\n\n```{.r .cell-code}\negg_plan <- drake_plan(  # Create a drake_plan object called egg_plan\n  \n  # 1. Read the dataset\n  raw_data = read_ods(\n    path = \"data/eggs-packers-02may19a.ods\",\n    sheet = \"Packers_Annual\",\n    skip = 8\n  ),  # separate each function with a comma\n  \n  # 2. Prepare the data with a bespoke function\n  # from the functions.R file\n  data = clean_data(raw_data),\n  \n  # 3. Generate a plot using a bespoke function\n  # from the functions.R file\n  plot = create_plot(data),\n  \n  # 4. Finally, render the R Markdown report\n  # drake::knitr_in() marks the .Rmd file as a dependency\n  # drake::file_out() marks the .HTML as an output\n  report = rmarkdown::render(\n    knitr_in(\"egg-report.Rmd\"),\n    output_file = file_out(\"docs/egg-report.html\"),\n    quiet = TRUE\n  )\n\n)\n```\n:::\n\n\n### 2. Load the scripts {#source}\n\nThe data and code are all in place. How do we run the analysis?\n\nEverything we need is stored in [a small file called `make.R`](https://github.com/matt-dray/drake-egg-rap/blob/master/make.R). It starts by calling `source()` for each R script:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsource(packages.R)   # load the packages\nsource(functions.R)  # load the bespoke functions\nsource(plan.R)       # load the plan\n```\n:::\n\n\nSourcing the plan file results in the `drake_plan()` function being run. The output is a special `drake_plan` data frame object, which is called `egg_plan` in our demo. It has columns called 'target' and 'command' and a row for each function in our analysis:\n\n\n::: {.cell}\n\n```{.r .cell-code}\negg_plan\n```\n:::\n\n```\n# A tibble: 4 x 2\n  target   command                                                                           \n  <chr>    <expr>                                                                            \n1 raw_data read_ods(path = \"data/eggs-packers-02may19a.ods\", sheet = \"Packers_Annual\",      …\n2 data     clean_data(raw_data)                                                             …\n3 plot     create_plot(data)                                                                …\n4 report   render(knitr_in(\"egg-report.Rmd\"), output_file = file_out(\"docs/egg-report.html\")…\n```\n\nThe plan object acts like an instruction booklet, which can be read 'to each target (data and outputs), apply the named command (the functions of the analysis)'. So the contents of the `egg_plan` data frame can be read\n\n1. Read the raw data (the target) with `readODS::read_ods()` (the command)\n1. Clean the data (target) with the custom `clean_data()` function (command)\n1. Plot the data (target) with the custom `plot_data()` function (command)\n1. Create an R Markdown report (target) with `rmarkdown::render()` (command)\n\nSo we have the instructions stored in an object. Now we can (optionally) produce a dependency graph of these targets to get an idea of the relationships between the elements of the analysis.\n\n### 3. Visualise {#viz}\n\nThe first step to create the visual is to extract information about the `egg_plan` in a configuration ('config') list object. One element of the config is, for example, an [igraph](https://igraph.org/) object that helps construct graphs from your workflow. The function to get this is `drake_config()`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\negg_config <- drake_config(egg_plan)\n```\n:::\n\n\nA number of {drake} functions can take the config object and do something with the information inside it. In our case, we're going to pass the config to `vis_drake_graph()`, which builds an interactive dependency graph using {visNetwork}.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nvis_drake_graph(egg_config)\n```\n:::\n\n\nThis generates an interactive output [(see it here)](https://matt-dray.github.io/drake-egg-rap/dependency-graph.html). Here's a screenshot:\n\n![](resources/dependency-static.png){fig-alt=\"A screenshot of the interactive dependency graph showing the relationship between objects, files and functions in the analysis represented by different shapes and colours.\" width=\"100%\"}\n\nThe visualisation is shape-coded by target type (e.g. functions are triangles) and colour-coded to show whether everything is up-to-date (e.g. green if it is). Arrows show the file dependencies (e.g. both the `clean_data` function and `raw_data` file come together to produce the `data` object).\n\n### 4. Make the plan {#make}\n\nHaving satisfied yourself that the plan looks correct, running the plan is as simple as:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmake(egg_plan)\n```\n:::\n\n\nThis executes all the instructions laid out in the `egg_plan` object and our HTML report pops out at the end.\n\nOf course, re-running the plan straight away again does... nothing. No code needs to be re-executed if nothing's changed!\n\n#### Side note: the cache\n\nTurns out that {drake} is storing all the intermediate objects that were created when making your plan. They're cached in a hidden `.drake/` folder so they can be retrieved without needing to be re-created.\n\nThis means you can use the `.drake/` cache to supply objects to an R Markdown file, which is achieved by either `readd()`ing or `loadd()`ing them. For example, [the plot in the demo R Markdown file was called with `loadd(plot)`](https://github.com/matt-dray/drake-egg-rap/blob/master/egg-report.Rmd).\n\n### 5. Make a change {#change}\n\nIf anything changes in our data or code then the downstream targets will be out of sync. Let's pretend we've changed a line of code in the `create_plot()` function, which could be something is superficial as altering its title. What do you think will happen?\n\nWell, {drake} knows there's been a change. You can check this by running `source(\"R/functions.R\")` in `make.R` again and then run `outdated(egg_config)`. This prints the name of the altered file plus the other files impacted by it.\n\nWe can see this by recreating the dependency graph [(see it here)](https://matt-dray.github.io/drake-egg-rap/dependency-graph-outdated.html): the `plot` target is outdated, as are the targets downstream that depend on it (`report` and the `egg-report.html` file). This is indicated by them being coloured black. Here's a static version:\n\n![](resources/dependency-outdated-static.png){fig-alt=\"A screenshot of the interactive dependency graph showing that outdated items (the plot and report) are now coloured black. The other items aren't black because they're not impacted by the change to the plot function.\" width=\"100%\"}\n\nSo now we can see the real power of {drake}, as re-running the plan now will regenerate only the outdated files.\n\n## In review\n\nAt its simplest, you create a `plan.R` and you `make()` it.\n\nHopefully you've seen how {drake}:\n\n* remembers the dependencies between the files of your analysis\n* only re-runs what needs to be re-run\n\nI think this alone can help build the reliability and trustworthiness of published statistical reports.\n\nOf course, this is a very simple use of {drake} and should act as a starting point. [{drake} does a lot more](https://ropenscilabs.github.io/drake-manual/), like high-performance computing and memory management, that may also come in useful for RAP.\n\n## Environment {.appendix}\n\n<details><summary>Session info</summary>\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n```\nLast rendered: 2023-07-25 20:33:27 BST\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\nR version 4.3.1 (2023-06-16)\nPlatform: aarch64-apple-darwin20 (64-bit)\nRunning under: macOS Ventura 13.2.1\n\nMatrix products: default\nBLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib \nLAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0\n\nlocale:\n[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n\ntime zone: Europe/London\ntzcode source: internal\n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nloaded via a namespace (and not attached):\n [1] htmlwidgets_1.6.2 compiler_4.3.1    fastmap_1.1.1     cli_3.6.1        \n [5] tools_4.3.1       htmltools_0.5.5   rstudioapi_0.15.0 yaml_2.3.7       \n [9] rmarkdown_2.23    knitr_1.43.1      jsonlite_1.8.7    xfun_0.39        \n[13] digest_0.6.33     rlang_1.1.1       evaluate_0.21    \n```\n:::\n:::\n\n</details>\n\n[^egg]: This publication could be a good candidate for RAP: content remains fairly similar between quarterly releases and it's required to meet high standards of quality because it's badged as [National Statistics](https://www.statisticsauthority.gov.uk/osr/list-of-national-statistics/).\n[^scripts]: You don't have to restrict yourself to this configuration of scripts, but it can make it easier to handle your project.\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}