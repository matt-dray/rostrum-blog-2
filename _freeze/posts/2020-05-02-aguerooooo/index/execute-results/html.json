{
  "hash": "f1305db2b520b97fc89c8615d68babc2",
  "result": {
    "markdown": "---\ntitle: AGÜEROOOOO with {ggsoccer} and {gganimate}\ndate: 2020-05-02\nslug: aguerooooo\ncategories:\n  - dataviz\n  - gganimate\n  - ggsoccer\n  - ggplot2\n  - r\n  - sport\n---\n\n::: {.cell}\n::: {.cell-output-display}\n![](index_files/figure-html/full-code-1.gif)\n:::\n:::\n\n\n## tl;dr\n\nI used R to animate the goal that won Manchester City [the 2011/12 Premier League title](https://en.wikipedia.org/wiki/2011%E2%80%9312_Premier_League) in [breathtaking fashion](https://youtu.be/4XSo5Z0hEAs).\n\n[Inspired by Ryo Nakagawara](https://ryo-n7.github.io/2018-06-29-visualize-worldcup/), who makes awesome R-related soccer content that you can find on [his site](https://ryo-n7.github.io/) and [on Twitter](https://twitter.com/R_by_Ryo).[^brickr]\n\n## The 'problem'\n\nSoccer has run dry.\n\nLeagues have [been cancelled](https://www.bbc.co.uk/sport/football/52418048) or [decided on a contentious points-per-game basis](https://www.bbc.co.uk/sport/football/52484926) given that there's no precedent. The fate of the 2019/20 English Premier League season is still unknown.[^predict]\n\nI figured it would be a good time to revisit a season that finished in the most emphatic fashion; one that was decided in the final minute of the final game.\n\n### The game\n\nCity and United were level on points at the top of the Premier League as they entered their final matches of the 2011/12 season. Only goal difference separated them.\n\n| Pos | Team | Played | GD | Points |\n|--:|:--|--:|--:|--:|\n| 1 | Manchester City | 37 | +63 | 86 |\n| 2 | Manchester United | 37 | +55 | 86 |\n\nAs the game entered the closing stages, a dominant City somehow found themselves 2-1 down to a lacklustre Queens Park Rangers side.\n\nAfter sustained pressure, [Edin Dzeko scored a towering header from a corner](https://youtu.be/4XSo5Z0hEAs?t=1027) after 92 minutes. The game was level at 2-2, but it wouldn't be enough to win the title; one more goal was needed.\n\nMeanwhile, Manchester United had won their concurrent game at Sunderland and had every right to think the title was theirs.\n\n| Pos | Team | Played | GD | Points |\n|--:|:--|--:|--:|--:|\n| 1 | Manchester United | 38 | +56 | 89 |\n| 2 | Manchester City | 38 | +63 | 87 |\n\nBut [after 93 minutes](https://youtu.be/4XSo5Z0hEAs?t=1148), City's Nigel De Jong burst into QPR's half. Sergio stepped forward, received the ball and beat his man. He passed to Mario Balotelli and continued his run into the box. Super Mario slid to the ground and pushed the ball into Agüero's path.\n\nThe rest is history: Sergio received the ball, beat a slide tackle and smashed the ball into the goal. Cue commentator Martin Tyler screaming ['AGÜEROOOOO!'](https://youtu.be/oepskn9gjDI?t=1130).\n\n| Pos | Team | Played | GD | Points |\n|--:|:--|--:|--:|--:|\n| 1 | Manchester City | 37 | +64 | 89 |\n| 2 | Manchester United | 37 | +56 | 89 |\n\nCity had done the impossible to win their first Premier League trophy and first top-flight title in 44 years.\n\n## Reliving the moment\n\nSo the sensible thing to do is to use R to make a gif of the player movements in the build-up to the goal.\n\nYou may have seen something like this before from [Ryo Nakagawara](https://ryo-n7.github.io/2018-06-29-visualize-worldcup/) and others. I took a slightly different approach to Ryo, but the result is basically the same.\n\nYou need three packages:[^annotater]\n\n* [{ggplot2}](https://ggplot2.tidyverse.org/), created by [Hadley Wickham](http://hadley.nz/), to provide the plotting framework\n* [{ggsoccer}](https://torvaney.github.io/ggsoccer/), by [Ben Torvaney](http://www.statsandsnakeoil.com/), for the grid and pitch theme\n* [{gganimate}](https://gganimate.com/), by [Thomas Lin Pedersen](https://www.data-imaginist.com/), for animating each step and interpolating between them\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load packages\nlibrary(ggplot2) # Create Elegant Data Visualisations Using the Grammar of Graphics\nlibrary(ggsoccer) # Plot Soccer Event Data\nlibrary(gganimate) # A Grammar of Animated Graphics\nlibrary(tibble) # Simple Data Frames\n```\n:::\n\n\nI also used {tibble} to create data frames with `tribble()`, but this isn't a requirement.\n\n## Set coordinates\n\nYou need to start with coordinate data for the players and ball. {ggsoccer} defaults to a 100- by 100-unit pitch on which to plot these data. But where do you get it from?\n\nYou could use [Opta](https://www.optasports.com/)'s premium service for accessing player-tracking data. My approach was more... artisanal. I just watched some grainy YouTube videos and roughly guessed where the players were.\n\nA really nice interactive tool that makes the process easier is the [soccer event logger](https://torvaney.github.io/projects/tracker) by Ben Torvaney, creator of {ggsoccer}.\n\n### Players\n\nThe first data frame contains each player's coordinates, with a row for each frame of the final animation. I added the player name so it could be used as a label.\n\nI chose to focus on the three active players in the build-up to the goal. This made the final graphic clearer, yes, but more importantly it meant I had fewer data points to input.\n\nI created the data frame using `tribble()` from the {tibble} package because I found it easier to input the data in a row-wise fashion. It's also easy to write a comment per line to explain what's happening.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Player position data\nplayers <- tribble(\n  \n  ~frame, ~name, ~x, ~y,  # column names\n  \n  1, \"De Jong\", 50, 50,  # advances from own half\n  2, \"De Jong\", 56, 50,  # advances into oppo half\n  3, \"De Jong\", 64, 50,  # passes to Agüero\n  4, \"De Jong\", 64, 50,  # off the ball\n  5, \"De Jong\", 64, 50,  # off the ball\n  6, \"De Jong\", 64, 50,  # off the ball\n  7, \"De Jong\", 64, 50,  # off the ball\n  8, \"De Jong\", 64, 50,  # off the ball\n  \n  1, \"Agüero\", 85, 70, # diagonal run to meet ball from De Jong\n  2, \"Agüero\", 80, 65, # diagonal run to meet ball from De Jong\n  3, \"Agüero\", 75, 60, # receives pass from De Jong\n  4, \"Agüero\", 76, 63, # beats defender, passes to Balotelli\n  5, \"Agüero\", 80, 50, # advances to edge of box\n  6, \"Agüero\", 87, 38, # receives pass from Balotelli\n  7, \"Agüero\", 93, 36, # shot\n  8, \"Agüero\", 94, 33, # goal\n  \n  1, \"Balotelli\", 83, 61, # waiting on edge of box\n  2, \"Balotelli\", 83, 61, # waiting on edge of box\n  3, \"Balotelli\", 83, 61, # waiting on edge of box\n  4, \"Balotelli\", 83, 57, # waiting on edge of box\n  5, \"Balotelli\", 83, 55, # recieves pass from Agüero\n  6, \"Balotelli\", 83, 55, # passes to Agüero\n  7, \"Balotelli\", 83, 54, # off the ball\n  8, \"Balotelli\", 83, 54, # off the ball\n  \n)\n```\n:::\n\n\nSo each player has coordinates for each time step.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Preview the data frame\nhead(players[order(players$frame), ])\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 6 × 4\n  frame name          x     y\n  <dbl> <chr>     <dbl> <dbl>\n1     1 De Jong      50    50\n2     1 Agüero       85    70\n3     1 Balotelli    83    61\n4     2 De Jong      56    50\n5     2 Agüero       80    65\n6     2 Balotelli    83    61\n```\n:::\n:::\n\n\n### Ball\n\nI put the coordinate data for the ball in a separate data frame. This made it easier to specify and modify separately the ball and player data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Ball position data\nball <- tribble(\n  \n  ~frame, ~x, ~y,\n  \n  1,  51, 50,  # De Jong possession\n  2,  57, 50,  # De Jong pass\n  3,  74, 60,  # receievd by Agüero\n  4,  77, 63,  # Agüero pass\n  5,  83, 54,  # received by Balotelli\n  6,  88, 38,  # received by Agüero\n  7,  94, 36,  # Agüero shot\n  8, 100, 46   # goal \n\n)\n```\n:::\n\n\n## Graphics\n\nThe first step in producing the animation is to create a single plot object that contains all the points. {gganimate} takes the object and animates it frame by frame, interpolating the data points between each time step.\n\n### Static plot\n\nTo produce the plot object:\n\n1. Plot the pitch area\n1. Add ball data first so the points will appear 'under' the player points\n1. Add player points and labels\n1. Add a title\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Plot all the data\nplot <- \n  ggplot() +       # blank canvas\n  annotate_pitch(  # plot 100 * 100 unit pitch \n    colour = \"white\", fill = \"#7fc47f\", limits = FALSE\n  ) +\n  theme_pitch() +  # theme removes plotting elements\n  coord_flip(      # rotate and crop pitch\n    xlim = c(49, 101), ylim = c(-12, 112)\n  ) +\n  geom_point(      # add ball data\n    data = ball,\n    aes(x = x, y = 100 - y),\n    colour = \"black\", fill = \"white\", pch = 21, size = 2\n  ) +\n  geom_point(      # add player data\n    data = players, \n    aes(x = x, y = 100 - y), \n    colour = \"black\", fill = \"skyblue\", pch = 21, size = 4\n  ) +\n  geom_text(       # add player labels\n    data = players, aes(x = x, y = 100 - y, label = name),\n    hjust = -0.2, nudge_x = 1\n  ) +\n  ggtitle(         # add title\n    label = \"MCY [3]-2 QPR\",\n    subtitle = \"93:20 GOAL Sergio Agüero\"\n  )\n```\n:::\n\n\nI've chosen to rotate the plot and crop it because we only need to see one half of the pitch. Note that this means the y-aesthetic for the points is set to `100 - y`.\n\nThe output `plot` object is composed of all the frames that we set out in the `player` and `ball` data sets. You wouldn't plot this object as-is, but here's what it looks like:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/see-plot-1.png){width=672}\n:::\n:::\n\n\n{gganimate} will take each time-step---specified by the `frame` variable---to render the animation. Here's each of those frames from the `player` data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot + facet_wrap(~ frame) + ggtitle(NULL, NULL)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/facet-wrap-1.png){width=672}\n:::\n:::\n\n\n### Animated plots\n\n{gganimate} turns the static plot into an animation in one step.\n\nThe `transition_states()` function builds on top of the `plot` object. I specified the time-step variable; the durations for showing the frame and the interpolated frames between; and whether or not the animation should loop back to the start. \n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Animate the plot\nanimation <-\n  plot +                   # the plot object\n  transition_states(\n    frame,                 # time-step variable\n    state_length = 0.01,   # duration of frame\n    transition_length = 1, # duration between frames\n    wrap = FALSE           # restart, don't loop\n  )\n```\n:::\n\n\nYou can use the `animate()` function to render it.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nanimate(animation)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/see-animation-1.gif)\n:::\n:::\n\n\nAGÜEROOOOO!\n\nYou can save the result as a gif with `anim_save()`, which works like `ggsave()` from {ggplot2}: the default is to save the latest animation to your working directory.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nanim_save(\"9320.gif\")\n```\n:::\n\n\nLuckily the gif keeps looping so you can keep watching until a decision is made on how the current Premier League season will end.\n\n## Environment {.appendix}\n\n<details><summary>Session info</summary>\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n```\nLast rendered: 2023-07-22 11:39:13 BST\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\nR version 4.3.1 (2023-06-16)\nPlatform: aarch64-apple-darwin20 (64-bit)\nRunning under: macOS Ventura 13.2.1\n\nMatrix products: default\nBLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib \nLAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0\n\nlocale:\n[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n\ntime zone: Europe/London\ntzcode source: internal\n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nother attached packages:\n[1] tibble_3.2.1    gganimate_1.0.8 ggsoccer_0.1.7  ggplot2_3.4.2  \n\nloaded via a namespace (and not attached):\n [1] gtable_0.3.3      jsonlite_1.8.7    dplyr_1.1.2       compiler_4.3.1   \n [5] crayon_1.5.2      Rcpp_1.0.11       tidyselect_1.2.0  magick_2.7.4     \n [9] progress_1.2.2    scales_1.2.1      yaml_2.3.7        fastmap_1.1.1    \n[13] R6_2.5.1          labeling_0.4.2    generics_0.1.3    knitr_1.43.1     \n[17] htmlwidgets_1.6.2 munsell_0.5.0     pillar_1.9.0      rlang_1.1.1      \n[21] utf8_1.2.3        stringi_1.7.12    xfun_0.39         cli_3.6.1        \n[25] withr_2.5.0       magrittr_2.0.3    tweenr_2.0.2      digest_0.6.33    \n[29] grid_4.3.1        rstudioapi_0.15.0 hms_1.1.3         lifecycle_1.0.3  \n[33] prettyunits_1.1.1 vctrs_0.6.3       evaluate_0.21     glue_1.6.2       \n[37] farver_2.1.1      fansi_1.0.4       colorspace_2.1-0  rmarkdown_2.23   \n[41] tools_4.3.1       pkgconfig_2.0.3   htmltools_0.5.5  \n```\n:::\n:::\n\n</details>\n\n[^brickr]: Also a fellow builder of [{brickr} soccer players](https://twitter.com/R_by_Ryo/status/1134789739301621760?s=20).\n[^predict]: But do check out posts by [Ben Torvaney](http://www.statsandsnakeoil.com/2019/01/01/predicting-the-premier-league-with-dixon-coles/) and [Robert Hickman](https://www.robert-hickman.eu/post/dixon_coles_2/) on predicting Premier League outcomes with R.\n[^annotater]: An aside: I used [the {annotater} RStudio Addin](https://luisdva.github.io/rstats/annotater/) by [Luis D Verde](https://luisdva.github.io/) to annotate these library calls.\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}