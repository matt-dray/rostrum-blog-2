{
  "hash": "08e78a80d7ab55e484ca6996a0d71ec2",
  "result": {
    "markdown": "---\ntitle: 'Repaying Tom Nook with {S7}'\nauthor: Matt Dray\ndate: '2023-02-26'\nslug: nook-s7\ncategories:\n  - code\n  - tutorial\ntags:\n  - animal-crossing\n  - oop\n  - r\n  - R6\n  - S7 \n---\n\n\n\n\n<div class=\"figure\">\n<img src=\"/post/2023-02-23-nook-s7_files/acnh-s7-knit.jpg\" alt=\"Fish-eye lens selfie of the player-character from the game Animal Crossing New Horizons. The character is wearing a knitted black hoodie with bright green letters that say 'S7'. The picture is taken in the Resident Services building. Tom Nook, a raccoon-dog character, is in the background staring ominously at the player.\" width=\"100%\"/>\n</div>\n\n# tl;dr\n\nThe ~~R7~~ [S7 object-oriented system](https://rconsortium.github.io/OOP-WG/) is coming to R. I've done a little R6-to-S7 translation on [an old project](https://www.rostrum.blog/2020/04/04/repaying-tom-nook-with-r6/) to get a very cursory feel for it, featuring [Animal Crossing New Horizons](https://www.animal-crossing.com/new-horizons/).\n\n<div class=\"tip\"> `<svg aria-hidden=\"true\" role=\"img\" viewBox=\"0 0 512 512\" style=\"height:1em;width:1em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:currentColor;overflow:visible;position:relative;\"><path d=\"M504 256c0 136.997-111.043 248-248 248S8 392.997 8 256C8 119.083 119.043 8 256 8s248 111.083 248 248zm-248 50c-25.405 0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346l7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373 0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884 0-12.356 5.78-11.981 12.654z\"/></svg>`{=html} <b>Update</b>\n\nThe S7 system and package are under development and could change at any time, rendering everything in this post useless.[^useless] Heck, last time I checked, the system was called 'R7'. There's also a chance that S7 elements may have been integrated into base R itself by the time you read this.\n\n</div>\n\n# 2020 again, oh no\n\nAnimal Crossing New Horizons (ACNH) was the perfect pandemic game. And the pandemic was the perfect time to [build an ersatz version of the ACNH in-game banking system](https://www.rostrum.blog/2020/04/04/repaying-tom-nook-with-r6/) to solve [an exercise in the Advanced R book](https://adv-r.hadley.nz/r6.html#exercises-44) using [the {R6} package for object-oriented programming (OOP)](https://r6.r-lib.org/) in R.\n\nThe exercise helped me fantasize about defeating the game's main boss, the predatory loanshark (loanraccoon?) [Tom Nook](https://animalcrossing.fandom.com/wiki/Tom_Nook), via endless wire transfers of hard-earned in-game currency, called 'Bells'.\n\nOf course, a lot has changed since 2020. Most importantly, [a new OOP system for R is being developed](https://github.com/RConsortium/OOP-WG). Conversely, Tom Nook has not changed. He is still a scourge.\n\nAnyway, maybe this is a chance to twitch my OOP muscles with this new system.\n\n# OOP they did it again\n\nThe [R Consortium](https://www.r-consortium.org/)'s OOP working group has been beavering (raccooning?) away to develop a new OOP system from the ground up: S7[^snake] ([S3 + S4](https://github.com/RConsortium/OOP-WG/issues/262), geddit?). \n\nThe idea is to take the best elements of [the existing and in-built S3 and S4 systems](https://adv-r.hadley.nz/oo.html), interface with them and improve on them. \n\nYou can [read various design docs and meeting minutes on their documentation site](https://rconsortium.github.io/OOP-WG/), which is housed in their ['OOP-WG' GitHub repo](https://github.com/RConsortium/OOP-WG/), and try out the current iteration of the associated package, fittingly called {S7}.\n\nYou should refer to their docs in the first instance, or a useful third party review. For example, [Jumping Rivers](https://www.jumpingrivers.com/) have... jumped the river on this one and produced [a handy intro](https://www.jumpingrivers.com/blog/r7-oop-object-oriented-programming-r/).\n\n# A new horizon for OOP\n\nNaturally, I should revisit my post on [Repaying Tom Nook with {R6}](https://www.rostrum.blog/2020/04/04/repaying-tom-nook-with-r6/) by replicating it with {S7}. Naturally.\n\nAha, but actually the {S7} package is more like a development of S3 and S4 objects, and is not a 'new version' of {R6}! Ah well. I'm noodling around with {S7} for my own devices and thought I'd post it here so I can refer back to it later. \n\nBasically I'm recycling content from a previous post to get a feel for the new system. But only in the most superficial, basic way. I spent about 15 minutes on this. Look elsewhere for actually-usefully material. You have been warned.\n\n# Install\n\nFor now, the {S7} package is in [the R Consortium's OOP-WG GitHub repo](https://github.com/RConsortium/OOP-WG/).\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninstall.packages(\"remotes\")  # if not yet installed\nremotes::install_github(\"RConsortium/OOP-WG\")\n```\n:::\n\n\nAnd for some glamour we'll also use the quintessential [{emoji} package](https://emilhvitfeldt.github.io/emoji/)[^emo]\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninstall.packages(\"emoji\")  # if not yet installed\nlibrary(emoji)\n```\n:::\n\n\n# That is class\n\nA new class is constructed with... `new_class()`\n\nWe can give it a name. We can also give it properties: fields that contain data and can be provided a type check and default value. It's possible to build validators for these as well, which ensure that certain conditions are met when the properties are adjusted. I'll keep this simple for now: I just want the values to remain equal or greater than zero.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nABD <- new_class(\n  name = \"ABD\",\n  properties = list(\n    savings = new_property(class_integer, default = 0L),\n    loan = new_property(class_integer, default = 2498000L)\n  ),\n  validator = function(self) {\n    if (self@savings < 0L) {\n      \"@savings must be zero or more\"\n    } else if (self@loan < 0L) {\n      \"@loan must be zero or more\"\n    }\n  }\n)\n```\n:::\n\n\nFor new methods, you can create a new 'generic' and define a function for it. For example, the 'deposit' method is pretty straightforward: it just adds an amount to the current savings value.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeposit <- new_generic(\"deposit\", \"x\")\n\nmethod(deposit, ABD) <- function(x, amount) {\n  x@savings <- x@savings + amount\n  x\n}\n```\n:::\n\n\nI specified some other methods, but I hid them because they're not much more complicated.\n\n<details><summary>Click for more methods</summary>\n\nThe 'withdraw' method subtracts a specified amount from the savings property. You're warned if you specify an amount greater than the amount available. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nwithdraw <- new_generic(\"withdraw\", \"x\")\n\nmethod(withdraw, ABD) <- function(x, amount) {\n  \n  if (x@savings - amount < 0L) {\n    warning(\n      \"Withdrew all savings: \", x@savings, \" Bells.\\n\", \n      call. = FALSE\n    )\n    x@savings <- 0L\n  } else {\n    x@savings <- x@savings - amount\n  }\n  \n  x\n  \n}\n```\n:::\n\n\nThe 'pay' method moves funds from savings to loan. You're warned if the loan is already paid, if you specify a greater amount than there are savings, or if you pay a greater amount than the loan remaining. You'll get a victory message if you pay off the whole loan.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npay <- new_generic(\"pay\", \"x\")\n\nmethod(pay, ABD) <- function(x, amount) {\n  \n  if (x@loan == 0L) {\n    stop(\"You already finished paying your loan!\\n\", call. = FALSE)\n  }\n  \n  if (x@savings - amount < 0L) {\n    warning(\n      \"Paid total amount from savings instead: \", x@savings, \" Bells.\\n\",\n      call. = FALSE\n    )\n    x@loan <- x@loan - x@savings\n    x@savings <- 0L\n  } else if (x@loan - amount < 0L) {\n    warning(\n      \"Paid total remaining loan instead: \", x@loan, \" Bells.\\n\",\n      call. = FALSE\n    )\n    x@savings <- x@savings - x@loan \n    x@loan <- 0L\n  } else {\n    x@savings <- x@savings - amount\n    x@loan <- x@loan - amount\n  }\n  \n  if (x@loan == 0L) {\n    cat(\n      emoji(\"smiley\"),\n      \"Sweet! I finally finished paying off my very last home loan!\",\n      emoji(\"tada\"), \"\\n\\n\"\n    )\n  }\n  \n  x\n  \n}\n```\n:::\n\n\nThe check method is basically a print method. It reports the loan and savings amounts currently stored in the bank.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncheck <- new_generic(\"check\", \"x\")\n\nmethod(check, ABD) <- function(x) {\n\n  loan_formatted <- format(x@loan, big.mark = \",\", scientific = FALSE)\n\n  savings_formatted <- format(x@savings, big.mark = \",\", scientific = FALSE)\n\n  cat(\"Automatic Bell Dispenser (ABD)\\n\\n\")\n  cat(emoji(\"bell\"), \"Loan Balance:\", loan_formatted, \"Bells\\n\")\n  cat(emoji(\"pig2\"), \"Savings Balance:\", savings_formatted, \"Bells\\n\\n\")\n  cat(\n    \"Please make a selection from the menu below\\n\\n\",\n    emoji(\"house\"), \"pay()\\n\",\n    emoji(\"arrow_up\"), \"deposit()\\n\",\n    emoji(\"arrow_down\"), \"withdraw()\"\n  )\n\n}\n```\n:::\n\n\n</details>\n\nYou can start a new instance of the ABD class by, y'know, calling it. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nbank <- ABD()\n```\n:::\n\n\nWhen you check the class of this object, you'll see both the custom class name and a reminder that it has the 'S7' class.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nclass(bank)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"ABD\"       \"S7_object\"\n```\n:::\n:::\n\n\nThe vanilla print method exposes the properties and their startup values:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbank\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n<ABD>\n @ savings: int 0\n @ loan   : int 2498000\n```\n:::\n:::\n\n\nNote that the properties are prepended with `@`. This indicates that we can use the 'at' symbol to access these 'slots' (like S4) from the object, like:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbank@loan\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 2498000\n```\n:::\n:::\n\n\nWhile we're printing stuff, we can use the `check()` method (that I've pre-specified) to see the properties in a manner that more closely resembles the game.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncheck(bank)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nAutomatic Bell Dispenser (ABD)\n\n🔔 Loan Balance: 2,498,000 Bells\n🐖 Savings Balance: 0 Bells\n\nPlease make a selection from the menu below\n\n 🏠 pay()\n ⬆️ deposit()\n ⬇️ withdraw()\n```\n:::\n:::\n\n\nYou can easily and directly change the properties. To add 10 Bells:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbank@savings <- 9.99\n```\n:::\n\n```\nError: <ABD>@savings must be <integer>, not <double>\n```\n\nHaha, whoops. Remember I specified that the property can only be an integer, so we need to provide an integer value instead of a double value. In other words, we can only provide whole numbers of Bells. Remember that the `L` suffix is used in R to signify an integer.[^why]\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbank@savings <- 10L\n```\n:::\n\n\nIs there an overdraft? Tom Nook would probably love that and would ask for massive overdraft fees, but it's not programmed into the game. This is where our validator comes in handy. We specified that you can't have a negative amount of savings, so this causes an error: \n\n\n::: {.cell}\n\n```{.r .cell-code}\nbank@savings <- -11L\n```\n:::\n\n```\nError: <ABD> object is invalid:\n- @savings must be zero or more\n```\n\nThat's fine, but I have sometimes I have extra logic I want to evaluate when I adjust the properties. That's why I created new methods earlier on. It means I can use a function to add to the savings property instead, for example.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbank <- deposit(bank, 10L)\nbank@savings\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 10\n```\n:::\n:::\n\n\nWe can retrieve Bells in this fashion too:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbank <- withdraw(bank, 10L)\nbank@savings\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 0\n```\n:::\n:::\n\n\nWhat if we deposit enough Bells to pay the loan?\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbank <- deposit(bank, 2500000L)\nbank <- pay(bank, 2500000L)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: Paid total remaining loan instead: 2498000 Bells.\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n😃 Sweet! I finally finished paying off my very last home loan! 🎉 \n```\n:::\n:::\n\n\nThe method warns us when we try to pay off a value greater than the remaining loan and prints a nice congratulatory message if we've cleared the whole debt.\n\nAnd so we end up with this view:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncheck(bank)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nAutomatic Bell Dispenser (ABD)\n\n🔔 Loan Balance: 0 Bells\n🐖 Savings Balance: 2,000 Bells\n\nPlease make a selection from the menu below\n\n 🏠 pay()\n ⬆️ deposit()\n ⬇️ withdraw()\n```\n:::\n:::\n\n\nHuzzah. Get rekt, raccoon dog. More like Tom _Crook_ amirite.\n\n<div class=\"figure\">\n<img src=\"/post/2023-02-23-nook-s7_files/acnh-s7-knit-2.jpg\" alt=\"Fish-eye lens selfie of the player-character from the game Animal Crossing New Horizons. The character is wearing a knitted black hoodie with bright green letters that say 'S7'. The picture is taken in the Resident Services building.\" width=\"100%\"/>\n</div>\n\n\n---\n<details><summary>Session info</summary>\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n```\n─ Session info ───────────────────────────────────────────────────────────────\n setting  value\n version  R version 4.2.0 (2022-04-22)\n os       macOS Big Sur/Monterey 10.16\n system   x86_64, darwin17.0\n ui       X11\n language (EN)\n collate  en_US.UTF-8\n ctype    en_US.UTF-8\n tz       Europe/London\n date     2023-04-10\n pandoc   2.19.2 @ /Applications/RStudio.app/Contents/Resources/app/quarto/bin/tools/ (via rmarkdown)\n\n─ Packages ───────────────────────────────────────────────────────────────────\n package     * version    date (UTC) lib source\n cli           3.6.0      2023-01-09 [1] CRAN (R 4.2.0)\n digest        0.6.31     2022-12-11 [1] CRAN (R 4.2.0)\n emoji       * 15.0       2022-11-03 [1] CRAN (R 4.2.0)\n evaluate      0.20       2023-01-17 [1] CRAN (R 4.2.0)\n fastmap       1.1.0      2021-01-25 [1] CRAN (R 4.2.0)\n fontawesome   0.2.2      2021-07-02 [1] CRAN (R 4.2.0)\n glue          1.6.2      2022-02-24 [1] CRAN (R 4.2.0)\n htmltools     0.5.2      2021-08-25 [1] CRAN (R 4.2.0)\n htmlwidgets   1.5.4      2021-09-08 [1] CRAN (R 4.2.0)\n jsonlite      1.8.4      2022-12-06 [1] CRAN (R 4.2.0)\n knitr         1.42       2023-01-25 [1] CRAN (R 4.2.0)\n lifecycle     1.0.3      2022-10-07 [1] CRAN (R 4.2.0)\n magrittr      2.0.3      2022-03-30 [1] CRAN (R 4.2.0)\n rlang         1.0.6      2022-09-24 [1] CRAN (R 4.2.0)\n rmarkdown     2.14       2022-04-25 [1] CRAN (R 4.2.0)\n rstudioapi    0.14       2022-08-22 [1] CRAN (R 4.2.0)\n S7          * 0.0.0.9000 2023-02-23 [1] Github (RConsortium/OOP-WG@f2db260)\n sessioninfo   1.2.2      2021-12-06 [1] CRAN (R 4.2.0)\n stringi       1.7.8      2022-07-11 [1] CRAN (R 4.2.0)\n stringr       1.5.0      2022-12-02 [1] CRAN (R 4.2.0)\n xfun          0.37       2023-01-31 [1] CRAN (R 4.2.0)\n yaml          2.3.7      2023-01-23 [1] CRAN (R 4.2.0)\n\n [1] /Library/Frameworks/R.framework/Versions/4.2/Resources/library\n\n──────────────────────────────────────────────────────────────────────────────\n```\n:::\n:::\n</details>\n\n[^useless]: 'Useless' is an extremely relative term with regard to this blog.\n[^snake]: 95% certain that 'S7' is pronounced how a snake might say 'seven': like 'sseven'.\n[^emo]: [{emo}](https://github.com/hadley/emo) is dead, long live [{emoji}](https://emilhvitfeldt.github.io/emoji/). Haha, joke's on you, emo will never die. I know this because 'emo' was in my top 5 genres on Spotify Wrapped 2022, lololol. \n[^why]: Why `L`? [Shrug](https://stackoverflow.com/questions/22191324/clarification-of-l-in-r/22192378#22192378). Just take the L.",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}