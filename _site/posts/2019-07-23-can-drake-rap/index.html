<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Matt Dray">
<meta name="dcterms.date" content="2019-07-23">

<title>rostrum.blog - Can {drake} RAP?</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../images/logo-green-trans.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../images/logo-green-trans.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">rostrum.blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target=""><i class="bi bi-question-circle-fill" role="img">
</i> 
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../index.xml" rel="" target=""><i class="bi bi-rss-fill" role="img" aria-label="RSS feed">
</i> 
 <span class="menu-text">RSS</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/matt-dray/rostrum-blog-2" rel="" target=""><i class="bi bi-github" role="img" aria-label="GitHub source code">
</i> 
 <span class="menu-text">Source</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Can {drake} RAP?</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">drake</div>
                <div class="quarto-category">r</div>
                <div class="quarto-category">reproducibility</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p><a href="https://www.matt-dray.com">Matt Dray</a> </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">July 23, 2019</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="resources/hall-of-fame.jpeg" class="img-fluid figure-img" style="width:75.0%" alt="Six images: a male duck, Sir Francis Drake, Drake from the Drake &amp; Josh TV show, Nathan Drake from the Uncharted video games, Drake the musical artist, and the hex sticker for the drake package."></p>
<figcaption class="figure-caption">A drake, Sir Drake, Drake, Drake, Drake and {drake}.</figcaption>
</figure>
</div>
<section id="tldr" class="level2">
<h2 class="anchored" data-anchor-id="tldr">tl;dr</h2>
<p><a href="https://github.com/ropensci/drake">The {drake} package</a> records file interdependecies in your analysis. When files are changed, {drake} only re-runs the parts that need to be re-run. This saves time and reduces error.</p>
<p>This could be useful for <a href="https://analysisfunction.civilservice.gov.uk/support/reproducible-analytical-pipelines/">Reproducible Analytical Pipelines (RAP)</a>, an automated approach to producing UK government statistics that minimises error and speeds production.</p>
</section>
<section id="make-it-to-make-it" class="level2">
<h2 class="anchored" data-anchor-id="make-it-to-make-it">Make it to make it</h2>
<p>Analysis projects can become complicated as multiple inputs, script files and outputs build up.</p>
<p>Can you remember exactly which scripts need to be re-executed after a file changes? Or will you have to re-run the entire project from scratch? This is tedious and open to error if you miss something.</p>
<p>A <a href="https://en.wikipedia.org/wiki/Makefile">‘makefile’</a> can help you. In short, it’s a text file in which you write each step of your analysis in a recipe-like format. Dependencies between data, code and outputs are recorded.</p>
<p>A makefile ensures that only the affected file and those downstream from it will be re-executed. This saves compute time and means you don’t have to remember any dependencies yourself.</p>
</section>
<section id="drake-it-to-make-it" class="level2">
<h2 class="anchored" data-anchor-id="drake-it-to-make-it">{drake} it to make it</h2>
<p><a href="https://github.com/ropensci/drake">{drake}</a> is a package by <a href="https://wlandau.github.io/">Will Landau</a> that gives you makefiles with R syntax. It can be installed with <code>install.packages("drake)</code>.</p>
<p>This post contains a very simple example of {drake} in action, but there’s so much more to it. Fortunately, there’s lots of information:</p>
<ul>
<li><a href="https://ropenscilabs.github.io/drake-manual/">user manual</a></li>
<li><a href="https://ropensci.github.io/drake/">documentation</a></li>
<li><a href="https://github.com/krlmlr/drake-sib-zurich/blob/master/cheat-sheet.pdf">cheat sheet</a> by <a href="https://twitter.com/krlmlr">Kirill Müller</a></li>
<li><a href="https://aedobbyn.github.io/nyc-fires/index.html#1">‘drake for workflow happiness’</a> slides by <a href="https://dobb.ae/">Amanda Dobbyn</a> – which embraces the <a href="https://imgflip.com/memegenerator/91998305/Drake-Blank">Drake meme</a></li>
<li><a href="">Garrick Aden-Buie</a>’s introductory <a href="https://www.garrickadenbuie.com/talk/drake-intro-biodataclub/">talk</a>, including <a href="https://pkg.garrickadenbuie.com/drake-intro/#1">slides</a> and an <a href="https://login.rstudio.cloud/login?setup=1&amp;redirect=%2Foauth%2Fauthorize%3Fredirect_uri%3Dhttps%253A%252F%252Frstudio.cloud%252Flogin%26show_auth%3D0%26show_login%3D1%26response_type%3Dcode%26client_id%3Drstudio-cloud">RStudio Cloud Project</a></li>
</ul>
<p>Will Landau has also put together:</p>
<ul>
<li>the <a href="https://github.com/wlandau/learndrake">{learndrake} package</a> to… learn {drake}</li>
<li>a <a href="https://github.com/wlandau/drakeplanner">Shiny app for planning {drake} projects</a></li>
</ul>
</section>
<section id="demo-drake-lays-an-egg" class="level2">
<h2 class="anchored" data-anchor-id="demo-drake-lays-an-egg">Demo: {drake} lays an egg</h2>
<p>I think there’s potential for {drake} in <a href="https://ukgovdatascience.github.io/rap-website/">Reproducible Analytical Pipelines (RAP)</a>: a wholly code-based method for producing <a href="https://www.gov.uk/search/research-and-statistics">the UK government’s statistical reports</a> that improves reproducibility and automation, minimises errors and speeds-up production.</p>
<p>I’ve made a very simple {drake} demo for an imaginary RAP project. The demo recreates a very small part of a <a href="https://www.gov.uk/government/statistics/egg-statistics">statistical publication that tracks UK egg production</a><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>.</p>
<p><a href="https://github.com/matt-dray/drake-egg-rap">The demo code is on GitHub</a> and <a href="https://matt-dray.github.io/drake-egg-rap/egg-report.html">the demo report has also been published to the web</a>. Here’s a screenshot of the demo:</p>
<p><img src="resources/demo-report-page-short.png" class="img-fluid" style="width:100.0%" alt="A screenshot of the top section of the demo report, with the title 'UK egg statistics' and sections for 'background' and 'throughput'. The top of a chart tracking egg production is visible."></p>
<p>Big shout-out to <a href="https://www.twitter.com/nacnudus">Duncan Garmonsway</a> for <a href="https://github.com/ukgovdatascience/govdown/">the {govdown} package</a> that recreates the style of <a href="https://www.gov.uk/">GOV.UK</a>—the website of the UK government—in R Markdown.</p>
<p>The rest of this post explains the steps in the demo:</p>
<ol type="1">
<li><a href="#prep">Prepare R scripts</a></li>
<li><a href="#source">Load the scripts</a></li>
<li><a href="#viz">Visualise</a></li>
<li><a href="#make">Make the plan</a></li>
<li><a href="#change">Make a change</a></li>
</ol>
<section id="prep" class="level3">
<h3 class="anchored" data-anchor-id="prep">1. Prepare the scripts</h3>
<p>The repo has <a href="https://github.com/matt-dray/drake-egg-rap/tree/master/R">three simple scripts</a><a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> containing the code for the analysis:</p>
<ol type="1">
<li><a href="https://github.com/matt-dray/drake-egg-rap/blob/master/R/packages.R"><code>packages.R</code></a> loads the packages we need for our analysis with <code>library()</code></li>
<li><a href="https://github.com/matt-dray/drake-egg-rap/blob/master/R/functions.R"><code>functions.R</code></a> contains our own custom functions</li>
<li><a href="https://github.com/matt-dray/drake-egg-rap/blob/master/egg-report.Rmd">egg-report.Rmd</a> is the R Markdown report that will be output to HTML</li>
<li><a href="https://github.com/matt-dray/drake-egg-rap/blob/master/R/plan.R"><code>plan.R</code></a> is where the steps of the analysis are written</li>
</ol>
<p>The <code>plan.R</code> file needs a little more explanation. It contains the <code>drake_plan()</code> function, to which you pass each function required for the analysis. The functions can be in any order; {drake} works out the order from the dependencies between the scripts and outputs.</p>
<p>The demo plan is very simple, with only four functions wrapped inside <code>drake_plan()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>egg_plan <span class="ot">&lt;-</span> <span class="fu">drake_plan</span>(  <span class="co"># Create a drake_plan object called egg_plan</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 1. Read the dataset</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">raw_data =</span> <span class="fu">read_ods</span>(</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">path =</span> <span class="st">"data/eggs-packers-02may19a.ods"</span>,</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">sheet =</span> <span class="st">"Packers_Annual"</span>,</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">skip =</span> <span class="dv">8</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  ),  <span class="co"># separate each function with a comma</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2. Prepare the data with a bespoke function</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># from the functions.R file</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> <span class="fu">clean_data</span>(raw_data),</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 3. Generate a plot using a bespoke function</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># from the functions.R file</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">plot =</span> <span class="fu">create_plot</span>(data),</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 4. Finally, render the R Markdown report</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># drake::knitr_in() marks the .Rmd file as a dependency</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># drake::file_out() marks the .HTML as an output</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">report =</span> rmarkdown<span class="sc">::</span><span class="fu">render</span>(</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">knitr_in</span>(<span class="st">"egg-report.Rmd"</span>),</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">output_file =</span> <span class="fu">file_out</span>(<span class="st">"docs/egg-report.html"</span>),</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">quiet =</span> <span class="cn">TRUE</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="source" class="level3">
<h3 class="anchored" data-anchor-id="source">2. Load the scripts</h3>
<p>The data and code are all in place. How do we run the analysis?</p>
<p>Everything we need is stored in <a href="https://github.com/matt-dray/drake-egg-rap/blob/master/make.R">a small file called <code>make.R</code></a>. It starts by calling <code>source()</code> for each R script:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(packages.R)   <span class="co"># load the packages</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(functions.R)  <span class="co"># load the bespoke functions</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(plan.R)       <span class="co"># load the plan</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Sourcing the plan file results in the <code>drake_plan()</code> function being run. The output is a special <code>drake_plan</code> data frame object, which is called <code>egg_plan</code> in our demo. It has columns called ‘target’ and ‘command’ and a row for each function in our analysis:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>egg_plan</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code># A tibble: 4 x 2
  target   command                                                                           
  &lt;chr&gt;    &lt;expr&gt;                                                                            
1 raw_data read_ods(path = "data/eggs-packers-02may19a.ods", sheet = "Packers_Annual",      …
2 data     clean_data(raw_data)                                                             …
3 plot     create_plot(data)                                                                …
4 report   render(knitr_in("egg-report.Rmd"), output_file = file_out("docs/egg-report.html")…</code></pre>
<p>The plan object acts like an instruction booklet, which can be read ‘to each target (data and outputs), apply the named command (the functions of the analysis)’. So the contents of the <code>egg_plan</code> data frame can be read</p>
<ol type="1">
<li>Read the raw data (the target) with <code>readODS::read_ods()</code> (the command)</li>
<li>Clean the data (target) with the custom <code>clean_data()</code> function (command)</li>
<li>Plot the data (target) with the custom <code>plot_data()</code> function (command)</li>
<li>Create an R Markdown report (target) with <code>rmarkdown::render()</code> (command)</li>
</ol>
<p>So we have the instructions stored in an object. Now we can (optionally) produce a dependency graph of these targets to get an idea of the relationships between the elements of the analysis.</p>
</section>
<section id="viz" class="level3">
<h3 class="anchored" data-anchor-id="viz">3. Visualise</h3>
<p>The first step to create the visual is to extract information about the <code>egg_plan</code> in a configuration (‘config’) list object. One element of the config is, for example, an <a href="https://igraph.org/">igraph</a> object that helps construct graphs from your workflow. The function to get this is <code>drake_config()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>egg_config <span class="ot">&lt;-</span> <span class="fu">drake_config</span>(egg_plan)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A number of {drake} functions can take the config object and do something with the information inside it. In our case, we’re going to pass the config to <code>vis_drake_graph()</code>, which builds an interactive dependency graph using {visNetwork}.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">vis_drake_graph</span>(egg_config)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This generates an interactive output <a href="https://matt-dray.github.io/drake-egg-rap/dependency-graph.html">(see it here)</a>. Here’s a screenshot:</p>
<p><img src="resources/dependency-static.png" class="img-fluid" style="width:100.0%" alt="A screenshot of the interactive dependency graph showing the relationship between objects, files and functions in the analysis represented by different shapes and colours."></p>
<p>The visualisation is shape-coded by target type (e.g.&nbsp;functions are triangles) and colour-coded to show whether everything is up-to-date (e.g.&nbsp;green if it is). Arrows show the file dependencies (e.g.&nbsp;both the <code>clean_data</code> function and <code>raw_data</code> file come together to produce the <code>data</code> object).</p>
</section>
<section id="make" class="level3">
<h3 class="anchored" data-anchor-id="make">4. Make the plan</h3>
<p>Having satisfied yourself that the plan looks correct, running the plan is as simple as:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span>(egg_plan)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This executes all the instructions laid out in the <code>egg_plan</code> object and our HTML report pops out at the end.</p>
<p>Of course, re-running the plan straight away again does… nothing. No code needs to be re-executed if nothing’s changed!</p>
<section id="side-note-the-cache" class="level4">
<h4 class="anchored" data-anchor-id="side-note-the-cache">Side note: the cache</h4>
<p>Turns out that {drake} is storing all the intermediate objects that were created when making your plan. They’re cached in a hidden <code>.drake/</code> folder so they can be retrieved without needing to be re-created.</p>
<p>This means you can use the <code>.drake/</code> cache to supply objects to an R Markdown file, which is achieved by either <code>readd()</code>ing or <code>loadd()</code>ing them. For example, <a href="https://github.com/matt-dray/drake-egg-rap/blob/master/egg-report.Rmd">the plot in the demo R Markdown file was called with <code>loadd(plot)</code></a>.</p>
</section>
</section>
<section id="change" class="level3">
<h3 class="anchored" data-anchor-id="change">5. Make a change</h3>
<p>If anything changes in our data or code then the downstream targets will be out of sync. Let’s pretend we’ve changed a line of code in the <code>create_plot()</code> function, which could be something is superficial as altering its title. What do you think will happen?</p>
<p>Well, {drake} knows there’s been a change. You can check this by running <code>source("R/functions.R")</code> in <code>make.R</code> again and then run <code>outdated(egg_config)</code>. This prints the name of the altered file plus the other files impacted by it.</p>
<p>We can see this by recreating the dependency graph <a href="https://matt-dray.github.io/drake-egg-rap/dependency-graph-outdated.html">(see it here)</a>: the <code>plot</code> target is outdated, as are the targets downstream that depend on it (<code>report</code> and the <code>egg-report.html</code> file). This is indicated by them being coloured black. Here’s a static version:</p>
<p><img src="resources/dependency-outdated-static.png" class="img-fluid" style="width:100.0%" alt="A screenshot of the interactive dependency graph showing that outdated items (the plot and report) are now coloured black. The other items aren't black because they're not impacted by the change to the plot function."></p>
<p>So now we can see the real power of {drake}, as re-running the plan now will regenerate only the outdated files.</p>
</section>
</section>
<section id="in-review" class="level2">
<h2 class="anchored" data-anchor-id="in-review">In review</h2>
<p>At its simplest, you create a <code>plan.R</code> and you <code>make()</code> it.</p>
<p>Hopefully you’ve seen how {drake}:</p>
<ul>
<li>remembers the dependencies between the files of your analysis</li>
<li>only re-runs what needs to be re-run</li>
</ul>
<p>I think this alone can help build the reliability and trustworthiness of published statistical reports.</p>
<p>Of course, this is a very simple use of {drake} and should act as a starting point. <a href="https://ropenscilabs.github.io/drake-manual/">{drake} does a lot more</a>, like high-performance computing and memory management, that may also come in useful for RAP.</p>
</section>



<div id="quarto-appendix" class="default"><section id="environment" class="level2 appendix"><h2 class="anchored quarto-appendix-heading">Environment</h2><div class="quarto-appendix-contents">

<details>
<summary>
Session info
</summary>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Last rendered: 2023-07-25 20:33:27 BST</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.3.1 (2023-06-16)
Platform: aarch64-apple-darwin20 (64-bit)
Running under: macOS Ventura 13.2.1

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: Europe/London
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

loaded via a namespace (and not attached):
 [1] htmlwidgets_1.6.2 compiler_4.3.1    fastmap_1.1.1     cli_3.6.1        
 [5] tools_4.3.1       htmltools_0.5.5   rstudioapi_0.15.0 yaml_2.3.7       
 [9] rmarkdown_2.23    knitr_1.43.1      jsonlite_1.8.7    xfun_0.39        
[13] digest_0.6.33     rlang_1.1.1       evaluate_0.21    </code></pre>
</div>
</div>
</details>


</div></section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>This publication could be a good candidate for RAP: content remains fairly similar between quarterly releases and it’s required to meet high standards of quality because it’s badged as <a href="https://www.statisticsauthority.gov.uk/osr/list-of-national-statistics/">National Statistics</a>.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>You don’t have to restrict yourself to this configuration of scripts, but it can make it easier to handle your project.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div id="quarto-reuse" class="quarto-appendix-contents"><div>CC BY-NC-SA 4.0</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>