<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Matt Dray">
<meta name="dcterms.date" content="2020-05-02">

<title>rostrum.blog - AGÜEROOOOO with {ggsoccer} and {gganimate}</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../images/logo-green-trans.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../images/logo-green-trans.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">rostrum.blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target=""><i class="bi bi-question-circle-fill" role="img">
</i> 
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../index.xml" rel="" target=""><i class="bi bi-rss-fill" role="img" aria-label="RSS feed">
</i> 
 <span class="menu-text">RSS</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/matt-dray/rostrum-blog-2" rel="" target=""><i class="bi bi-github" role="img" aria-label="GitHub source code">
</i> 
 <span class="menu-text">Source</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">AGÜEROOOOO with {ggsoccer} and {gganimate}</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">dataviz</div>
                <div class="quarto-category">gganimate</div>
                <div class="quarto-category">ggsoccer</div>
                <div class="quarto-category">ggplot2</div>
                <div class="quarto-category">r</div>
                <div class="quarto-category">sport</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p><a href="https://www.matt-dray.com">Matt Dray</a> </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">May 2, 2020</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<div class="cell">
<div class="cell-output-display">
<p><img src="index_files/figure-html/full-code-1.gif" class="img-fluid"></p>
</div>
</div>
<section id="tldr" class="level2">
<h2 class="anchored" data-anchor-id="tldr">tl;dr</h2>
<p>I used R to animate the goal that won Manchester City <a href="https://en.wikipedia.org/wiki/2011%E2%80%9312_Premier_League">the 2011/12 Premier League title</a> in <a href="https://youtu.be/4XSo5Z0hEAs">breathtaking fashion</a>.</p>
<p><a href="https://ryo-n7.github.io/2018-06-29-visualize-worldcup/">Inspired by Ryo Nakagawara</a>, who makes awesome R-related soccer content that you can find on <a href="https://ryo-n7.github.io/">his site</a> and <a href="https://twitter.com/R_by_Ryo">on Twitter</a>.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
</section>
<section id="the-problem" class="level2">
<h2 class="anchored" data-anchor-id="the-problem">The ‘problem’</h2>
<p>Soccer has run dry.</p>
<p>Leagues have <a href="https://www.bbc.co.uk/sport/football/52418048">been cancelled</a> or <a href="https://www.bbc.co.uk/sport/football/52484926">decided on a contentious points-per-game basis</a> given that there’s no precedent. The fate of the 2019/20 English Premier League season is still unknown.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<p>I figured it would be a good time to revisit a season that finished in the most emphatic fashion; one that was decided in the final minute of the final game.</p>
<section id="the-game" class="level3">
<h3 class="anchored" data-anchor-id="the-game">The game</h3>
<p>City and United were level on points at the top of the Premier League as they entered their final matches of the 2011/12 season. Only goal difference separated them.</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: right;">Pos</th>
<th style="text-align: left;">Team</th>
<th style="text-align: right;">Played</th>
<th style="text-align: right;">GD</th>
<th style="text-align: right;">Points</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: left;">Manchester City</td>
<td style="text-align: right;">37</td>
<td style="text-align: right;">+63</td>
<td style="text-align: right;">86</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: left;">Manchester United</td>
<td style="text-align: right;">37</td>
<td style="text-align: right;">+55</td>
<td style="text-align: right;">86</td>
</tr>
</tbody>
</table>
<p>As the game entered the closing stages, a dominant City somehow found themselves 2-1 down to a lacklustre Queens Park Rangers side.</p>
<p>After sustained pressure, <a href="https://youtu.be/4XSo5Z0hEAs?t=1027">Edin Dzeko scored a towering header from a corner</a> after 92 minutes. The game was level at 2-2, but it wouldn’t be enough to win the title; one more goal was needed.</p>
<p>Meanwhile, Manchester United had won their concurrent game at Sunderland and had every right to think the title was theirs.</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: right;">Pos</th>
<th style="text-align: left;">Team</th>
<th style="text-align: right;">Played</th>
<th style="text-align: right;">GD</th>
<th style="text-align: right;">Points</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: left;">Manchester United</td>
<td style="text-align: right;">38</td>
<td style="text-align: right;">+56</td>
<td style="text-align: right;">89</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: left;">Manchester City</td>
<td style="text-align: right;">38</td>
<td style="text-align: right;">+63</td>
<td style="text-align: right;">87</td>
</tr>
</tbody>
</table>
<p>But <a href="https://youtu.be/4XSo5Z0hEAs?t=1148">after 93 minutes</a>, City’s Nigel De Jong burst into QPR’s half. Sergio stepped forward, received the ball and beat his man. He passed to Mario Balotelli and continued his run into the box. Super Mario slid to the ground and pushed the ball into Agüero’s path.</p>
<p>The rest is history: Sergio received the ball, beat a slide tackle and smashed the ball into the goal. Cue commentator Martin Tyler screaming <a href="https://youtu.be/oepskn9gjDI?t=1130">‘AGÜEROOOOO!’</a>.</p>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: right;">Pos</th>
<th style="text-align: left;">Team</th>
<th style="text-align: right;">Played</th>
<th style="text-align: right;">GD</th>
<th style="text-align: right;">Points</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: left;">Manchester City</td>
<td style="text-align: right;">37</td>
<td style="text-align: right;">+64</td>
<td style="text-align: right;">89</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: left;">Manchester United</td>
<td style="text-align: right;">37</td>
<td style="text-align: right;">+56</td>
<td style="text-align: right;">89</td>
</tr>
</tbody>
</table>
<p>City had done the impossible to win their first Premier League trophy and first top-flight title in 44 years.</p>
</section>
</section>
<section id="reliving-the-moment" class="level2">
<h2 class="anchored" data-anchor-id="reliving-the-moment">Reliving the moment</h2>
<p>So the sensible thing to do is to use R to make a gif of the player movements in the build-up to the goal.</p>
<p>You may have seen something like this before from <a href="https://ryo-n7.github.io/2018-06-29-visualize-worldcup/">Ryo Nakagawara</a> and others. I took a slightly different approach to Ryo, but the result is basically the same.</p>
<p>You need three packages:<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></p>
<ul>
<li><a href="https://ggplot2.tidyverse.org/">{ggplot2}</a>, created by <a href="http://hadley.nz/">Hadley Wickham</a>, to provide the plotting framework</li>
<li><a href="https://torvaney.github.io/ggsoccer/">{ggsoccer}</a>, by <a href="http://www.statsandsnakeoil.com/">Ben Torvaney</a>, for the grid and pitch theme</li>
<li><a href="https://gganimate.com/">{gganimate}</a>, by <a href="https://www.data-imaginist.com/">Thomas Lin Pedersen</a>, for animating each step and interpolating between them</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load packages</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2) <span class="co"># Create Elegant Data Visualisations Using the Grammar of Graphics</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggsoccer) <span class="co"># Plot Soccer Event Data</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gganimate) <span class="co"># A Grammar of Animated Graphics</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tibble) <span class="co"># Simple Data Frames</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I also used {tibble} to create data frames with <code>tribble()</code>, but this isn’t a requirement.</p>
</section>
<section id="set-coordinates" class="level2">
<h2 class="anchored" data-anchor-id="set-coordinates">Set coordinates</h2>
<p>You need to start with coordinate data for the players and ball. {ggsoccer} defaults to a 100- by 100-unit pitch on which to plot these data. But where do you get it from?</p>
<p>You could use <a href="https://www.optasports.com/">Opta</a>’s premium service for accessing player-tracking data. My approach was more… artisanal. I just watched some grainy YouTube videos and roughly guessed where the players were.</p>
<p>A really nice interactive tool that makes the process easier is the <a href="https://torvaney.github.io/projects/tracker">soccer event logger</a> by Ben Torvaney, creator of {ggsoccer}.</p>
<section id="players" class="level3">
<h3 class="anchored" data-anchor-id="players">Players</h3>
<p>The first data frame contains each player’s coordinates, with a row for each frame of the final animation. I added the player name so it could be used as a label.</p>
<p>I chose to focus on the three active players in the build-up to the goal. This made the final graphic clearer, yes, but more importantly it meant I had fewer data points to input.</p>
<p>I created the data frame using <code>tribble()</code> from the {tibble} package because I found it easier to input the data in a row-wise fashion. It’s also easy to write a comment per line to explain what’s happening.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Player position data</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>players <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>frame, <span class="sc">~</span>name, <span class="sc">~</span>x, <span class="sc">~</span>y,  <span class="co"># column names</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span>, <span class="st">"De Jong"</span>, <span class="dv">50</span>, <span class="dv">50</span>,  <span class="co"># advances from own half</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="dv">2</span>, <span class="st">"De Jong"</span>, <span class="dv">56</span>, <span class="dv">50</span>,  <span class="co"># advances into oppo half</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="dv">3</span>, <span class="st">"De Jong"</span>, <span class="dv">64</span>, <span class="dv">50</span>,  <span class="co"># passes to Agüero</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="dv">4</span>, <span class="st">"De Jong"</span>, <span class="dv">64</span>, <span class="dv">50</span>,  <span class="co"># off the ball</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="dv">5</span>, <span class="st">"De Jong"</span>, <span class="dv">64</span>, <span class="dv">50</span>,  <span class="co"># off the ball</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="dv">6</span>, <span class="st">"De Jong"</span>, <span class="dv">64</span>, <span class="dv">50</span>,  <span class="co"># off the ball</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="dv">7</span>, <span class="st">"De Jong"</span>, <span class="dv">64</span>, <span class="dv">50</span>,  <span class="co"># off the ball</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  <span class="dv">8</span>, <span class="st">"De Jong"</span>, <span class="dv">64</span>, <span class="dv">50</span>,  <span class="co"># off the ball</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span>, <span class="st">"Agüero"</span>, <span class="dv">85</span>, <span class="dv">70</span>, <span class="co"># diagonal run to meet ball from De Jong</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  <span class="dv">2</span>, <span class="st">"Agüero"</span>, <span class="dv">80</span>, <span class="dv">65</span>, <span class="co"># diagonal run to meet ball from De Jong</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  <span class="dv">3</span>, <span class="st">"Agüero"</span>, <span class="dv">75</span>, <span class="dv">60</span>, <span class="co"># receives pass from De Jong</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  <span class="dv">4</span>, <span class="st">"Agüero"</span>, <span class="dv">76</span>, <span class="dv">63</span>, <span class="co"># beats defender, passes to Balotelli</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  <span class="dv">5</span>, <span class="st">"Agüero"</span>, <span class="dv">80</span>, <span class="dv">50</span>, <span class="co"># advances to edge of box</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  <span class="dv">6</span>, <span class="st">"Agüero"</span>, <span class="dv">87</span>, <span class="dv">38</span>, <span class="co"># receives pass from Balotelli</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  <span class="dv">7</span>, <span class="st">"Agüero"</span>, <span class="dv">93</span>, <span class="dv">36</span>, <span class="co"># shot</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>  <span class="dv">8</span>, <span class="st">"Agüero"</span>, <span class="dv">94</span>, <span class="dv">33</span>, <span class="co"># goal</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span>, <span class="st">"Balotelli"</span>, <span class="dv">83</span>, <span class="dv">61</span>, <span class="co"># waiting on edge of box</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>  <span class="dv">2</span>, <span class="st">"Balotelli"</span>, <span class="dv">83</span>, <span class="dv">61</span>, <span class="co"># waiting on edge of box</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>  <span class="dv">3</span>, <span class="st">"Balotelli"</span>, <span class="dv">83</span>, <span class="dv">61</span>, <span class="co"># waiting on edge of box</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>  <span class="dv">4</span>, <span class="st">"Balotelli"</span>, <span class="dv">83</span>, <span class="dv">57</span>, <span class="co"># waiting on edge of box</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>  <span class="dv">5</span>, <span class="st">"Balotelli"</span>, <span class="dv">83</span>, <span class="dv">55</span>, <span class="co"># recieves pass from Agüero</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>  <span class="dv">6</span>, <span class="st">"Balotelli"</span>, <span class="dv">83</span>, <span class="dv">55</span>, <span class="co"># passes to Agüero</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>  <span class="dv">7</span>, <span class="st">"Balotelli"</span>, <span class="dv">83</span>, <span class="dv">54</span>, <span class="co"># off the ball</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>  <span class="dv">8</span>, <span class="st">"Balotelli"</span>, <span class="dv">83</span>, <span class="dv">54</span>, <span class="co"># off the ball</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>So each player has coordinates for each time step.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Preview the data frame</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(players[<span class="fu">order</span>(players<span class="sc">$</span>frame), ])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
  frame name          x     y
  &lt;dbl&gt; &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt;
1     1 De Jong      50    50
2     1 Agüero       85    70
3     1 Balotelli    83    61
4     2 De Jong      56    50
5     2 Agüero       80    65
6     2 Balotelli    83    61</code></pre>
</div>
</div>
</section>
<section id="ball" class="level3">
<h3 class="anchored" data-anchor-id="ball">Ball</h3>
<p>I put the coordinate data for the ball in a separate data frame. This made it easier to specify and modify separately the ball and player data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ball position data</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>ball <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>frame, <span class="sc">~</span>x, <span class="sc">~</span>y,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span>,  <span class="dv">51</span>, <span class="dv">50</span>,  <span class="co"># De Jong possession</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="dv">2</span>,  <span class="dv">57</span>, <span class="dv">50</span>,  <span class="co"># De Jong pass</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="dv">3</span>,  <span class="dv">74</span>, <span class="dv">60</span>,  <span class="co"># receievd by Agüero</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="dv">4</span>,  <span class="dv">77</span>, <span class="dv">63</span>,  <span class="co"># Agüero pass</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="dv">5</span>,  <span class="dv">83</span>, <span class="dv">54</span>,  <span class="co"># received by Balotelli</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  <span class="dv">6</span>,  <span class="dv">88</span>, <span class="dv">38</span>,  <span class="co"># received by Agüero</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  <span class="dv">7</span>,  <span class="dv">94</span>, <span class="dv">36</span>,  <span class="co"># Agüero shot</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  <span class="dv">8</span>, <span class="dv">100</span>, <span class="dv">46</span>   <span class="co"># goal </span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="graphics" class="level2">
<h2 class="anchored" data-anchor-id="graphics">Graphics</h2>
<p>The first step in producing the animation is to create a single plot object that contains all the points. {gganimate} takes the object and animates it frame by frame, interpolating the data points between each time step.</p>
<section id="static-plot" class="level3">
<h3 class="anchored" data-anchor-id="static-plot">Static plot</h3>
<p>To produce the plot object:</p>
<ol type="1">
<li>Plot the pitch area</li>
<li>Add ball data first so the points will appear ‘under’ the player points</li>
<li>Add player points and labels</li>
<li>Add a title</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot all the data</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>plot <span class="ot">&lt;-</span> </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span>       <span class="co"># blank canvas</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate_pitch</span>(  <span class="co"># plot 100 * 100 unit pitch </span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> <span class="st">"white"</span>, <span class="at">fill =</span> <span class="st">"#7fc47f"</span>, <span class="at">limits =</span> <span class="cn">FALSE</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_pitch</span>() <span class="sc">+</span>  <span class="co"># theme removes plotting elements</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>(      <span class="co"># rotate and crop pitch</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">49</span>, <span class="dv">101</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">12</span>, <span class="dv">112</span>)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(      <span class="co"># add ball data</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> ball,</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> <span class="dv">100</span> <span class="sc">-</span> y),</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">pch =</span> <span class="dv">21</span>, <span class="at">size =</span> <span class="dv">2</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(      <span class="co"># add player data</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> players, </span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> <span class="dv">100</span> <span class="sc">-</span> y), </span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">fill =</span> <span class="st">"skyblue"</span>, <span class="at">pch =</span> <span class="dv">21</span>, <span class="at">size =</span> <span class="dv">4</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(       <span class="co"># add player labels</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> players, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> <span class="dv">100</span> <span class="sc">-</span> y, <span class="at">label =</span> name),</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">hjust =</span> <span class="sc">-</span><span class="fl">0.2</span>, <span class="at">nudge_x =</span> <span class="dv">1</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(         <span class="co"># add title</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">label =</span> <span class="st">"MCY [3]-2 QPR"</span>,</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"93:20 GOAL Sergio Agüero"</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I’ve chosen to rotate the plot and crop it because we only need to see one half of the pitch. Note that this means the y-aesthetic for the points is set to <code>100 - y</code>.</p>
<p>The output <code>plot</code> object is composed of all the frames that we set out in the <code>player</code> and <code>ball</code> data sets. You wouldn’t plot this object as-is, but here’s what it looks like:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/see-plot-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>{gganimate} will take each time-step—specified by the <code>frame</code> variable—to render the animation. Here’s each of those frames from the <code>player</code> data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>plot <span class="sc">+</span> <span class="fu">facet_wrap</span>(<span class="sc">~</span> frame) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="cn">NULL</span>, <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/facet-wrap-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="animated-plots" class="level3">
<h3 class="anchored" data-anchor-id="animated-plots">Animated plots</h3>
<p>{gganimate} turns the static plot into an animation in one step.</p>
<p>The <code>transition_states()</code> function builds on top of the <code>plot</code> object. I specified the time-step variable; the durations for showing the frame and the interpolated frames between; and whether or not the animation should loop back to the start.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Animate the plot</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>animation <span class="ot">&lt;-</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  plot <span class="sc">+</span>                   <span class="co"># the plot object</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transition_states</span>(</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    frame,                 <span class="co"># time-step variable</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">state_length =</span> <span class="fl">0.01</span>,   <span class="co"># duration of frame</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">transition_length =</span> <span class="dv">1</span>, <span class="co"># duration between frames</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">wrap =</span> <span class="cn">FALSE</span>           <span class="co"># restart, don't loop</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You can use the <code>animate()</code> function to render it.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">animate</span>(animation)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/see-animation-1.gif" class="img-fluid"></p>
</div>
</div>
<p>AGÜEROOOOO!</p>
<p>You can save the result as a gif with <code>anim_save()</code>, which works like <code>ggsave()</code> from {ggplot2}: the default is to save the latest animation to your working directory.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">anim_save</span>(<span class="st">"9320.gif"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Luckily the gif keeps looping so you can keep watching until a decision is made on how the current Premier League season will end.</p>
</section>
</section>



<div id="quarto-appendix" class="default"><section id="environment" class="level2 appendix"><h2 class="anchored quarto-appendix-heading">Environment</h2><div class="quarto-appendix-contents">

<details>
<summary>
Session info
</summary>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Last rendered: 2023-07-22 11:39:13 BST</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.3.1 (2023-06-16)
Platform: aarch64-apple-darwin20 (64-bit)
Running under: macOS Ventura 13.2.1

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: Europe/London
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
[1] tibble_3.2.1    gganimate_1.0.8 ggsoccer_0.1.7  ggplot2_3.4.2  

loaded via a namespace (and not attached):
 [1] gtable_0.3.3      jsonlite_1.8.7    dplyr_1.1.2       compiler_4.3.1   
 [5] crayon_1.5.2      Rcpp_1.0.11       tidyselect_1.2.0  magick_2.7.4     
 [9] progress_1.2.2    scales_1.2.1      yaml_2.3.7        fastmap_1.1.1    
[13] R6_2.5.1          labeling_0.4.2    generics_0.1.3    knitr_1.43.1     
[17] htmlwidgets_1.6.2 munsell_0.5.0     pillar_1.9.0      rlang_1.1.1      
[21] utf8_1.2.3        stringi_1.7.12    xfun_0.39         cli_3.6.1        
[25] withr_2.5.0       magrittr_2.0.3    tweenr_2.0.2      digest_0.6.33    
[29] grid_4.3.1        rstudioapi_0.15.0 hms_1.1.3         lifecycle_1.0.3  
[33] prettyunits_1.1.1 vctrs_0.6.3       evaluate_0.21     glue_1.6.2       
[37] farver_2.1.1      fansi_1.0.4       colorspace_2.1-0  rmarkdown_2.23   
[41] tools_4.3.1       pkgconfig_2.0.3   htmltools_0.5.5  </code></pre>
</div>
</div>
</details>


</div></section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Also a fellow builder of <a href="https://twitter.com/R_by_Ryo/status/1134789739301621760?s=20">{brickr} soccer players</a>.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>But do check out posts by <a href="http://www.statsandsnakeoil.com/2019/01/01/predicting-the-premier-league-with-dixon-coles/">Ben Torvaney</a> and <a href="https://www.robert-hickman.eu/post/dixon_coles_2/">Robert Hickman</a> on predicting Premier League outcomes with R.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>An aside: I used <a href="https://luisdva.github.io/rstats/annotater/">the {annotater} RStudio Addin</a> by <a href="https://luisdva.github.io/">Luis D Verde</a> to annotate these library calls.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div id="quarto-reuse" class="quarto-appendix-contents"><div>CC BY-NC-SA 4.0</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>