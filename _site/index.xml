<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>rostrum.blog</title>
<link>https://whimsical-wisp-30974e.netlify.app/index.html</link>
<atom:link href="https://whimsical-wisp-30974e.netlify.app/index.xml" rel="self" type="application/rss+xml"/>
<description>Japes with R</description>
<generator>quarto-1.4.176</generator>
<lastBuildDate>Mon, 31 Jul 2023 23:00:00 GMT</lastBuildDate>
<item>
  <title>One weird trick to {monetize} your R package</title>
  <dc:creator>Matt Dray</dc:creator>
  <link>https://whimsical-wisp-30974e.netlify.app/posts/2023-08-01-monetize/index.html</link>
  <description><![CDATA[ 




<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><img src="https://whimsical-wisp-30974e.netlify.app/posts/2023-08-01-monetize/resources/monetize-hats.png" class="img-fluid figure-img" style="width:40.0%" alt="Three green dollar symbols in Comic Sans, each with an emoji hat on."></p>
</figure>
</div>
<section id="tldr" class="level2">
<h2 class="anchored" data-anchor-id="tldr">tl;dr</h2>
<p><a href="https://github.com/matt-dray/monetize">The {monetize} R package</a> gives you inspiration for monetising your R package. Developers rise up!</p>
</section>
<section id="free-as-in-free" class="level2">
<h2 class="anchored" data-anchor-id="free-as-in-free">Free as in free</h2>
<p>There‚Äôs one good reason why SAS, SPSS and Stata<sup>1</sup> are such successful and beloved statistical tools: money.</p>
<p>For some reason, R remains free and open source. But what if <a href="https://en.wikipedia.org/wiki/R_(programming_language)">Ihaka &amp; Gentleman</a> originally wanted users to be charged a literal (New Zealand) dollar<sup>2</sup> every time they use the <code>$</code> symbol to access an element from an object? I‚Äôm just asking the question!</p>
<p>Us package developers should seize the initiative and harvest the sweet, sweet bounty of our labour. But how? I will tell you the secret!</p>
</section>
<section id="free-as-in-not-quite" class="level2">
<h2 class="anchored" data-anchor-id="free-as-in-not-quite">Free as in not quite</h2>
<p>Introducing the {monetize} R package! It will provide the inspiration you seek. Serious entrepreneurs can <a href="https://github.com/matt-dray/monetize">install from GitHub</a><sup>3</sup>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install.packages</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"remotes"</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># if not yet installed</span></span>
<span id="cb1-2">remotes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install_github</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"matt-dray/monetize"</span>)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(monetize)</span></code></pre></div>
</div>
<pre><code>Welcome to the monetize(TM) package FREE TRIAL version!
Try our EXCLUSIVE add_one() function!
Try watch_ad() to gain MEGA COINS and increase your MEMBER LEVEL for REWARDS!
And now a quick message from our sponsor:
  üßÉ IMBIBE ACME(TM)-BRAND FRUIT PULP (7% FEWER INSECT COMPONENTS)! ü™≥</code></pre>
<p>The package contains the exclusive <code>add_one()</code> function, which surprisingly doesn‚Äôt come pre-installed with base R. A gap in the market!</p>
<p>Users should speculate to accumulate, so there‚Äôs a small cost to use the function. In {monetize}, each use of a function costs 1 MEGA COIN.</p>
<p>Because I am so kind, I have chosen for users to receive a 30-day FREE TRIAL of the package and to receive 3 MEGA COINS as an exclusive NEW-MEMBER PERK.</p>
<p>One use of the function costs the low, low price of 1 MEGA COIN. Merely a small payment, or ‚Äòmicro transaction‚Äô, if you will.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_one</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
</div>
<pre><code>üìÖ You have 30 days left of your FREE TRIAL!
üèÖ Your MEMBER LEVEL is 1! Try watch_ad()!
üí∞ Your MEGA COIN balance is now 2! Try watch_ad()!
[1] 2</code></pre>
<p>Along with the result, the function helpfully prints the number of days left in your FREE TRIAL, your MEMBER LEVEL and the number of MEGA COINS you have left.</p>
<p>What‚Äôs a MEMBER LEVEL? Well, at MEMBER LEVEL 1, the function can‚Äôt guarantee a correct result. 20% of the time there‚Äôll be an off-by-one error. But R users index from 1 anyway, so they‚Äôll be used to that.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_one</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
</div>
<pre><code>üìÖ You have 30 days left of your FREE TRIAL!
üèÖ Your MEMBER LEVEL is 1! Try watch_ad()!
üí∞ Your MEGA COIN balance is now 1! Try watch_ad()!
[1] 3</code></pre>
<p>How can you get the correct result 100% of the time? That‚Äôs an exclusive for MEMBER LEVEL 2. How do you reach MEMBER LEVEL 2? What happens if you run out of MEGA COINS?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_one</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
</div>
<pre><code>üìÖ You have 30 days left of your FREE TRIAL!
üèÖ Your MEMBER LEVEL is 1! Try watch_ad()!
Error: üò≠ You'll need more MEGA COINS to re-use this function! Try watch_ad()!</code></pre>
<p>Answer: simply watch some ads! I‚Äôve managed to get an ad deal with the famous <a href="https://en.wikipedia.org/wiki/Acme_Corporation">Acme(TM) Corporation</a>. Maybe you could get a sponsorship deal from a third-party whose interests align with your users‚Äô interests; maybe SAS, SPSS or Stata would be interested?</p>
<p>Anyway, the user can just <code>watch_ad()</code> in exchange for MEGA COINS: I‚Äôve allowed the user to employ their FREE WILL to watch a <code>"short"</code> ad for 1 MEGA COIN or a <code>"long"</code> ad for 3 MEGA COINS.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">watch_ad</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"short"</span>)</span></code></pre></div>
</div>
<pre><code>üå≠ CONSUME ACME(TM)-BRAND RECONSTITUTED MEAT-LIKE CYLINDERS! üêï
üå≠ CONSUME ACME(TM)-BRAND RECONSTITUTED MEAT-LIKE CYLINDERS! üêï
üå≠ CONSUME ACME(TM)-BRAND RECONSTITUTED MEAT-LIKE CYLINDERS! üêï
üå≠ CONSUME ACME(TM)-BRAND RECONSTITUTED MEAT-LIKE CYLINDERS! üêï
üå≠ CONSUME ACME(TM)-BRAND RECONSTITUTED MEAT-LIKE CYLINDERS! üêï
Congratulations! Your new MEGA COIN total is 1!</code></pre>
<p>Reach MEMBER LEVEL 2 after gaining 10 all-time MEGA COINS and MEMBER LEVEL 3 after 20 MEGA COINS.</p>
<p>What‚Äôs the exclusive MEMBER LEVEL 3? Well, you get the perk of an actually-correct answer like in MEMBER LEVEL 2‚Ä¶ plus the value gets a randomised FREE HAT!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_one</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
</div>
<pre><code>üìÖ You have 30 days left of your FREE TRIAL!
üèÖ Your MEMBER LEVEL is 3! Try watch_ad()!
üí∞ Your MEGA COIN balance is now 19! Try watch_ad()!
üé© 
 2 </code></pre>
<p>What a tease! Oh, and the stats are persistent, so your users can‚Äôt refresh their session and wipe the slate clean. Watch the cash roll in!</p>
</section>
<section id="free-as-in-absolutely-not" class="level2">
<h2 class="anchored" data-anchor-id="free-as-in-absolutely-not">Free as in absolutely not</h2>
<p>I hope this has been an inspirational eye-opener for you and that one day you can be as rich as me. Oh, you didn‚Äôt know I was rich? How else could I afford to keep this absolute juggernaut of a blog going?</p>
<p>To demonstrate how little I personally need them, here are some more ideas to maximise your financial rewards via R. You could try:</p>
<ul>
<li>releasing version updates as paid add-ons, like <a href="https://en.wikipedia.org/wiki/Downloadable_content">videogame DLC</a> (you could also make them take several hours to download, like videogame DLC, which would definitely heighten the tension)</li>
<li><a href="https://en.wikipedia.org/wiki/Loot_box#Criticism">loot boxes</a> to allow users to gamble‚ÄîI mean, test their precognitive skills‚Äîfor new functionality (<code>add_two()</code> could be a common drop, while <code>multiply_by_two()</code> is ultra rare)</li>
<li>using certified financial guru <a href="https://github.com/nacnudus/ggbillboard">Duncan Garmonsway‚Äôs {ggbillboard} package</a> (‚Äòuse vacant ggplot2 facets for advertising‚Äô)</li>
</ul>
<p>You are welcome. Don‚Äôt read the small print for nerds.</p>
<details>
<summary>
Small print for nerds.
</summary>
It‚Äôs a simple trick: up-to-date stats are stored on the user‚Äôs computer in the directory resolved by <code>tools::R_user_dir("monetize", "data")</code><sup>4</sup> and are updated each time you use the functions in the package. Easy to circumvent‚Ä¶ if you know how.
</details>
</section>



<div id="quarto-appendix" class="default"><section id="environment" class="level2 appendix"><h2 class="anchored quarto-appendix-heading">Environment</h2><div class="quarto-appendix-contents">

<details>
<summary>
Session info
</summary>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Last rendered: 2023-08-01 11:37:35 BST</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.3.1 (2023-06-16)
Platform: aarch64-apple-darwin20 (64-bit)
Running under: macOS Ventura 13.2.1

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: Europe/London
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
[1] monetize_0.0.0.9000

loaded via a namespace (and not attached):
 [1] htmlwidgets_1.6.2 compiler_4.3.1    fastmap_1.1.1     cli_3.6.1        
 [5] tools_4.3.1       htmltools_0.5.5   rstudioapi_0.15.0 yaml_2.3.7       
 [9] rmarkdown_2.23    knitr_1.43.1      jsonlite_1.8.7    xfun_0.39        
[13] digest_0.6.33     rlang_1.1.1       evaluate_0.21    </code></pre>
</div>
</div>
</details>


</div></section><aside id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Curious why they all start with ‚ÄòS‚Äô? It‚Äôs in deference to ‚ÄòR‚Äô, which comes first in the alphabet and in being really cool.‚Ü©Ô∏é</p></li>
<li id="fn2"><p>Did you also know that the use of the New Zealand dollar is part of <a href="htpps://rostrum.blog/2021/07/15/dollar-dollar">a wider conspiracy</a>? The sheep dip goes deep on this one.‚Ü©Ô∏é</p></li>
<li id="fn3"><p>Don‚Äôt.‚Ü©Ô∏é</p></li>
<li id="fn4"><p>I consider this my hattrick of posts on <code>R_user_dir()</code>. I wrote about it as a way to <a href="https://rostrum.blog2023/02/02/trapinch">cache data from the Pok√©API in {trapinch}</a> and <a href="https://rostrum.blog/2022/11/13/tamrgo">store cyber pet blueprints in {tamRgo}</a>, the latter of which led to a post on <a href="https://rostrum.blog/2023/07/15/hiscore">saving high-score data with {hiscore}</a>.‚Ü©Ô∏é</p></li>
</ol>
</aside><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div id="quarto-reuse" class="quarto-appendix-contents"><div>CC BY-NC-SA 4.0</div></div></section></div> ]]></description>
  <category>monetize</category>
  <category>r</category>
  <guid>https://whimsical-wisp-30974e.netlify.app/posts/2023-08-01-monetize/index.html</guid>
  <pubDate>Mon, 31 Jul 2023 23:00:00 GMT</pubDate>
</item>
<item>
  <title>Save high scores for your R game</title>
  <dc:creator>Matt Dray</dc:creator>
  <link>https://whimsical-wisp-30974e.netlify.app/posts/2023-07-15-hiscore/index.html</link>
  <description><![CDATA[ 




<p><img src="https://whimsical-wisp-30974e.netlify.app/posts/2023-07-15-hiscore/resources/hiscore.gif" class="img-fluid" alt="R code run in an RStudio window. The hiscore package is attached and the play_coinflip function is run. The user guesses heads, it's wrong, they score zero, which is the new high score. The user tries again, is reminded that the high score is currently zero and then scores 1. The session is restarted, but the get_save_data function proves that the top score has been saved."></p>
<section id="tldr" class="level2">
<h2 class="anchored" data-anchor-id="tldr">tl;dr</h2>
<p>You can save your high score in games made with R. See <a href="https://github.com/matt-dray/hiscore">the package {hiscore}</a> for a demo.</p>
</section>
<section id="boot-up" class="level2">
<h2 class="anchored" data-anchor-id="boot-up">Boot up</h2>
<p>I wrote recently about how <a href="https://www.rostrum.blog/2023/04/02/splendid-r-games/">R is a game engine</a> and started <a href="https://github.com/matt-dray/splendid-r-games">a list of games written in R</a>.</p>
<p>All good game engines should let you save a high score, right?</p>
<p>So I‚Äôve done exactly this for a tiny concept package called <a href="https://github.com/matt-dray/hiscore">{hiscore}</a><sup>1</sup> that contains a simple game of luck</p>
<p>The package runs code that saves your high score, which is retained between play sessions.</p>
</section>
<section id="install" class="level2">
<h2 class="anchored" data-anchor-id="install">Install</h2>
<p>You can install the package <a href="https://github.com/matt-dray/hiscore">from GitHub</a>. It has no dependencies, but you‚Äôll need to be running R version 4, at least.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install.package</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"remotes"</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># if not yet installed</span></span>
<span id="cb1-2">remotes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install_github</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"matt-dray/hiscore"</span>)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(hiscore)</span></code></pre></div>
</div>
<p>Of course, it‚Äôs just a concept and I‚Äôve intentionally kept this as trivial as possible, but you can <a href="https://github.com/matt-dray/hiscore/issues">leave an issue</a> with bugs or ideas.</p>
</section>
<section id="play" class="level2">
<h2 class="anchored" data-anchor-id="play">Play</h2>
<p>For demonstration purposes, the inbuilt game is super simple: get the longest streak of correctly guessed coinflips.</p>
<p>To play, run <code>play_coinflip()</code> and type <kbd>H</kbd> or <kbd>T</kbd> and <kbd>Enter</kbd> when prompted. Basically, a coinflip is simulated with <code>sample(c("H", "T"), 1)</code> and then compared to the user‚Äôs input, supplied from the console following a <code>readline()</code> call.</p>
<p>Keep going until you get it wrong. If you get a new high score, it‚Äôll be saved.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">play_coinflip</span>()</span></code></pre></div>
</div>
<pre><code>[H]eads or [T]ails? Answer: H
Correct! Current score: 1
[H]eads or [T]ails? Answer: H
Incorrect! Final score: 1
New high score!
New high score saved.</code></pre>
<p>You can retrieve the current high score with <code>get_save_data()</code>, which returns a little table.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_save_data</span>()</span></code></pre></div>
</div>
<pre><code>      game high_score
1 coinflip          1</code></pre>
<p>Of course, you could also set up the function so that it records different player names too. And you could add additional games that would get their own row in this table.</p>
</section>
<section id="memory" class="level2">
<h2 class="anchored" data-anchor-id="memory">Memory</h2>
<p>Note that the high score data is retained on your computer even if you restart your session or reboot your machine. How so?</p>
<p>This is thanks to <a href="https://rdrr.io/r/tools/userdir.html">the <code>tools::R_user_dir()</code> function</a>, which was added to R in version 4.0. It builds system-specific paths to ‚Äòdirectories for storing R-related user-specific data, configuration and cache files‚Äô where you can save package-related information.</p>
<p>{hiscore} records top scores in this fashion. On my machine, the save location resolves to the following:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">tools<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">R_user_dir</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hiscore"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "/Users/mattdray/Library/Application Support/org.R-project.R/R/hiscore"</code></pre>
</div>
</div>
<p>Regular readers may remember that I used <code>R_user_dir()</code> in the {tamRgo} package (<a href="https://www.rostrum.blog/2022/11/13/tamrgo/">blog</a>, <a href="https://github.com/matt-dray/tamRgo">source</a>), which lets you look after a Tamagotchi-style cyber-pet in your console. I used the function to save a pet‚Äôs ‚Äòblueprint‚Äô (details such as name, age and hunger level) persistently.</p>
</section>
<section id="retry" class="level2">
<h2 class="anchored" data-anchor-id="retry">Retry</h2>
<p>Now imagine you want to retry to beat that incredible top score of 1. Since you last played, you probably restarted your session or computer.</p>
<pre><code>Restarting R session...</code></pre>
<p>But never fear: the high score was retained. You can see that when you run <code>play_coinflip()</code> again and are reminded of the current best.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(hiscore)</span>
<span id="cb9-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">play_coinflip</span>()</span></code></pre></div>
</div>
<pre><code>Welcome. Your current high score is 1
[H]eads or [T]ails? Answer: h
Correct! Current score: 1
[H]eads or [T]ails? Answer: t
Correct! Current score: 2
[H]eads or [T]ails? Answer: h
Incorrect! Final score: 2
New high score!
New high score saved.</code></pre>
<p>Great job, you doubled the previous record!</p>
<p>When you get a game over, the <code>play_coinflip()</code> function checks the current high score and compares it to the final score for the current play session. The saved data is overwritten if the score is higher.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_save_data</span>()</span></code></pre></div>
</div>
<pre><code>      game high_score
1 coinflip          2</code></pre>
<p>I think it‚Äôs a good idea to make it easy for people to destroy the stored data if they want, which you can do easily with <code>delete_save_data()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">delete_save_data</span>()</span></code></pre></div>
</div>
<pre><code>Really delete? [Y]es/[N]o: Y
High score data deleted.</code></pre>
</section>
<section id="game-over" class="level2">
<h2 class="anchored" data-anchor-id="game-over">Game over</h2>
<p>How else could this approach be used in an R gaming perspective? You could use this to save a game state, similar to what‚Äôs done for <a href="https://www.rostrum.blog/2022/11/13/tamrgo/">{tamRgo}</a>. The user could input <code>S</code>ave instead of performing a guess, which would record the current status of the game so the user can return later. But that would feel like cheating for a game like coinflip.</p>
<p>Speaking of, here‚Äôs a cheatcode as a bonus for reading this far:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1">cheat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(game, new_score) {</span>
<span id="cb15-2">  user_dir <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> tools<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">R_user_dir</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hiscore"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data"</span>)</span>
<span id="cb15-3">  score_path <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(user_dir, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"score_table.rds"</span>)</span>
<span id="cb15-4">  score_table <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(score_path)</span>
<span id="cb15-5">  score_table[score_table[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"game"</span>]] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> game, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"high_score"</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> new_score</span>
<span id="cb15-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">saveRDS</span>(score_table, score_path)</span>
<span id="cb15-7">}</span>
<span id="cb15-8"></span>
<span id="cb15-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cheat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"coinflip"</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e100</span>)</span>
<span id="cb15-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_save_data</span>()</span></code></pre></div>
</div>
<pre><code>      game high_score
1 coinflip     1e+100</code></pre>
<p>Heh heh heh.</p>
</section>



<div id="quarto-appendix" class="default"><section id="environment" class="level2 appendix"><h2 class="anchored quarto-appendix-heading">Environment</h2><div class="quarto-appendix-contents">

<details>
<summary>
Session info
</summary>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Last rendered: 2023-07-25 15:10:34 BST</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.3.1 (2023-06-16)
Platform: aarch64-apple-darwin20 (64-bit)
Running under: macOS Ventura 13.2.1

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: Europe/London
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
[1] hiscore_0.0.0.9000

loaded via a namespace (and not attached):
 [1] htmlwidgets_1.6.2 compiler_4.3.1    fastmap_1.1.1     cli_3.6.1        
 [5] tools_4.3.1       htmltools_0.5.5   rstudioapi_0.15.0 yaml_2.3.7       
 [9] rmarkdown_2.23    knitr_1.43.1      jsonlite_1.8.7    xfun_0.39        
[13] digest_0.6.33     rlang_1.1.1       evaluate_0.21    </code></pre>
</div>
</div>
</details>


</div></section><aside id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>As in ‚Äòhigh score‚Äô not as in ‚Äòhis core‚Äô.‚Ü©Ô∏é</p></li>
</ol>
</aside><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div id="quarto-reuse" class="quarto-appendix-contents"><div>CC BY-NC-SA 4.0</div></div></section></div> ]]></description>
  <category>hiscore</category>
  <category>r</category>
  <category>videogames</category>
  <guid>https://whimsical-wisp-30974e.netlify.app/posts/2023-07-15-hiscore/index.html</guid>
  <pubDate>Fri, 14 Jul 2023 23:00:00 GMT</pubDate>
</item>
<item>
  <title>Convert a Word table to Markdown</title>
  <dc:creator>Matt Dray</dc:creator>
  <link>https://whimsical-wisp-30974e.netlify.app/posts/2023-06-21-wordup-tables/index.html</link>
  <description><![CDATA[ 




<p><img src="https://whimsical-wisp-30974e.netlify.app/posts/2023-06-21-wordup-tables/resources/wordup.gif" class="img-fluid" style="width:100.0%" alt="A gif that shows a table of numbers being copied. Then  a function called table_to_govspeak is run in an RStudio window and the output is a special Markdown version of that copied table."></p>
<section id="tldr" class="level2">
<h2 class="anchored" data-anchor-id="tldr">tl;dr</h2>
<p>I made a function that shouldn‚Äôt need to exist in an ideal world: it takes a copied Microsoft Word table and outputs a Markdown version (well, a <a href="https://govspeak-preview.publishing.service.gov.uk/guide">Govspeak</a> version).</p>
</section>
<section id="govspeak-when-youre-spoken-to" class="level2">
<h2 class="anchored" data-anchor-id="govspeak-when-youre-spoken-to">Govspeak when you‚Äôre spoken to</h2>
<p>I‚Äôve written about three painful things recently:</p>
<ol type="1">
<li>Forcing data scientists to <a href="https://www.rostrum.blog/2023/06/13/panic-in-the-toolshed/">expose their tools</a> so we can all use and learn from them.</li>
<li><a href="https://www.rostrum.blog/2023/06/13/panic-in-the-toolshed/">‚ÄòRectangularising‚Äô tables scraped out of a Word document</a> via the {officer} package.</li>
<li>Easier ways to <a href="https://www.rostrum.blog/2023/04/23/type-convert/">coerce dataframe columns to their ‚Äòintended‚Äô data type</a>.</li>
</ol>
<p>Today I bring you a terrible Cerberus with these three heads<sup>1</sup>.</p>
<p>The challenge: sometimes public sector statisticians produce Word documents that need to be converted to a special type of simplified plaintext Markdown, called <a href="https://govspeak-preview.publishing.service.gov.uk/guide">Govspeak</a>, before they can be uploaded for publication as HTML files on GOV.UK<sup>2</sup>.</p>
<p>This is fine: we have specific publishing specialists who can take care of it. It can be a little tedious, however. What if we could speed up and make more efficient the process of converting from Word to Govspeak?</p>
<p>There‚Äôs a specific <a href="https://govspeak-preview.publishing.service.gov.uk/">Govspeak converter</a> online that you can paste into. But it doesn‚Äôt have full coverage of the things that might appear in a Word doc, including tables. Other online converters exist, but I don‚Äôt think we should rely on third parties that are probably intended for producing general Markdown rather than Govspeak, specifically</p>
</section>
<section id="markdown-word-up." class="level2">
<h2 class="anchored" data-anchor-id="markdown-word-up.">Markdown? Word up.</h2>
<p>I‚Äôve started an R package called <a href="https://github.com/matt-dray/wordup">{wordup}</a> that aims to take a Word document and convert it to Govspeak. It‚Äôs early days in the sense that it doesn‚Äôt yet do, well‚Ä¶ very much. But I thought the package name was funny (if unoriginal) and worth squatting. Maybe I‚Äôll never get around to developing it, who knows.</p>
<p>To install (which is really not worth it right now, unless you want to <a href="https://github.com/matt-dray/wordup/issues">raise an issue</a> or pull request):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install.packages</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"remotes"</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># if not yet installed</span></span>
<span id="cb1-2">remotes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install_github</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"matt-dray/wordup"</span>)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(wordup)</span></code></pre></div>
</div>
<p>For now, the principle is that you can unzip a Word document to expose a bunch of xml files (yet another thing I‚Äôve been <a href="https://www.rostrum.blog/2023/06/11/apple-health-redux/">writing about recently</a>, lol) that contain all the information needed to build the Word document<sup>3</sup>. As such, you can read that xml and extract all the information, styles, etc, and massage it programmatically into Govspeak format.</p>
<p>Part of the process will involve taking a Word table, specifically, and converting it to a <a href="https://www.gov.uk/guidance/how-to-publish-on-gov-uk/markdown#tables">Govspeak-friendly form</a>. I figured this might be a nice standalone tool in its itself, so I had a stab at what it could look like.</p>
</section>
<section id="fantabulars" class="level2">
<h2 class="anchored" data-anchor-id="fantabulars">Fantabulars</h2>
<p>So right now the <code>wordup::table_to_govspeak()</code> function (whose name could change at any time) does three things:</p>
<ol type="1">
<li>Handles inputs.</li>
<li>Guesses data types.</li>
<li>Applies extra styles.</li>
</ol>
<p>You can either (a) copy-paste a Word table into the function, or (b) simply copy it to the clipboard, where it can be read by the function using <a href="http://matthewlincoln.net/clipr/">the {clipr} package</a>. The function will take the string‚Äîwhich is basically tabs (<code>\t</code>) to indicate gaps between cells and newlines (<code>\n</code>) to indicate rows‚Äîand reorient it initially into a dataframe.</p>
<p>Of course, all the columns will be character-class at this point. We can immediately run <code>type.convert()</code> over the whole dataframe to coerce each column to a more appropriate data type, if appropriate. So a character column composed of <code>c("10", "20", "30)</code> will become a numeric column of values <code>c(10, 20, 30)</code>. But this doesn‚Äôt work for numeric values that have symbols in them, like commas as thousands separators (<code>1,200</code>), per cent symbols (<code>82%</code>) and placeholder markers to indicate things like suppressed values (<code>[c]</code>)<sup>4</sup>. To get around this, we can strip the nuisance characters and then see if what remains looks like a number.</p>
<p>Finally, there‚Äôs some specific features of Govspeak tables that need attention. It‚Äôs acceptable to have row labels, where each value in every cell of the first column should be prefaced with an octothorpe (<code>#</code>), and totals columns, where the entire row should be emboldened with double-asterisks (<code>**</code>) either side of the cells‚Äô values.</p>
<p>What results can be sort of‚Ä¶ magic really. You copy a Word table in its entirety to your clipboard, run the function, and bang: the Govspeak Markdown is returned. You can see this in action in the gif at the top of this page.</p>
<p>So I can literally copy a table like this to my clipboard:</p>
<table class="table">
<thead>
<tr class="header">
<th>Column 1</th>
<th style="text-align: right;">Column 2</th>
<th style="text-align: right;">Column 3</th>
<th style="text-align: right;">Column 4</th>
<th style="text-align: right;">Column 5</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>X</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">1,000</td>
<td style="text-align: right;">1%</td>
<td style="text-align: right;">15</td>
</tr>
<tr class="even">
<td>Y</td>
<td style="text-align: right;">200</td>
<td style="text-align: right;">2,000</td>
<td style="text-align: right;">2%</td>
<td style="text-align: right;">12</td>
</tr>
<tr class="odd">
<td>Z</td>
<td style="text-align: right;">300</td>
<td style="text-align: right;">3,000</td>
<td style="text-align: right;">3%</td>
<td style="text-align: right;">[c]</td>
</tr>
<tr class="even">
<td>Totals</td>
<td style="text-align: right;">600</td>
<td style="text-align: right;">6,000</td>
<td style="text-align: right;">6%</td>
<td style="text-align: right;">[c]</td>
</tr>
</tbody>
</table>
<p>And run this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">wordup<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">table_to_govspeak</span>()</span></code></pre></div>
</div>
<p>To print this (and have it copied to your clipboard as the message says):</p>
<pre><code>| Column 1 | Column 2 | Column 3 | Column 4 | Column 5 |
| ------- | ------: | ------: | ------: | ------: |
| X | 100 | 1,000 | 1% | 15 |
| Y | 200 | 2,000 | 2% | 12 |
| Z | 300 | 3,000 | 3% | [c] |
| Totals | 600 | 6,000 | 6% | [c] |
The output table has been written to the clipboard.</code></pre>
<p>Boom. Note the crucial feature that the third, fourth and fifth columns are recognised as numeric‚Äîdespite containing the strings <code>,</code>, <code>%</code> and <code>[c]</code>‚Äîand therefore right-aligned (<code>------:</code>). This is entirely due to the argument <code>ignore_regex</code>, which defaults to removing commas, percentage symbols or anything in square brackets before it guesses what data type the column is<sup>5</sup>.</p>
<p>And we can do fancy things like:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">wordup<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">table_to_govspeak</span>(</span>
<span id="cb4-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">has_row_titles =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,</span>
<span id="cb4-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">totals_rows =</span> 4L</span>
<span id="cb4-4">)</span></code></pre></div>
</div>
<p>Which outputs this thing:</p>
<pre><code>| Column 1 | Column 2 | Column 3 | Column 4 | Column 5 |
| ------- | ------: | ------: | ------: | ------: |
| # X | 100 | 1,000 | 1% | 15 |
| # Y | 200 | 2,000 | 2% | 12 |
| # Z | 300 | 3,000 | 3% | [c] |
| # **Totals** | **600** | **6,000** | **6%** | **[c]** |
The output table has been written to the clipboard.</code></pre>
<p>Of course, in practice this might get a little more complicated if you need to manually specify in the function declaration that there‚Äôs a column of row titles or some totals rows. Pish-posh. The point is that I think this is probably better than trying to (a) write the Govspeak table by hand or (b) trying to use the Govspeak converter, which just doesn‚Äôt work for this task. This also has mild, opinionated, Govspeak-related benefits over using a straightforward <code>knitr::kable()</code>.</p>
<p>Is this perfect? Ahaha, no. There‚Äôs a lot to add or improve, but I think this is a decent start and solves a (niche) problem for now<sup>6</sup>.</p>
</section>



<div id="quarto-appendix" class="default"><section id="environment" class="level2 appendix"><h2 class="anchored quarto-appendix-heading">Environment</h2><div class="quarto-appendix-contents">

<details>
<summary>
Session info
</summary>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Last rendered: 2023-07-04 09:56:28 BST</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.3.1 (2023-06-16)
Platform: aarch64-apple-darwin20 (64-bit)
Running under: macOS Ventura 13.2.1

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: Europe/London
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
[1] wordup_0.0.0.9000

loaded via a namespace (and not attached):
 [1] htmlwidgets_1.6.2 compiler_4.3.1    fastmap_1.1.1     cli_3.6.1        
 [5] tools_4.3.1       htmltools_0.5.5   rstudioapi_0.14   yaml_2.3.7       
 [9] rmarkdown_2.22    knitr_1.43.1      jsonlite_1.8.7    xfun_0.39        
[13] digest_0.6.31     rlang_1.1.1       evaluate_0.21    </code></pre>
</div>
</div>
</details>


</div></section><aside id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Wrangling Word content with R is certainly a Herculean labour, amirite, classics fans? I know there are classicists who write R. Own up. There‚Äôs no shame. Adriana is one of you.‚Ü©Ô∏é</p></li>
<li id="fn2"><p>In case you were wondering: yes, this is a ‚Äòsolved‚Äô problem where teams use <a href="https://analysisfunction.civilservice.gov.uk/support/reproducible-analytical-pipelines/">Reproducible Analytical Pipelines (RAP)</a> to produce statistical publications. They can convert directly from R Markdown to Govspeak using something like <a href="https://github.com/moj-analytical-services/mojspeakr">{mojspeakr}</a>. But not every team is using R to produce their statistical publications. The wider R community on social media may be aware of <a href="https://rap4mads.eu/">Bruno‚Äôs recently-released book</a> on the principles of RAP. The RAP movement <a href="https://dataingovernment.blog.gov.uk/2017/03/27/reproducible-analytical-pipeline/">started in the UK government</a> but appears to be taking off internationally.‚Ü©Ô∏é</p></li>
<li id="fn3"><p>This technique is currently in the news (if you move in certain geeky circles, which you do, because you‚Äôre reading this), because an unzipped Excel file appeared to <a href="https://datacolada.org/109">expose a‚Ä¶ suspicious sequence of formulae executions</a> that underpinned a published academic paper.‚Ü©Ô∏é</p></li>
<li id="fn4"><p>There‚Äôs specific <a href="https://analysisfunction.civilservice.gov.uk/policy-store/symbols-in-tables-definitions-and-help/">best-practice government guidance</a> for the symbols that should be used for this purpose, such as ‚Äò[c]‚Äô to mean that the data is suppressed due to reasons of confidentiality.‚Ü©Ô∏é</p></li>
<li id="fn5"><p>There are pre-existing functions that can parse numbers containing strings, like <code>readr::parse_number("10%")</code> returns <code>10</code>. But this particular function can‚Äôt handle arbitrary strings in your number, like the placeholder <code>[c]</code> used to represent suppressed values.‚Ü©Ô∏é</p></li>
<li id="fn6"><p>I think you might be used to that by now if you‚Äôve read this blog more than once.‚Ü©Ô∏é</p></li>
</ol>
</aside><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div id="quarto-reuse" class="quarto-appendix-contents"><div>CC BY-NC-SA 4.0</div></div></section></div> ]]></description>
  <category>clipr</category>
  <category>markdown</category>
  <category>ms-office</category>
  <category>public-sector</category>
  <category>quarto</category>
  <category>r</category>
  <category>wordup</category>
  <guid>https://whimsical-wisp-30974e.netlify.app/posts/2023-06-21-wordup-tables/index.html</guid>
  <pubDate>Tue, 20 Jun 2023 23:00:00 GMT</pubDate>
</item>
<item>
  <title>Panic! In The Toolshed</title>
  <dc:creator>Matt Dray</dc:creator>
  <link>https://whimsical-wisp-30974e.netlify.app/posts/2023-06-13-panic-in-the-toolshed/index.html</link>
  <description><![CDATA[ 




<p><img src="https://whimsical-wisp-30974e.netlify.app/posts/2023-06-13-panic-in-the-toolshed/resources/panik.png" class="img-fluid" style="width:50.0%" alt="Panik meme with three panels. First panel has a panicked face saying 'I have a laborious task to do'. Second panel has a calm face saying 'write an R package to do it'. Third panel has an even more panicked face saying 'Now I have to maintain an R package'."></p>
<section id="tldr" class="level2">
<h2 class="anchored" data-anchor-id="tldr">tl;dr</h2>
<p>I wrote <a href="https://matt-dray.github.io/government-toolshed/">some slides</a> to tell data scientists in the public sector what they already know: share the tools you‚Äôve developed.</p>
</section>
<section id="an-axe-to-grind" class="level2">
<h2 class="anchored" data-anchor-id="an-axe-to-grind">An axe to grind</h2>
<p>I‚Äôm speaking today at an event for UK government data scientists with a theme of ‚Äòthe data science toolshed‚Äô. My plea is small: I want public sector workers to share the tools they make<sup>1</sup>.</p>
<p>We should build modular things like R packages that are easy to use and develop; make them available to everyone to minimise duplication and encourage collaboration; and maximise reach by telling everyone about it. This is how we improve quality and build our community. And save money for the taxpayer.</p>
<p>Handily, this is already expressed in the government‚Äôs <a href="https://www.gov.uk/guidance/the-technology-code-of-practice">Technology Code of Practice</a>:</p>
<blockquote class="blockquote">
<p>Share, reuse and collaborate: avoid duplicating effort and unnecessary costs by collaborating across government and sharing and reusing technology, data, and services.</p>
</blockquote>
<p>I‚Äôve had a small experience with this: I made <a href="https://co-analysis.github.io/a11ytables/">the {a11ytables} R package</a> to help producers of stats publications automate the creation of best-practice, accessible spreadsheets. It‚Äôs now being used in several organisations and is referenced from <a href="https://analysisfunction.civilservice.gov.uk/policy-store/further-resources-for-releasing-statistics-in-spreadsheets/">the government‚Äôs best-practice guidance</a>.</p>
<p>Success? Maybe. But also PANIK: I‚Äôve left the organisation where I made it; I was the sole developer; I worry that I should have thought about this sooner; that I should fork and update it; that updating users will be hard; that links to the old package will break; and so on. Hopefully people will learn something from these missteps.</p>
</section>
<section id="burying-the-hatchet" class="level2">
<h2 class="anchored" data-anchor-id="burying-the-hatchet">Burying the hatchet</h2>
<p>The slides are live <a href="https://matt-dray.github.io/government-toolshed/">on the internet</a> and embedded below, or you can view <a href="https://matt-dray.github.io/government-toolshed/#/section-1">the source on GitHub</a>. Press <kbd>s</kbd> to pop out the speaker notes, <kbd>o</kbd> for a slide overview and <kbd>f</kbd> for fullscreen.</p>
<div class="cell">
<div class="cell-output-display">
<div class="shareagain" style="min-width:300px;margin:1em auto;" data-exeternal="1">
<iframe src="https://matt-dray.github.io/government-toolshed/" width="1600" height="900" style="border:none;" loading="lazy" allowfullscreen=""></iframe>
<script>fitvids('.shareagain', {players: 'iframe'});</script>
</div>
</div>
</div>
<p>The slides were made with <a href="https://quarto.org/docs/presentations/revealjs/">Revealjs via Quarto</a>, because of course they were.</p>
</section>
<section id="clamp-down" class="level2">
<h2 class="anchored" data-anchor-id="clamp-down">Clamp down</h2>
<p>So, we should sustainabilise (not a word), centralise and advertise the useful things we make. Maybe we could have a list of tools we‚Äôve produced collectively in the public sector? Something like <a href="https://github.com/sindresorhus/awesome">an ‚ÄòAwesome‚Äô list</a> or a <a href="https://cran.r-project.org/web/views/">CRAN task view</a>. Maybe that would make it easier to find and develop existing solutions instead of building from scratch all the time.</p>
<p>Build a toolshed. They will come?</p>
</section>



<div id="quarto-appendix" class="default"><section id="environment" class="level2 appendix"><h2 class="anchored quarto-appendix-heading">Environment</h2><div class="quarto-appendix-contents">

<details>
<summary>
Session info
</summary>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Last rendered: 2023-07-17 18:03:30 BST</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.3.1 (2023-06-16)
Platform: aarch64-apple-darwin20 (64-bit)
Running under: macOS Ventura 13.2.1

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: Europe/London
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

loaded via a namespace (and not attached):
 [1] htmlwidgets_1.6.2   compiler_4.3.1      fastmap_1.1.1      
 [4] cli_3.6.1           tools_4.3.1         htmltools_0.5.5    
 [7] xaringanExtra_0.7.0 rstudioapi_0.15.0   yaml_2.3.7         
[10] rmarkdown_2.23      knitr_1.43.1        jsonlite_1.8.7     
[13] xfun_0.39           digest_0.6.31       rlang_1.1.1        
[16] evaluate_0.21      </code></pre>
</div>
</div>
</details>


</div></section><aside id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>I get that it‚Äôs not always possible to share things because of sensitivity issues. If you can‚Äôt open it up to the world, then what‚Äôs the highest level that you can release it? Organisation, division, team? If you can‚Äôt share the tool, then what can you tell people about the experience of developing and using it?‚Ü©Ô∏é</p></li>
</ol>
</aside><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div id="quarto-reuse" class="quarto-appendix-contents"><div>CC BY-NC-SA 4.0</div></div></section></div> ]]></description>
  <category>a11ytables</category>
  <category>event</category>
  <category>public-sector</category>
  <category>r</category>
  <category>talk</category>
  <guid>https://whimsical-wisp-30974e.netlify.app/posts/2023-06-13-panic-in-the-toolshed/index.html</guid>
  <pubDate>Mon, 12 Jun 2023 23:00:00 GMT</pubDate>
</item>
<item>
  <title>Extract run data from Apple Health (redux)</title>
  <dc:creator>Matt Dray</dc:creator>
  <link>https://whimsical-wisp-30974e.netlify.app/posts/2023-06-11-apple-health-redux/index.html</link>
  <description><![CDATA[ 




<p><img src="https://whimsical-wisp-30974e.netlify.app/posts/2023-06-11-apple-health-redux/resources/apple-run.png" class="img-fluid" style="width:100.0%" alt="A badly drawn cartoon apple running along and thinking about some XML data."></p>
<section id="tldr" class="level2">
<h2 class="anchored" data-anchor-id="tldr">tl;dr</h2>
<p>You can use R to extract running details from a downloaded of your Apple Health data. The format of the data has changed since I last tried this, so I re-wrote my code.</p>
</section>
<section id="on-your-marks" class="level2">
<h2 class="anchored" data-anchor-id="on-your-marks">On your marks</h2>
<p>In 2021 <a href="https://www.rostrum.blog/2021/03/23/xml-health/">I extracted my running activities from my Apple Health data</a> using <a href="https://xml2.r-lib.org/">the {xml2} package</a>. You can read there for some theory and background.</p>
<p>At that point I‚Äôd been running for one year. I‚Äôm nearly at 500 runs, so I thought I would re-execute my code with the latest data. Alas, the original code no longer works because Apple seems to have updated the format of the XML file they provide.</p>
<div class="tip">
<p> <b>Note</b></p>
<p>I have since re-rendered this post after passing 500 runs.</p>
<div>

<p>So I‚Äôve written a new function that takes a path to the zipped download of my Apple Health data and outputs a dataframe of time and distance data, with one row per run.</p>
</div></div></section>
<section id="get-set" class="level2">
<h2 class="anchored" data-anchor-id="get-set">Get set</h2>
<p>I followed <a href="https://www.rostrum.blog/2021/03/23/xml-health/#warm-up">the same steps as before</a> to get my Apple Health data off my phone.</p>
<p>I smashed together a quick function to unzip the file to a temporary location and then extract workout data using the <a href="https://xml2.r-lib.org/">the {xml2} package</a>. There‚Äôs a bit of base R wrangling to output a dataframe with a row per run workout, focusing on total time and distance.</p>
<details>
<summary>
Click to expand the function definition
</summary>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">get_run_distances <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(zip_path) {</span>
<span id="cb1-2">  </span>
<span id="cb1-3">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Unzip Apple Health export to temporary location</span></span>
<span id="cb1-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">message</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Unzipping and reading XML"</span>)</span>
<span id="cb1-5">  temp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tempdir</span>()</span>
<span id="cb1-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unzip</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">zipfile =</span> zip_path, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">exdir =</span> temp)</span>
<span id="cb1-7">  xml_in <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> xml2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_xml</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(temp, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"apple_health_export"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"export.xml"</span>))</span>
<span id="cb1-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unlink</span>(temp)</span>
<span id="cb1-9">  </span>
<span id="cb1-10">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Isolate workouts only and convert to an R list object</span></span>
<span id="cb1-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">message</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Isolating workouts from XML"</span>)</span>
<span id="cb1-12">  wo_in <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> xml2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xml_find_all</span>(xml_in, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"//Workout"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> xml2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_list</span>()</span>
<span id="cb1-13">  </span>
<span id="cb1-14">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Pre-allocate a list to be filled with output data</span></span>
<span id="cb1-15">  wo_total <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(wo_in)</span>
<span id="cb1-16">  wo_out <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vector</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"list"</span>, wo_total)</span>
<span id="cb1-17">  </span>
<span id="cb1-18">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># For each viable workout, extract the details</span></span>
<span id="cb1-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">message</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Iterating over workouts to extract run data"</span>)</span>
<span id="cb1-20">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (wo_n <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(wo_total)) {</span>
<span id="cb1-21">    </span>
<span id="cb1-22">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract details for current workout</span></span>
<span id="cb1-23">    wo <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> wo_in[[wo_n]]</span>
<span id="cb1-24">    wo_attrs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attributes</span>(wo)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the data is stored as attributes</span></span>
<span id="cb1-25">    is_run <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb1-26">      wo_attrs[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"workoutActivityType"</span>]] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"HKWorkoutActivityTypeRunning"</span></span>
<span id="cb1-27">    </span>
<span id="cb1-28">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># If the workout wasn't a run, then skip to the next workout</span></span>
<span id="cb1-29">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>is_run) <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">next</span></span>
<span id="cb1-30">    </span>
<span id="cb1-31">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># if it is a run, then extract the data to a single-row dataframe</span></span>
<span id="cb1-32">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (is_run) {</span>
<span id="cb1-33">      </span>
<span id="cb1-34">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># There can be more than one element named 'WorkoutStatistics'. We want to </span></span>
<span id="cb1-35">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get the one with distance information and extract the details.</span></span>
<span id="cb1-36">      wo_stats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> wo[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grep</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"WorkoutStatistics"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(wo))]</span>
<span id="cb1-37">      wo_stats_types <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lapply</span>(wo_stats, \(x) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(x, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"type"</span>)))</span>
<span id="cb1-38">      dist_type <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"HKQuantityTypeIdentifierDistanceWalkingRunning"</span></span>
<span id="cb1-39">      dist_index <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which</span>(wo_stats_types <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> dist_type)</span>
<span id="cb1-40">      wo_dist <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> wo_stats[[dist_index]]</span>
<span id="cb1-41">      </span>
<span id="cb1-42">      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Prepare single-row dataframe and add to the pre-allocated list</span></span>
<span id="cb1-43">      wo_details <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb1-44">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">source =</span> wo_attrs[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sourceName"</span>]],</span>
<span id="cb1-45">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">start =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.POSIXct</span>(wo_attrs[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"startDate"</span>]]),</span>
<span id="cb1-46">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">end =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.POSIXct</span>(wo_attrs[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"endDate"</span>]]),</span>
<span id="cb1-47">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">distance_km =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(wo_dist, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sum"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb1-48">      )</span>
<span id="cb1-49">      wo_details[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"duration_s"</span>]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb1-50">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(wo_details[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"end"</span>]] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> wo_details[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"start"</span>]], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">units =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"secs"</span>)</span>
<span id="cb1-51">      wo_out[[wo_n]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> wo_details</span>
<span id="cb1-52">      </span>
<span id="cb1-53">    }</span>
<span id="cb1-54">    </span>
<span id="cb1-55">  }</span>
<span id="cb1-56">  </span>
<span id="cb1-57">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert to dataframe, select columns</span></span>
<span id="cb1-58">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">message</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Combining data"</span>)</span>
<span id="cb1-59">  wo_out_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">do.call</span>(rbind, wo_out)</span>
<span id="cb1-60">  wo_out_df[, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"source"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"start"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"end"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"duration_s"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"distance_km"</span>)]</span>
<span id="cb1-61">  </span>
<span id="cb1-62">}</span></code></pre></div>
</div>
</details>
<p>I won‚Äôt go through it line by line, but there‚Äôs some commentary to explain what‚Äôs happening at each step. It does what I need it to do for now, but no doubt there‚Äôs some refactoring to be done.</p>
<p>There‚Äôs a few things to note:</p>
<ul>
<li>I‚Äôm more comfortable handling R objects, so I converted early to a list with <code>xml2::as_list()</code>. Awkwardly, the data in the list object was stored as <a href="https://xml2.r-lib.org/">attributes</a> to each element.</li>
<li>The distance data is stored in an element called ‚ÄòWorkoutStatistics‚Äô, but more than one element will have this name. We first have to isolate the element that is of the correct type, which has the name ‚ÄòHKQuantityTypeIdentifierDistanceWalkingRunning‚Äô.</li>
<li>I converted the start and end variables to datetime class (POSIXct) and subtracted one from the other to get the duration of the run. This yields the ‚Äòdifftime‚Äô class that can be converted to seconds with <code>as.numeric()</code> and the argument <code>units = "secs"</code>.</li>
<li>There‚Äôs no input handling, because this was quick and for ‚Äòfun‚Äô, lol.</li>
</ul>
</section>
<section id="go" class="level2">
<h2 class="anchored" data-anchor-id="go">Go</h2>
<p>So, to use the function you pass a path to where your zipped Apple Health export lives. Mine is in my ‚ÄòDocuments‚Äô folder.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">runs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_run_distances</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"~/Documents/data/export.zip"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Unzipping and reading XML</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Isolating workouts from XML</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Iterating over workouts to extract run data</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Combining data</code></pre>
</div>
</div>
<p>I recorded all my runs with the Nike Run Club app, so I‚Äôll filter out duplicates where I dual-recorded with Apple‚Äôs Workout app. I think I accidentally started the app by mistake a couple of times, so we‚Äôll only grab runs of over 1 km. I‚Äôll also convert the seconds to a friendlier-looking ‚Äòperiod‚Äô class using <a href="https://lubridate.tidyverse.org/">{lubridate}</a><sup>1</sup>.</p>
<p>Here‚Äôs the most recent few:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">runs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> runs[runs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>source <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Nike Run Club"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> runs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>distance_km <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, ]</span>
<span id="cb7-2">runs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>duration <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> lubridate<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seconds_to_period</span>(runs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>duration_s)</span>
<span id="cb7-3">runs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> runs[, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"start"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"distance_km"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"duration"</span>)]</span>
<span id="cb7-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row.names</span>(runs) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span></span>
<span id="cb7-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tail</span>(runs)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                  start distance_km duration
497 2023-06-15 08:45:46        6.39  30M 36S
498 2023-06-17 11:07:03       10.52  50M 58S
499 2023-06-18 10:36:58       10.42  51M 29S
500 2023-06-22 08:14:51        6.34  30M 43S
501 2023-06-24 08:47:05       10.13  48M 43S
502 2023-06-25 09:20:20       12.12  59M 48S</code></pre>
</div>
</div>
<p>For my own tracking purposes, I‚Äôve run:</p>
<ul>
<li>502 times</li>
<li>for a total distance of 4119 km</li>
<li>for a total duration of about 14 days</li>
</ul>
<p>And I can recreate a couple of the plots from the old post while we‚Äôre here. Here‚Äôs the ‚Äòrun barcode‚Äô, with one vertical line per run (the darker it is the greater the distance):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">warn.conflicts =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span>
<span id="cb9-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyr)</span>
<span id="cb9-3"></span>
<span id="cb9-4">run_days <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(</span>
<span id="cb9-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">date =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_date</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ymd</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2020-03-23"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ymd</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023-06-25"</span>))),</span>
<span id="cb9-6">  runs <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb9-7">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transmute</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">date =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ymd</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as_date</span>(start)), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">km =</span> distance_km, duration) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb9-8">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(date <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2020-03-23"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> date <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023-06-25"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb9-9">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(date) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb9-10">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">km =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(km), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.groups =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"drop"</span>),</span>
<span id="cb9-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"date"</span></span>
<span id="cb9-12">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb9-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">replace_na</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">run =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb9-14"></span>
<span id="cb9-15"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">par</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mar =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span>
<span id="cb9-16"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">image</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(run_days<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>km), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grey.colors</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb9-17"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">box</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://whimsical-wisp-30974e.netlify.app/posts/2023-06-11-apple-health-redux/index_files/figure-html/barcode-1.png" class="img-fluid" alt="A one-dimensional plot of days represented by vertical lines, with run distance coloured on a scale of white to black." width="960"></p>
</div>
</div>
<p>And of course, a simple distance over time plot:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(</span>
<span id="cb10-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> runs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>start, </span>
<span id="cb10-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> runs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>distance_km, </span>
<span id="cb10-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">las =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># rotate y-axis labels</span></span>
<span id="cb10-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">main =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Runs captured with Nike Run Club in Apple Health"</span>,</span>
<span id="cb10-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Date"</span>,</span>
<span id="cb10-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Distance (km)"</span></span>
<span id="cb10-8">)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://whimsical-wisp-30974e.netlify.app/posts/2023-06-11-apple-health-redux/index_files/figure-html/plot-1.png" class="img-fluid" alt="Run distance over time scatterplot, which shows a high frequency of 5 and 10 km runs." width="672"></p>
</div>
</div>
<p>Some patterns are obvious. For example, there‚Äôs lots of 5 km runs until about mid-2021, when it hops to more like 7 km. That‚Äôs when I started running for 30 mins at a time, rather than for 5 km specifically.</p>
<p>I‚Äôm pretty happy at 5 and 10 km, obviously, but maybe I should do more 21.1 km half-marathons. Or a full marathon? No no, that‚Äôs foolish: it would expand my y-axis too much and make it harder to observe patterns at shorter distances, amirite.</p>
</section>



<div id="quarto-appendix" class="default"><section id="environment" class="level2 appendix"><h2 class="anchored quarto-appendix-heading">Environment</h2><div class="quarto-appendix-contents">

<details>
<summary>
Session info
</summary>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Last rendered: 2023-07-21 19:29:55 BST</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.3.1 (2023-06-16)
Platform: aarch64-apple-darwin20 (64-bit)
Running under: macOS Ventura 13.2.1

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: Europe/London
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
[1] tidyr_1.3.0     dplyr_1.1.2     lubridate_1.9.2

loaded via a namespace (and not attached):
 [1] vctrs_0.6.3       cli_3.6.1         knitr_1.43.1      rlang_1.1.1      
 [5] xfun_0.39         purrr_1.0.1       generics_0.1.3    jsonlite_1.8.7   
 [9] glue_1.6.2        htmltools_0.5.5   fansi_1.0.4       rmarkdown_2.23   
[13] evaluate_0.21     tibble_3.2.1      fontawesome_0.5.1 fastmap_1.1.1    
[17] yaml_2.3.7        lifecycle_1.0.3   compiler_4.3.1    htmlwidgets_1.6.2
[21] timechange_0.2.0  pkgconfig_2.0.3   rstudioapi_0.15.0 digest_0.6.33    
[25] R6_2.5.1          tidyselect_1.2.0  utf8_1.2.3        pillar_1.9.0     
[29] magrittr_2.0.3    tools_4.3.1       xml2_1.3.5       </code></pre>
</div>
</div>
</details>


</div></section><aside id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>{lubridate} is handy for time handling for many reasons. Here it‚Äôs helpful because it can resolve minutes and seconds (e.g.&nbsp;<code>21M 30S</code>) instead of the decimal minutes (e.g.&nbsp;<code>21.5</code>) in a difftime object.‚Ü©Ô∏é</p></li>
</ol>
</aside><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div id="quarto-reuse" class="quarto-appendix-contents"><div>CC BY-NC-SA 4.0</div></div></section></div> ]]></description>
  <category>apple</category>
  <category>r</category>
  <category>sport</category>
  <category>xml</category>
  <category>xml2</category>
  <guid>https://whimsical-wisp-30974e.netlify.app/posts/2023-06-11-apple-health-redux/index.html</guid>
  <pubDate>Sat, 10 Jun 2023 23:00:00 GMT</pubDate>
</item>
<item>
  <title>Rectangularise Word tables extracted by {officer}</title>
  <dc:creator>Matt Dray</dc:creator>
  <link>https://whimsical-wisp-30974e.netlify.app/posts/2023-06-07-rectangular-officer/index.html</link>
  <description><![CDATA[ 




<p><img src="https://whimsical-wisp-30974e.netlify.app/posts/2023-06-07-rectangular-officer/resources/owl.png" class="img-fluid" style="width:100.0%" alt="The 'draw the rest of the owl' meme. The title is 'how to draw an owl' but it's been scribble dout and replaced with comic sans text that says 'How to extract an R data.frame from a Word table'. There are two steps: 'draw some circles' and then 'draw the rest of the owl'. The text for these has been replaced with Comic Sans that reads 'let officer do all the hard work' and then 'overengineer an unecessary new function.'"></p>
<section id="tldr" class="level2">
<h2 class="anchored" data-anchor-id="tldr">tl;dr</h2>
<p><a href="https://davidgohel.github.io/officer/">{officer} is an R package</a> that lets you extract elements of a Word document, including tables, into a tidy dataframe. I‚Äôve written a function to ‚Äòre-rectangularise‚Äô extracted Word tables into a list of R dataframes.</p>
<div class="tip">
<p> <b>Note</b></p>
<p>Turns out that <a href="https://elipousson.github.io/">Eli Pousson</a> has written the <a href="https://elipousson.github.io/officerExtras">{officerExtras} package</a> (<a href="https://github.com/elipousson/officerExtras/">install it from GitHub</a>), which already contains this functionality in <a href="https://elipousson.github.io/officerExtras/reference/officer_tables.html">the <code>officer_tables()</code> and <code>officer_table()</code> functions</a>. At least this proves my idea wasn‚Äôt too far-fetched!</p>
<p>Also you can just use <a href="https://github.com/hrbrmstr/docxtractr"><code>docxtractr::docx_extract_all_tbls()</code> by Bob Rudis</a> to extract all the tables in one go, lol.</p>
</div>
</section>
<section id="whats-the-officer-problem" class="level2">
<h2 class="anchored" data-anchor-id="whats-the-officer-problem">What‚Äôs the officer, problem?</h2>
<p>Someone on Slack asked about some difficulty with scraping a table from a Word document. We‚Äôve all been there.</p>
<p>My mind immediately went to <a href="https://davidgohel.github.io/officer/">{officer} by David Gohel</a>, which is part of <a href="https://ardata-fr.github.io/officeverse/">the ‚Äòofficeverse‚Äô</a> for reading, creating and manipulating common Microsoft documents with R<sup>1</sup>.</p>
<p>In particular, the function <code>officer::docx_summary()</code> extracts all the elements of a Word doc into a tidy dataframe<sup>2</sup>. Each row of that dataframe is a heading, or a paragraph, or the contents of a table cell<sup>3</sup>.</p>
<p>This means tables are ‚Äòunstacked‚Äô, with a row per ‚Äòcell‚Äô of the original Word table. How could you convert these tidy Word tables into dataframes for further use in R? There‚Äôs <a href="https://ardata-fr.github.io/officeverse/extract-content.html#word-tables">a suggestion in the docs</a>, but I <a href="https://knowyourmeme.com/memes/how-to-draw-an-owl">drew the rest of the heckin‚Äô owl</a> by creating a slightly overengineered function to do it<sup>4</sup>.</p>
</section>
<section id="allo-allo" class="level2">
<h2 class="anchored" data-anchor-id="allo-allo">‚ÄôAllo ‚Äôallo</h2>
<p>First, you can download the {officer} package from CRAN:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install.packages</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"officer"</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># if not yet installed</span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(officer)</span></code></pre></div>
</div>
<p>Let‚Äôs create a Word document to test with and save it to a temporary location:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a test docx file</span></span>
<span id="cb2-2">doc_test <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_docx</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb2-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">body_add_par</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"This is a test"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">style =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"heading 1"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb2-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">body_add_par</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Below is a table."</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">style =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Normal"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb2-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">body_add_table</span>(mtcars[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb2-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">body_add_par</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Below is another table"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">style =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Normal"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb2-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">body_add_table</span>(airquality[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>])</span>
<span id="cb2-8"></span>
<span id="cb2-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save docx to temp location</span></span>
<span id="cb2-10">temp_docx <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tempfile</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fileext =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".docx"</span>)</span>
<span id="cb2-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(doc_test, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">target =</span> temp_docx)</span></code></pre></div>
</div>
<p>The package has a nice system of pipeable functions for building up document. This code created a file with a heading, followed by two tables that each have a line of text above them.</p>
<p>We can read the document with <code>read_docx()</code> and extract the contents into a tidy dataframe:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Read the file from temp path</span></span>
<span id="cb3-2">doc_path <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list.files</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tempdir</span>(), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pattern =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".docx$"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">full.names =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb3-3">doc_in <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_docx</span>(doc_path)</span>
<span id="cb3-4"></span>
<span id="cb3-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get the content of the document as a dataframe</span></span>
<span id="cb3-6">doc_tidy <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">docx_summary</span>(doc_in)</span>
<span id="cb3-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str</span>(doc_tidy)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'data.frame':   43 obs. of  11 variables:
 $ doc_index   : int  1 2 3 3 3 3 3 3 3 3 ...
 $ content_type: chr  "paragraph" "paragraph" "table cell" "table cell" ...
 $ style_name  : chr  "heading 1" "Normal" NA NA ...
 $ text        : chr  "This is a test" "Below is a table." "mpg" "21.0" ...
 $ level       : num  NA NA NA NA NA NA NA NA NA NA ...
 $ num_id      : int  NA NA NA NA NA NA NA NA NA NA ...
 $ row_id      : int  NA NA 1 2 3 4 1 2 3 4 ...
 $ is_header   : logi  NA NA TRUE FALSE FALSE FALSE ...
 $ cell_id     : num  NA NA 1 1 1 1 2 2 2 2 ...
 $ col_span    : num  NA NA 1 1 1 1 1 1 1 1 ...
 $ row_span    : int  NA NA 1 1 1 1 1 1 1 1 ...</code></pre>
</div>
</div>
<p>The <code>doc_in</code> object has ‚Äòrdocx‚Äô class that carries the extracted elements and associated style information. Running <code>docx_summary()</code> converts this to the single tidy dataframe that we‚Äôre after.</p>
<p>You can see we have information here about the content of our doc. For purposes of this post, we care about:</p>
<ul>
<li><code>text</code>, which is the actual written content</li>
<li><code>content_type</code>, which can tell us if we‚Äôre looking at table cells</li>
<li><code>doc_index</code>, which assigns an ID value so document elements stay together (e.g.&nbsp;cells of a table will all carry the same <code>doc_index</code>)</li>
<li><code>cell_id</code> and <code>row_id</code>, which tell us the x and y cell locations in tables</li>
<li><code>is_header</code>, which can tell us if the row contains a table header.</li>
</ul>
<p>Now to extract the table elements and ‚Äòre-rectangularise‚Äô back into a dataframe.</p>
</section>
<section id="cop-a-load-of-this" class="level2">
<h2 class="anchored" data-anchor-id="cop-a-load-of-this">Cop a load of this</h2>
<p>I‚Äôve made two functions using base R:</p>
<ol type="1">
<li><code>rectangularise_tables()</code> (note the plural) takes the dataframe provided by <code>docx_summary()</code> and outputs a list of dataframes, one per table in the original Word file</li>
<li><code>.rectangularise_table()</code> (not pluralised and starts with a dot for disambiguation), which runs inside <code>rectangularise_tables()</code> to reformat the tidy representation of a single Word table into an R dataframe</li>
</ol>
<p>You‚Äôll need to copy both of these into your session and run them. For convenience, <a href="https://gist.github.com/matt-dray/d4837f106bcee80ea39235b6465a7cac">I‚Äôve added them to a GitHub gist</a>. I‚Äôve added commentary so you can see what‚Äôs happening in each bit.</p>
<details>
<summary>
Click to expand the <code>rectangularise_tables()</code> definition.
</summary>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">rectangularise_tables <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(</span>
<span id="cb5-2">    docx_summary,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># output dataframe from docx_summary</span></span>
<span id="cb5-3">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">assume_headers =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># assume headers in first row?</span></span>
<span id="cb5-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type_convert =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># try to coerce columns to most likely data type?</span></span>
<span id="cb5-5">) {</span>
<span id="cb5-6">  </span>
<span id="cb5-7">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check inputs</span></span>
<span id="cb5-8">  </span>
<span id="cb5-9">  is_data.frame <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inherits</span>(docx_summary, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data.frame"</span>)</span>
<span id="cb5-10">  </span>
<span id="cb5-11">  docx_summary_names <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb5-12">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_index"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content_type"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"style_name"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"level"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"num_id"</span>, </span>
<span id="cb5-13">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"row_id"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"is_header"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell_id"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"col_span"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"row_span"</span></span>
<span id="cb5-14">  )  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># column names we can expect in the output from docx_summary</span></span>
<span id="cb5-15">  </span>
<span id="cb5-16">  is_docx_summary <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(docx_summary) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> docx_summary_names)</span>
<span id="cb5-17">  </span>
<span id="cb5-18">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>is_data.frame <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>is_docx_summary) {</span>
<span id="cb5-19">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stop</span>(</span>
<span id="cb5-20">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(</span>
<span id="cb5-21">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Argument 'docx_summary' must be a data.frame created with"</span>,</span>
<span id="cb5-22">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"'officer::docx_summary'."</span></span>
<span id="cb5-23">      ),</span>
<span id="cb5-24">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">call. =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span></span>
<span id="cb5-25">    )</span>
<span id="cb5-26">  }</span>
<span id="cb5-27">  </span>
<span id="cb5-28">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get only the rows that relate to Word tables</span></span>
<span id="cb5-29">  docx_summary_tables <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb5-30">    docx_summary[docx_summary[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content_type"</span>]] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"table cell"</span>, ]</span>
<span id="cb5-31">  </span>
<span id="cb5-32">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get the ID value for each Word table</span></span>
<span id="cb5-33">  doc_indices <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(docx_summary_tables[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_index"</span>]])</span>
<span id="cb5-34">  </span>
<span id="cb5-35">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initiate an empty list to hold dataframe representations of the Word tables</span></span>
<span id="cb5-36">  tables_out <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vector</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mode =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"list"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(doc_indices))</span>
<span id="cb5-37">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(tables_out) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_index_"</span>, doc_indices)</span>
<span id="cb5-38">  </span>
<span id="cb5-39">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># For each Word table, 'rectangularise' into a dataframe and add to the list</span></span>
<span id="cb5-40">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (doc_index <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> doc_indices) {</span>
<span id="cb5-41">    </span>
<span id="cb5-42">    docx_summary_table <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb5-43">      docx_summary_tables[docx_summary_tables[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_index"</span>]] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> doc_index, ]</span>
<span id="cb5-44">    </span>
<span id="cb5-45">    extracted_table <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">.rectangularise_table</span>(docx_summary_table, assume_headers)</span>
<span id="cb5-46">    </span>
<span id="cb5-47">    list_element_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_index_"</span>, doc_index)</span>
<span id="cb5-48">    tables_out[[list_element_name]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> extracted_table</span>
<span id="cb5-49">    </span>
<span id="cb5-50">  }</span>
<span id="cb5-51">  </span>
<span id="cb5-52">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Optionally convert columns to appropriate type (integer, etc)</span></span>
<span id="cb5-53">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (type_convert) {</span>
<span id="cb5-54">    tables_out <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lapply</span>(tables_out, type.convert, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">as.is =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb5-55">  }</span>
<span id="cb5-56">  </span>
<span id="cb5-57">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(tables_out)</span>
<span id="cb5-58">  </span>
<span id="cb5-59">}</span></code></pre></div>
</div>
</details>
<details>
<summary>
Click to expand the <code>.rectangularise_table()</code> definition.
</summary>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">.rectangularise_table <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(</span>
<span id="cb6-2">    table_cells,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># docx_summary output filtered for 'table cells' only</span></span>
<span id="cb6-3">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">assume_headers =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># assume headers in first row?</span></span>
<span id="cb6-4">) {</span>
<span id="cb6-5">  </span>
<span id="cb6-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check inputs</span></span>
<span id="cb6-7">  </span>
<span id="cb6-8">  is_table_cells <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all</span>(table_cells[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"content_type"</span>]] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"table cell"</span>)</span>
<span id="cb6-9">  is_one_table <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(table_cells[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"doc_index"</span>]])) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb6-10">  </span>
<span id="cb6-11">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>is_table_cells <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>is_one_table) {</span>
<span id="cb6-12">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stop</span>(</span>
<span id="cb6-13">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(</span>
<span id="cb6-14">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Argument 'table_cells' must be a dataframe created with"</span>,</span>
<span id="cb6-15">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"'officer::docx_summary' where 'content_type' is filtered for"</span>,</span>
<span id="cb6-16">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"'table cell' only."</span></span>
<span id="cb6-17">      ),</span>
<span id="cb6-18">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">call. =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span></span>
<span id="cb6-19">    )</span>
<span id="cb6-20">  }</span>
<span id="cb6-21">  </span>
<span id="cb6-22">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Split each Word table into a list element, isolate headers and cell contents</span></span>
<span id="cb6-23">  cell_id_split <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">split</span>(table_cells, table_cells[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cell_id"</span>]])</span>
<span id="cb6-24">  headers <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lapply</span>(cell_id_split, <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x) x[x[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"is_header"</span>]], <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text"</span>])</span>
<span id="cb6-25">  content <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lapply</span>(cell_id_split, <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x) x[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>x[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"is_header"</span>]], <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text"</span>])</span>
<span id="cb6-26">  table_out <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(content)</span>
<span id="cb6-27">  </span>
<span id="cb6-28">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Column headers are identified by TRUE in the is_header column, but may not</span></span>
<span id="cb6-29">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># be marked up as such. Use them as dataframe headers if they exist.</span></span>
<span id="cb6-30">  has_headers <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unlist</span>(headers)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb6-31">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (has_headers) {</span>
<span id="cb6-32">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(table_out) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> headers</span>
<span id="cb6-33">  }</span>
<span id="cb6-34">  </span>
<span id="cb6-35">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># If headers are not identified by is_header, assume that the first row of the</span></span>
<span id="cb6-36">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Word table contains the headers. The user can control this behaviour with</span></span>
<span id="cb6-37">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the argument assume_headers.</span></span>
<span id="cb6-38">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>has_headers <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> assume_headers) {</span>
<span id="cb6-39">    headers <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> table_out[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, ]  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># assume first row is headers</span></span>
<span id="cb6-40">    table_out <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> table_out[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(table_out), ]  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># rest of table is content</span></span>
<span id="cb6-41">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(table_out) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> headers</span>
<span id="cb6-42">  }</span>
<span id="cb6-43">  </span>
<span id="cb6-44">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(table_out)</span>
<span id="cb6-45">  </span>
<span id="cb6-46">}</span></code></pre></div>
</div>
</details>
<p>You‚Äôll notice the <code>assume_headers</code> argument. The headers for a Word table are marked by <code>TRUE</code> in the <code>is_header</code> column of the output from <code>docx_summary()</code>. Except when they aren‚Äôt. It‚Äôs possible that you‚Äôll read a Word doc where the table headers aren‚Äôt identified. Set <code>assume_headers</code> to <code>TRUE</code> (the default) to allow <code>rectangularise_table()</code> to instead use the first row of the table as headers. The setting will apply to all tables; I reckon that it‚Äôs all or nothing whether table headers will be marked up in a given Word document.</p>
<p>You may also have seen the <code>type_convert</code> argument<sup>5</sup>. By default, the <code>text</code> column in the output from <code>docx_summary()</code> will be character class, but the actual data might be integers, for example. <a href="https://www.rostrum.blog/2023/04/23/type-convert/">As explained in a recent blog post</a>, the <code>type.convert()</code> function attempts to coerce a column to the appropriate data type if possible.</p>
<p>And now we can see that the dataset works using our test document:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">df_list <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rectangularise_tables</span>(doc_tidy)</span>
<span id="cb7-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str</span>(df_list)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 2
 $ doc_index_3:'data.frame':    3 obs. of  5 variables:
  ..$ mpg : num [1:3] 21 21 22.8
  ..$ cyl : int [1:3] 6 6 4
  ..$ disp: int [1:3] 160 160 108
  ..$ hp  : int [1:3] 110 110 93
  ..$ drat: num [1:3] 3.9 3.9 3.85
 $ doc_index_5:'data.frame':    3 obs. of  5 variables:
  ..$ Ozone  : int [1:3] 41 36 12
  ..$ Solar.R: int [1:3] 190 118 149
  ..$ Wind   : num [1:3] 7.4 8 12.6
  ..$ Temp   : int [1:3] 67 72 74
  ..$ Month  : int [1:3] 5 5 5</code></pre>
</div>
</div>
<p>Smashing. We have a list of two dataframes: one for each of the tables in the test document. I took the liberty of naming the list elements like <code>doc_index_*</code> so you can trace which <code>doc_index</code> they were in the original output from <code>docx_summary()</code>.</p>
</section>
<section id="prisonr" class="level2">
<h2 class="anchored" data-anchor-id="prisonr">PrisonR</h2>
<p>To summarise, this is absolutely not the worst code-related crime I‚Äôve committed on this blog. Sorry guv! I‚Äôll definitely be sentenced to the most severe punishment if caught and tried: several minutes of hard labour, or ‚Äòrefactoring‚Äô as they call it on the inside.</p>
<p>At worst I‚Äôll build an Andy-Dufresne-style tunnel out of my prison cell and hide the entrance behind years of accumulated hex stickers.</p>
<div class="tip">
<p> <b>Note</b></p>
<p>As a bonus, I later wrote a quick reproducible example that part-solves the original reason for this post. Here I‚Äôve used {docxtractr} to extract tables from docx files in separate subfolders and then combine them.</p>
<details>
<summary>
Click to expand code.
</summary>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Attach packages (all are available from CRAN)</span></span>
<span id="cb9-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(docxtractr)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># to extract tables from docx files</span></span>
<span id="cb9-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(officer)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># to create dummy docx files</span></span>
<span id="cb9-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(charlatan)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># to generate fake data</span></span>
<span id="cb9-5"></span>
<span id="cb9-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create multiple dummy docx files in separate temporary folders</span></span>
<span id="cb9-7"></span>
<span id="cb9-8">my_folder <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tempdir</span>()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># temporary locations to store the files</span></span>
<span id="cb9-9">n_files <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the number of dummy files to generate</span></span>
<span id="cb9-10"></span>
<span id="cb9-11"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(n_files)) {</span>
<span id="cb9-12">  </span>
<span id="cb9-13">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create subfolders</span></span>
<span id="cb9-14">  subfolder_name <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"subfolder_"</span>, i)</span>
<span id="cb9-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dir.create</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(my_folder, subfolder_name))</span>
<span id="cb9-16">  </span>
<span id="cb9-17">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create dummy dataframe</span></span>
<span id="cb9-18">  </span>
<span id="cb9-19">  n_fake <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># number of fake data items to generate</span></span>
<span id="cb9-20">  </span>
<span id="cb9-21">  temp_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb9-22">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ch_name</span>(n_fake),</span>
<span id="cb9-23">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">job =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ch_job</span>(n_fake),</span>
<span id="cb9-24">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">phone =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ch_phone_number</span>(n_fake)</span>
<span id="cb9-25">  )</span>
<span id="cb9-26">  </span>
<span id="cb9-27">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add dummy dataframe to a docx file and save it</span></span>
<span id="cb9-28">  path <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.path</span>(my_folder, subfolder_name, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"df_"</span>, i, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".docx"</span>))</span>
<span id="cb9-29">  officer<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_docx</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">body_add_table</span>(temp_df) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">target =</span> path)</span>
<span id="cb9-30">  </span>
<span id="cb9-31">}</span>
<span id="cb9-32"></span>
<span id="cb9-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get the file paths to all the docx files</span></span>
<span id="cb9-34">docx_paths <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list.files</span>(</span>
<span id="cb9-35">  my_folder,</span>
<span id="cb9-36">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pattern =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".docx$"</span>,</span>
<span id="cb9-37">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">full.names =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># return full filepaths</span></span>
<span id="cb9-38">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">recursive =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># look in all subfolders</span></span>
<span id="cb9-39">)</span>
<span id="cb9-40"></span>
<span id="cb9-41"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Preallocate a list to be filled with extracted tables, one element per file</span></span>
<span id="cb9-42">extracted_tables <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vector</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"list"</span>, n_files)</span>
<span id="cb9-43"></span>
<span id="cb9-44"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract tables and add to the list (not tested: I think that read_docx will</span></span>
<span id="cb9-45"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># read .doc files, but only if you have LibreOffice installed.</span></span>
<span id="cb9-46"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> docx_paths) {</span>
<span id="cb9-47">  tables <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> docxtractr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_docx</span>(i) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">docx_extract_all_tbls</span>()</span>
<span id="cb9-48">  extracted_tables[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">basename</span>(i)] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> tables</span>
<span id="cb9-49">}</span>
<span id="cb9-50"></span>
<span id="cb9-51"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># In this simple demo, the dataframes in each list element can be appended</span></span>
<span id="cb9-52"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># because they all have the same column names and types.</span></span>
<span id="cb9-53"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">do.call</span>(rbind, extracted_tables)</span></code></pre></div>
</div>
</details></div>
</section>



<div id="quarto-appendix" class="default"><section id="environment" class="level2 appendix"><h2 class="anchored quarto-appendix-heading">Environment</h2><div class="quarto-appendix-contents">

<details>
<summary>
Session info
</summary>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Last rendered: 2023-07-17 18:05:37 BST</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.3.1 (2023-06-16)
Platform: aarch64-apple-darwin20 (64-bit)
Running under: macOS Ventura 13.2.1

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: Europe/London
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
[1] officer_0.6.2

loaded via a namespace (and not attached):
 [1] digest_0.6.31     R6_2.5.1          fastmap_1.1.1     xfun_0.39        
 [5] fontawesome_0.5.1 knitr_1.43.1      htmltools_0.5.5   rmarkdown_2.23   
 [9] xml2_1.3.5        cli_3.6.1         zip_2.3.0         askpass_1.1      
[13] openssl_2.1.0     textshaping_0.3.6 systemfonts_1.0.4 compiler_4.3.1   
[17] rstudioapi_0.15.0 tools_4.3.1       ragg_1.2.5        evaluate_0.21    
[21] yaml_2.3.7        rlang_1.1.1       jsonlite_1.8.7    htmlwidgets_1.6.2
[25] uuid_1.1-0       </code></pre>
</div>
</div>
</details>


</div></section><aside id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Related: I have some experience with R-to-Excel: <a href="https://co-analysis.github.io/a11ytables/">my {a11ytables} package</a> generates best-practice spreadsheets <a href="https://ycphs.github.io/openxlsx/">using {openxlsx}</a>.‚Ü©Ô∏é</p></li>
<li id="fn2"><p>It would be wrong for me not to point out that you can extract Excel and ODS cells into ‚Äòtidy‚Äô dataframes with <a href="https://nacnudus.github.io/tidyxl/index.html">Duncan Garmonsway‚Äôs {tidyxl}</a> and <a href="https://mattkerlogue.github.io/tidyods/">Matt Kerlogue‚Äôs {tidyods}</a>. No, they haven‚Äôt sponsored this post (invoices in the mail, chaps).‚Ü©Ô∏é</p></li>
<li id="fn3"><p>Merged cells in the table end up being unmerged, with the upper- and left-most cells holding the content and the remianing cells being assigned <code>NA</code>.‚Ü©Ô∏é</p></li>
<li id="fn4"><p>I did this for my own curiosity, really. Just like everything else on this blog! As mentioned, check out <a href="https://github.com/hrbrmstr/docxtractr">{docxtractr}</a> and <a href="https://elipousson.github.io/officerExtras">{officerExtras}</a> for better implementations.‚Ü©Ô∏é</p></li>
<li id="fn5"><p>What a handy function. This was useful enough that Eli has now added it to <a href="https://elipousson.github.io/officerExtras/reference/officer_tables.html">{officerExtras}</a>.‚Ü©Ô∏é</p></li>
</ol>
</aside><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div id="quarto-reuse" class="quarto-appendix-contents"><div>CC BY-NC-SA 4.0</div></div></section></div> ]]></description>
  <category>ms-office</category>
  <category>officer</category>
  <category>officerExtras</category>
  <category>public-sector</category>
  <category>r</category>
  <guid>https://whimsical-wisp-30974e.netlify.app/posts/2023-06-07-rectangular-officer/index.html</guid>
  <pubDate>Tue, 06 Jun 2023 23:00:00 GMT</pubDate>
</item>
<item>
  <title>Recreating a dataviz with {ggplot2}</title>
  <dc:creator>Matt Dray</dc:creator>
  <link>https://whimsical-wisp-30974e.netlify.app/posts/2023-05-10-spear-ggplot2/index.html</link>
  <description><![CDATA[ 




<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://whimsical-wisp-30974e.netlify.app/posts/2023-05-10-spear-ggplot2/resources/corporate.png" class="img-fluid figure-img" style="width:100.0%" alt="The Office meme that says 'corporate needs you to find the difference between these two pictures. A crudely copy-pasted image of an original data visualisation by Mary Eleanor Spear is on the left and a recreation of it is on the right. They look pretty similar."></p>
<figcaption class="figure-caption">They‚Äôre the same picture. Nearly.</figcaption>
</figure>
</div>
<section id="tldr" class="level2">
<h2 class="anchored" data-anchor-id="tldr">tl;dr</h2>
<p>Two years ago I won <a href="https://rss.org.uk/news-publication/news-publications/2021/general-news/cottonviz-data-visualisation-challenge-winners-ann/">a data-viz recreation competition run by the Royal Statistical Society</a> (RSS) using base R‚Äôs plotting. I wrote a short {ggplot2} how-to for RSS‚Äôs ‚ÄòSignificance‚Äô magazine that was never published<sup>1</sup>, so here it is now.</p>
</section>
<section id="recreate" class="level2">
<h2 class="anchored" data-anchor-id="recreate">Recreate</h2>
<p>This short code walkthrough will get you started on recreating <a href="https://en.wikipedia.org/wiki/Mary_Eleanor_Spear">Mary Eleanor Spear</a>‚Äôs cotton plot (1952), as used in <a href="https://rss.org.uk/news-publication/news-publications/2021/general-news/cottonviz-data-visualisation-challenge-winners-ann/">the Royal Statistical Society‚Äôs #CottonViz challenge</a>. We‚Äôll concentrate on the line chart for now.</p>
<p><img src="https://whimsical-wisp-30974e.netlify.app/posts/2023-05-10-spear-ggplot2/resources/spear.jpg" class="img-fluid" style="width:100.0%" alt="Mary Eleanor Spear's original plot of cotton supplies in 1940s USA. On the left is a line plot showing that carry-over stocks fell from 1942 to 1948, while consumption dropped slightly and exports rose slightly. A bar plot to the right shows the same data as a stacked bar chart. There are titles and captions around the plots."></p>
<p><a href="https://ggplot2.tidyverse.org/">The {ggplot2} package in R</a> is a good choice, since we can build up the chart in steps: first, we‚Äôll build a basic line chart, remove unneeded elements, fix the axes and finally add the labels. It won‚Äôt look perfectly like Spear‚Äôs original, but we‚Äôll get close.</p>
<p>This isn‚Äôt a guide to learn {ggplot2}, so you may want to <a href="https://r4ds.had.co.nz/data-visualisation.html">learn the basics first</a>. Alternatively, <a href="https://www.rostrum.blog/2021/06/08/recreate-spear/">I wrote a blog post</a> about building Spear‚Äôs entire visualisation using base R only.</p>
</section>
<section id="requirements" class="level2">
<h2 class="anchored" data-anchor-id="requirements">Requirements</h2>
<p>First, some preparation. If you haven‚Äôt already, install the <a href="https://ggplot2.tidyverse.org/">{ggplot2}</a> package for plotting, <a href="https://tidyr.tidyverse.org/">{tidyr}</a> data reshaping and <a href="https://github.com/wch/extrafont">{extrafont}</a> for font handling.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install.packages</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ggplot2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tidyr"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"extrafont"</span>)</span></code></pre></div>
</div>
<p>You can download for free <a href="https://webonastick.com/fonts/routed-gothic/">the Routed Gothic font by Darren Embry</a>, which is a good approximation of the stencil lettering used by Spear. Installation will depend on your system, but in macOS you can simply drag the font files to the Font Book app. When you attach {extrafont} it‚Äôll fetch automatically your installed fonts (including Routhed Gothic) so you can use them in R.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(extrafont)</span></code></pre></div>
</div>
</section>
<section id="tidying-up" class="level2">
<h2 class="anchored" data-anchor-id="tidying-up">Tidying up</h2>
<p>The cotton dataset is quite small, so we can create the dataframe ourselves. It provides information on the supply of cotton in the USA in the 1940s.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">cotton_raw <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb3-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">year           =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1942</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1948</span>,</span>
<span id="cb3-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">us_consumption =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11160</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9993</span>,  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9693</span>,  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9423</span>,  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10072</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">9374</span>,  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7833</span>),</span>
<span id="cb3-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">exports        =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1480</span>,  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1139</span>,  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2007</span>,  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3613</span>,  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3545</span>,  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1968</span>,  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4785</span>),</span>
<span id="cb3-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">stocks         =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10657</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10744</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11164</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7326</span>,  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2530</span>,  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3080</span>,  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5283</span>),</span>
<span id="cb3-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">total_supply   =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">23297</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">21876</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">22864</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20362</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16147</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14422</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">17901</span>)</span>
<span id="cb3-7">)</span></code></pre></div>
</div>
<p>It‚Äôs preferable to make the data ‚Äòtidy‚Äô so that there‚Äôs one row per year and consumption type, and one column for each variable. The {tidyr} package can help us pivot the data to ‚Äòlong‚Äô format from this ‚Äòwide‚Äô format.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyr)</span>
<span id="cb4-2"></span>
<span id="cb4-3">cotton <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> cotton_raw <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb4-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(</span>
<span id="cb4-5">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(us_consumption, exports, stocks), </span>
<span id="cb4-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"consumption_type"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"boles"</span></span>
<span id="cb4-7">  )</span>
<span id="cb4-8"></span>
<span id="cb4-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(cotton, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># preview first few rows</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 √ó 4
   year total_supply consumption_type boles
  &lt;int&gt;        &lt;dbl&gt; &lt;chr&gt;            &lt;dbl&gt;
1  1942        23297 us_consumption   11160
2  1942        23297 exports           1480
3  1942        23297 stocks           10657
4  1943        21876 us_consumption    9993</code></pre>
</div>
</div>
</section>
<section id="how-to" class="level2">
<h2 class="anchored" data-anchor-id="how-to">How-to</h2>
<section id="step-1-line-chart" class="level3">
<h3 class="anchored" data-anchor-id="step-1-line-chart">Step 1: line chart</h3>
<p>Now we can create a basic line chart of the data with <code>geom_line()</code> and set with <code>scale_linetype_manual()</code> a unique dashed line per group. Further arguments set the title and the typeface to be used throughout the plot, while a small tweak to <code>theme()</code> adjusts the title‚Äôs position.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb6-2"></span>
<span id="cb6-3">p1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(</span>
<span id="cb6-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> cotton,</span>
<span id="cb6-6">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> year, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> boles <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> consumption_type),</span>
<span id="cb6-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span></span>
<span id="cb6-8">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_linetype_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"longdash"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dashed"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"solid"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Millions of Boles"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(</span>
<span id="cb6-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plot.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hjust =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>),</span>
<span id="cb6-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">text =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_text</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Routed Gothic"</span>)</span>
<span id="cb6-14">  )</span>
<span id="cb6-15"></span>
<span id="cb6-16">p1</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://whimsical-wisp-30974e.netlify.app/posts/2023-05-10-spear-ggplot2/index_files/figure-html/plot-start-1.png" class="img-fluid" width="480"></p>
</div>
</div>
</section>
<section id="step-2-remove-features" class="level3">
<h3 class="anchored" data-anchor-id="step-2-remove-features">Step 2: remove features</h3>
<p>Let‚Äôs clear away the unneeded features: the background panel, the axes titles and the legend. You can empty these with <code>element_blank()</code> in the <code>theme()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">p2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> p1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb7-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(</span>
<span id="cb7-3">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.background =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb7-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.title =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb7-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span></span>
<span id="cb7-6">  )</span>
<span id="cb7-7"></span>
<span id="cb7-8">p2</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://whimsical-wisp-30974e.netlify.app/posts/2023-05-10-spear-ggplot2/index_files/figure-html/plot-theme-1.png" class="img-fluid" width="480"></p>
</div>
</div>
</section>
<section id="step-3-correct-the-axes" class="level3">
<h3 class="anchored" data-anchor-id="step-3-correct-the-axes">Step 3: correct the axes</h3>
<p>Now we can address the axes. Use the <code>scale_*_continuous()</code> functions to set the axes values, limits, origin and labels. With <code>sec.axis</code> you can create a secondary y-axis that mirrors the first, then remove the tick labels in the <code>theme()</code> function. You can also put a box around the chart area with the <code>panel.border</code> argument.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">p3 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> p2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(</span>
<span id="cb8-3">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">breaks =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1942</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1948</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb8-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1942"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"'"</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">43</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">48</span>)),</span>
<span id="cb8-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">expand =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb8-6">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_continuous</span>(</span>
<span id="cb8-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">breaks =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>),</span>
<span id="cb8-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">limits =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>),</span>
<span id="cb8-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">expand =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>),</span>
<span id="cb8-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sec.axis =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dup_axis</span>()</span>
<span id="cb8-12">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(</span>
<span id="cb8-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.ticks =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_line</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)),</span>
<span id="cb8-15">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.ticks.length =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lines"</span>),</span>
<span id="cb8-16">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">axis.text.y.right =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_blank</span>(),</span>
<span id="cb8-17">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.border =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_rect</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb8-18">  )</span>
<span id="cb8-19"></span>
<span id="cb8-20">p3</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://whimsical-wisp-30974e.netlify.app/posts/2023-05-10-spear-ggplot2/index_files/figure-html/plot-axes-1.png" class="img-fluid" width="480"></p>
</div>
</div>
</section>
<section id="step-4-labels" class="level3">
<h3 class="anchored" data-anchor-id="step-4-labels">Step 4: labels</h3>
<p>The only missing features are the labels and arrows, which can be added with the <code>annotate()</code> and <code>geom_segment()</code>, respectively. A bit of trial-and-error will help you find the correct coordinates to place these elements.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">p4 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> p3 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">annotate</span>(</span>
<span id="cb9-3">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">geom =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text"</span>,</span>
<span id="cb9-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1946.1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1945.9</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1943.75</span>),</span>
<span id="cb9-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">10.8</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">7.1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.2</span>),</span>
<span id="cb9-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"U. S. Consumption"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Carry ‚Äì over</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Stocks"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Exports"</span>),</span>
<span id="cb9-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Routed Gothic"</span></span>
<span id="cb9-8">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_segment</span>(</span>
<span id="cb9-10">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(</span>
<span id="cb9-11">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1945.2</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1945.3</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1944.2</span>),</span>
<span id="cb9-12">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">10.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">7.4</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.1</span>),</span>
<span id="cb9-13">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1945</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1945.1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1944.4</span>), </span>
<span id="cb9-14">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">9.7</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">7.1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>)</span>
<span id="cb9-15">    ),</span>
<span id="cb9-16">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">arrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrow</span>(</span>
<span id="cb9-17">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unit</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mm"</span>),</span>
<span id="cb9-18">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"closed"</span></span>
<span id="cb9-19">    )</span>
<span id="cb9-20">  )</span>
<span id="cb9-21"></span>
<span id="cb9-22">p4</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://whimsical-wisp-30974e.netlify.app/posts/2023-05-10-spear-ggplot2/index_files/figure-html/plot-segments-1.png" class="img-fluid" width="480"></p>
</div>
</div>
</section>
</section>
<section id="next-steps" class="level2">
<h2 class="anchored" data-anchor-id="next-steps">Next steps</h2>
<p>Finally we‚Äôve got a lineplot that looks pretty close to Spear‚Äôs visualisation. What subtle differences do you notice, though? Try to find ways to improve them.</p>
<p>Next, try to recreate the stacked-barchart from Spear‚Äôs original and then arrange the plots with a main title and surrounding text labels. <a href="https://coolbutuseless.github.io/package/ggpattern/index.html">The {ggpattern} package</a> may help you recreate the hatchlines on the bars and <a href="https://patchwork.data-imaginist.com/">{patchwork}</a> could help with the arrangement of the plot and text elements.</p>
</section>
<section id="full-base-r-alternative" class="level2">
<h2 class="anchored" data-anchor-id="full-base-r-alternative">Full base R alternative</h2>
<p>For the original challenge I used only base R‚Äôs plotting system rather than {ggplot2}. This is what my submitted image looked like:</p>
<p><img src="https://whimsical-wisp-30974e.netlify.app/posts/2023-05-10-spear-ggplot2/resources/recreation.png" class="img-fluid" style="width:100.0%" alt="The recreated plot in progress: the recreation is complete, with both the line and bar plots completed and the titles and captions added."></p>
<p>You can read more about it in <a href="https://www.rostrum.blog/2021/06/08/recreate-spear/">the accompanying blog post</a> and you can find <a href="https://github.com/matt-dray/viz-recreation/tree/main/2021-06-08_cottonviz_spear">the original code on GitHub</a>.</p>
</section>



<div id="quarto-appendix" class="default"><section id="environment" class="level2 appendix"><h2 class="anchored quarto-appendix-heading">Environment</h2><div class="quarto-appendix-contents">

<details>
<summary>
Session info
</summary>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Last rendered: 2023-07-06 19:27:43 BST</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.3.1 (2023-06-16)
Platform: aarch64-apple-darwin20 (64-bit)
Running under: macOS Ventura 13.2.1

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: Europe/London
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
[1] ggplot2_3.4.2 tidyr_1.3.0  

loaded via a namespace (and not attached):
 [1] vctrs_0.6.3       cli_3.6.1         knitr_1.43.1      rlang_1.1.1      
 [5] xfun_0.39         purrr_1.0.1       generics_0.1.3    jsonlite_1.8.7   
 [9] labeling_0.4.2    glue_1.6.2        colorspace_2.1-0  htmltools_0.5.5  
[13] scales_1.2.1      fansi_1.0.4       rmarkdown_2.23    grid_4.3.1       
[17] munsell_0.5.0     evaluate_0.21     tibble_3.2.1      fastmap_1.1.1    
[21] yaml_2.3.7        lifecycle_1.0.3   compiler_4.3.1    dplyr_1.1.2      
[25] htmlwidgets_1.6.2 pkgconfig_2.0.3   rstudioapi_0.14   farver_2.1.1     
[29] digest_0.6.31     R6_2.5.1          tidyselect_1.2.0  utf8_1.2.3       
[33] pillar_1.9.0      magrittr_2.0.3    gtable_0.3.3      tools_4.3.1      
[37] withr_2.5.0      </code></pre>
</div>
</div>
</details>


</div></section><aside id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>At least I don‚Äôt think so. I can‚Äôt find it by searching on the website, anyway. Also, enough time has passed that certain bits of the original code have since been deprecated in {ggplot2}, lol.‚Ü©Ô∏é</p></li>
</ol>
</aside><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div id="quarto-reuse" class="quarto-appendix-contents"><div>CC BY-NC-SA 4.0</div></div></section></div> ]]></description>
  <category>data-viz</category>
  <category>history</category>
  <category>ggplot2</category>
  <category>r</category>
  <guid>https://whimsical-wisp-30974e.netlify.app/posts/2023-05-10-spear-ggplot2/index.html</guid>
  <pubDate>Tue, 09 May 2023 23:00:00 GMT</pubDate>
</item>
<item>
  <title>Automate {blogdown} to Quarto</title>
  <dc:creator>Matt Dray</dc:creator>
  <link>https://whimsical-wisp-30974e.netlify.app/posts/2023-05-07-bd2q/index.html</link>
  <description><![CDATA[ 




<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://whimsical-wisp-30974e.netlify.app/posts/2023-05-07-bd2q/resources/rostrum-blog-2.png" class="img-fluid figure-img" style="width:100.0%" alt="A screenshot of a version of this blog designed with Quarto. The style is very similar, using green and black and the blog logo, which is a 16 by 16 pixel picture of an insect. There are new sections for 'About', 'RSS' and 'Source', as well as s search button. The posts are displayed as 'cards' rather than in a list."></p>
<figcaption class="figure-caption">gRaPhIc DeSiGn Is My PaSsIoN.</figcaption>
</figure>
</div>
<section id="tldr" class="level2">
<h2 class="anchored" data-anchor-id="tldr">tl;dr</h2>
<p>I‚Äôve written a quick R package, <a href="https://github.com/matt-dray/bd2q">{bd2q}</a>, to help me convert my <a href="https://pkgs.rstudio.com/blogdown/">{blogdown}</a> blog to <a href="https://quarto.org/">Quarto</a>. Whether I‚Äôll actually complete the conversion is another story.</p>
</section>
<section id="upside-blogdown" class="level2">
<h2 class="anchored" data-anchor-id="upside-blogdown">Upside blogdown</h2>
<p>It is destiny: no-one is ever completely happy with their blog.</p>
<p>This site was built five years ago<sup>1</sup> with <a href="https://pkgs.rstudio.com/blogdown/">{blogdown}</a>, which lets you write R Markdown files and have them knitted into a blog. I ignored <a href="https://rstudio.github.io/distill/">the newer {distill} package</a><sup>2</sup>, but <a href="https://quarto.org/">Quarto</a> may be worth the switch. It‚Äôll let me simplify the blog‚Äôs structure<sup>3</sup> and take advantage of Quarto‚Äôs snazzy features<sup>4</sup>.</p>
<p>But I didn‚Äôt fancy transferring and editing ~150 posts by hand, so I‚Äôve written a few functions to help out.</p>
</section>
<section id="when-in-doubt-make-a-package" class="level2">
<h2 class="anchored" data-anchor-id="when-in-doubt-make-a-package">When in doubt, make a package</h2>
<p>And so the {bd2q} R package<sup>5</sup> is <a href="https://github.com/matt-dray/bd2q">available from GitHub</a>. It does what I need it to do for now, but note it only has basic error checking, has no unit tests, etc. Use at own risk, etc. It‚Äôs likely to remain unpolished forever, but feel free to add issues or pull requests. To install:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install.packages</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"remotes"</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># if not yet installed</span></span>
<span id="cb1-2">remotes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install_github</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"matt-dray/bd2q"</span>)</span></code></pre></div>
</div>
<p>Three things were in scope for this package:</p>
<ol type="1">
<li>Create a template Quarto blog.</li>
<li>Create the necessary Quarto folder structure for posts, then transfer posts and resources from the old {blogdown} blog.</li>
<li>Tweak the posts to remove or replace selected lines.</li>
</ol>
<section id="quarto-blog-template" class="level3">
<h3 class="anchored" data-anchor-id="quarto-blog-template">1. Quarto blog template</h3>
<p>I assume someone has already written a version of <code>usethis::create_project()</code> for creating a Quarto blog. Regardless, I‚Äôve written <code>bd2q::create_template()</code> to generate a folder with the minimal structure required, which makes my life easier for testing purposes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">bd2q<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">create_template</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">q_path =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"~/new-quarto-blog"</span>)</span></code></pre></div>
</div>
<pre><code>‚úî Created template Quarto blog at /Users/mattdray/new-quarto-blog</code></pre>
<p>The skeleton content is opinionated and differs a bit to the one generated through RStudio‚Äôs ‚Äònew project‚Äô menu, for example, but the structure is the same:</p>
<pre><code>blog
‚îú‚îÄ‚îÄ about.qmd
‚îú‚îÄ‚îÄ index.qmd
‚îú‚îÄ‚îÄ posts/
‚îÇ   ‚îî‚îÄ‚îÄ metadata.yml
‚îú‚îÄ‚îÄ styles.css
‚îî‚îÄ‚îÄ blog.rproj</code></pre>
<p>Of course, now we need to pull in the posts from the old {blogdown} blog.</p>
</section>
<section id="transfer-posts-and-resources" class="level3">
<h3 class="anchored" data-anchor-id="transfer-posts-and-resources">2. Transfer posts and resources</h3>
<p>Typically in a {blogdown} blog, all R Markdown posts and their rendered HTML files are stored together in <code>content/post/</code> in the form <code>YYYY-MM-DD-post-name.Rmd</code> and <code>YYYY-MM-DD-post-name.html</code>. Resources, like images, live separately in <code>static/post/</code> with a folder per post in the form <code>YYYY-MM-DD-post-name_files/</code>.</p>
<p>Here‚Äôs a simplified folder structure that focuses on a single post and its resources:</p>
<pre><code>blog/
‚îú‚îÄ‚îÄ content/
‚îÇ   ‚îî‚îÄ‚îÄ post/
‚îÇ       ‚îú‚îÄ‚îÄ YYYY-MM-DD-post-name.Rmd
‚îÇ       ‚îî‚îÄ‚îÄ YYYY-MM-DD-post-name.html
‚îî‚îÄ‚îÄ static/
    ‚îî‚îÄ‚îÄ post/
        ‚îî‚îÄ‚îÄ YYYY-MM-DD-post-name_files/
            ‚îî‚îÄ‚îÄ image.png</code></pre>
<p>Quarto simplifies this structure. Each post gets its own folder in <code>posts/</code>, like <code>YYYY-MM-DD-post-name</code>, which contains the post as <code>index.qmd</code> and a folder of resources. This means the post and all its content are stored together in one containing folder.</p>
<pre><code>blog/
‚îî‚îÄ‚îÄ posts/
    ‚îî‚îÄ‚îÄ YYYY-MM-DD-post-name/
        ‚îú‚îÄ‚îÄ index.qmd
        ‚îî‚îÄ‚îÄ resources/
            ‚îî‚îÄ‚îÄ image.png</code></pre>
<p>To do the conversion, <code>bd2q::transfer_posts()</code> copies posts from a {blogdown} blog structure to a Quarto blog structure, setting up the required folders and renaming each post to <code>index.qmd</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transfer_posts</span>(</span>
<span id="cb7-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bd_path =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"~/old-blogdown-blog"</span>,</span>
<span id="cb7-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">q_path =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"~/new-quarto-blog"</span></span>
<span id="cb7-4">)</span></code></pre></div>
</div>
<pre><code>‚úî Created posts/ directory structure.
‚Ñπ Copying posts.
‚úî Copied 148 posts to /Users/mattdray/new-quarto-blog.</code></pre>
<p>Once that‚Äôs been run, <code>bd2q::transfer_resources()</code> can copy each post‚Äôs resources into an accompanying subfolder, which defaults to the name ‚Äòresources‚Äô. You can choose which file types you want transfer with the <code>exts_keep</code> argument.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transfer_resources</span>(</span>
<span id="cb9-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bd_path =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"~/old-blogdown-blog"</span>,</span>
<span id="cb9-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">q_path =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"~/new-quarto-blog"</span>,</span>
<span id="cb9-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">resources_dir =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"resources"</span>,</span>
<span id="cb9-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">exts_keep =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gif"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jpg"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"jpeg"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"png"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"svg"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"wav"</span>),</span>
<span id="cb9-6">)</span></code></pre></div>
</div>
<pre><code>‚Ñπ Copying resources.
‚úî Copied 455 resources to each post's resources/ folder in Users/mattdray/new-quarto-blog/posts.</code></pre>
<p>Of course this doesn‚Äôt account for everything, like bits of JavaScript and CSS related to the use of <a href="https://www.htmlwidgets.org/">htmlwidgets</a>. I‚Äôm not really bothered about this, because these should be recreated when I re-render each post.</p>
<p>Note that you can use <code>bd2q::create_and_transfer()</code> if you want to run <code>create_template()</code>, <code>transfer_posts()</code> and <code>transfer_resources()</code> all at once. Regardless, once you‚Äôve got the structure sorted, you can begin to adjust the posts if you need to.</p>
</section>
<section id="tweak-post-content" class="level3">
<h3 class="anchored" data-anchor-id="tweak-post-content">3. Tweak post content</h3>
<p>There‚Äôs content in the body of each post that I want to get rid of or make more Quarto-like. I made a few functions that iterate over all the <code>index.qmd</code> files and replace or remove certain content.</p>
<p>One obvious necessity is to rebuild the resource paths (to images, sound files, etc), which can be done specifically with <code>bd2q::update_resource_paths()</code>. It defaults to creating paths to each post‚Äôs ‚Äòresources‚Äô subfolder, as generated by <code>bd2q::transfer_resources()</code>. For example, you could use a regular expression to match rows you know will contain a resource path and have them updated for the new Quarto folder structure (I tend to insert images with HTML rather than Markdown, hence the <code>&lt;img&gt;</code> tag in the example below).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">update_resource_paths</span>(</span>
<span id="cb11-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">q_path =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"~/new-quarto-blog"</span>,</span>
<span id="cb11-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">resources_dir =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"resources"</span>,</span>
<span id="cb11-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">resource_rx =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&lt;img src="</span></span>
<span id="cb11-5">)</span></code></pre></div>
</div>
<pre><code>‚Ñπ Updating posts.
‚úî 148 posts updated.  </code></pre>
<p>I also added two replace/remove functions that are a little more generic.</p>
<p>The first is <code>bd2q::remove_line()</code>, which deletes a single line from each post based on a provided regular expression. When I was messing around with converting the blog to Quarto manually, I found that the presence of the ‚Äòdraft‚Äô status in the YAML header would prevent the post from appearing on the homepage, even if was set to ‚Äòno‚Äô. As a result, you can run something like this to find and remove the lines that start with ‚Äòdraft‚Äô:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1">bd2q<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">remove_line</span>(</span>
<span id="cb13-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">q_path =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"~/new-quarto-blog"</span>,</span>
<span id="cb13-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">detect_rx =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"^draft:"</span></span>
<span id="cb13-4">)</span></code></pre></div>
</div>
<pre><code>‚Ñπ Making corrections.
‚úî Removed lines matching the regular expression '^draft:' from 128 out of 148 posts.</code></pre>
<p>That‚Äôs fine for individual lines, but what if you have a sequence of <em>consecutive</em> lines that you want to find and remove, or replace with some other text?</p>
<p>That‚Äôs what <code>bd2q::replace_lines()</code> does. Provide a vector of strings that exactly match some consecutive lines in each post, then provide a vector of strings to replace them with (or NULL to simply remove them)<sup>6</sup>.</p>
<p>This addresses another specific problem I was having. I wanted to update my custom session-info blocks at the bottom of each post so that they instead appear as <a href="https://quarto.org/docs/authoring/appendices.html">a Quarto ‚Äòappendix‚Äô</a>. That can be done like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1">old_lines <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb15-2">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"---"</span>,</span>
<span id="cb15-3">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&lt;details&gt;&lt;summary&gt;Session info&lt;/summary&gt;"</span>,</span>
<span id="cb15-4">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"```{r eval=TRUE, sessioninfo, echo=FALSE}"</span>,</span>
<span id="cb15-5">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sessioninfo::session_info()"</span>,</span>
<span id="cb15-6">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"```"</span>,</span>
<span id="cb15-7">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&lt;/details&gt;"</span></span>
<span id="cb15-8">)</span>
<span id="cb15-9"></span>
<span id="cb15-10">new_lines <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb15-11">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"## Details {.appendix}"</span>,</span>
<span id="cb15-12">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"&lt;details&gt;&lt;summary&gt;Session info&lt;/summary&gt;"</span>,</span>
<span id="cb15-13">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"```{r}"</span>,</span>
<span id="cb15-14">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#' eval = TRUE,"</span>,</span>
<span id="cb15-15">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#' echo = FALSE"</span>,</span>
<span id="cb15-16">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cat("Date:", cat(format(Sys.time(), format = "%Y-%m-%d")), "</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"); sessionInfo()'</span>,</span>
<span id="cb15-17">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"```"</span></span>
<span id="cb15-18">)</span>
<span id="cb15-19"></span>
<span id="cb15-20">bd2q<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">replace_lines</span>(</span>
<span id="cb15-21">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">q_path =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"~/new-quarto-blog"</span>,</span>
<span id="cb15-22">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">match_str =</span> old_lines,</span>
<span id="cb15-23">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replacement_str =</span> new_lines</span>
<span id="cb15-24">)</span></code></pre></div>
</div>
<pre><code>‚Ñπ Making corrections.
‚úî Removed lines matching the provided string vector from 9 out of 148 posts.   </code></pre>
<p>Haha, uhoh, I was expecting to have fixed more posts than that! Looks like I might have written my custom session-info block slightly differently in each post (maybe an extra space or empty line?), so I‚Äôll have to run the <code>bd2q::replace_lines()</code> multiple times to make sure I can replace it in each post that it appears.</p>
</section>
</section>
<section id="actually-use-the-package-pfft" class="level2">
<h2 class="anchored" data-anchor-id="actually-use-the-package-pfft">Actually use the package? Pfft!</h2>
<p>So, is {bd2q} objectively good? No.&nbsp;Does it do what I personally want it to do? Absolutely. Mostly. Yeah?</p>
<p>Of course, transferring files into a new structure is the easy part. The hard part is to see if each post will still re-render after all these years. It‚Äôs unlikely! There‚Äôs no dependency management in this blog because there was no easy easy to do it. Quarto, meanwhile, has <a href="https://quarto.org/docs/projects/code-execution.html#freeze">the ability to ‚Äòfreeze‚Äô posts</a> and <a href="https://albert-rapp.de/posts/13_quarto_blog_writing_guide/13_quarto_blog_writing_guide.html#make-posts-robust-with-renv">link each post to a {renv} lockfile</a> (thanks Albert) that captures each post‚Äôs package dependencies.</p>
<p>There are some other dependencies outside of packages though. For example, I have posts that use <a href="https://docs.ropensci.org/rtweet/">the {rtweet} package</a> to fetch tweets from Twitter, but Twitter is a garbage fire and I may never be able to fetch tweets from the API in future. I may have to just copy-paste the outputs that were created when the post was originally rendered, oh well.</p>
<p>To be clear: this is hard work. I may not be brave enough to do it any time soon. I‚Äôve set up <a href="https://github.com/matt-dray/rostrum-blog-2">a GitHub repo for ‚Äòrostrum-blog-2‚Äô</a> where I‚Äôve been experimenting with styles and structure, so if I ever get round to this task then that‚Äôs where the fireworks will be happening.</p>
<p>And hey, at worst I got more familiar with the <a href="https://fs.r-lib.org/">{fs}</a> and <a href="https://cli.r-lib.org/">{cli}</a> packages when making {bd2q}, which are for ‚Äòtidy‚Äô path handling and nice user interfaces. A convoluted way to learn!</p>
<p>But that‚Äôs what this blog is all about, amirite.</p>
</section>



<div id="quarto-appendix" class="default"><section id="environment" class="level2 appendix"><h2 class="anchored quarto-appendix-heading">Environment</h2><div class="quarto-appendix-contents">

<details>
<summary>
Session info
</summary>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Last rendered: 2023-06-29 15:25:33 CEST</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.3.1 (2023-06-16)
Platform: aarch64-apple-darwin20 (64-bit)
Running under: macOS Ventura 13.2.1

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: Europe/Zurich
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
[1] bd2q_0.0.0.9000

loaded via a namespace (and not attached):
 [1] htmlwidgets_1.6.2 compiler_4.3.1    fastmap_1.1.1     cli_3.6.1        
 [5] tools_4.3.1       htmltools_0.5.5   rstudioapi_0.14   yaml_2.3.7       
 [9] rmarkdown_2.22    knitr_1.43.1      jsonlite_1.8.5    xfun_0.39        
[13] digest_0.6.31     rlang_1.1.1       evaluate_0.21    </code></pre>
</div>
</div>
</details>


</div></section><aside id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Actually, we began this blog on WordPress in 2013. But WordPress doesn‚Äôt evaluate R code, so code outputs had to be pasted in manually. The original blog was meant to be more about general ecology, hence the name ‚Äòrostrum‚Äô, which refers to the snouty bit of an insect and also the platform a speaker talks from. Seemed like a neat pun at the time, but the joke is kinda lost on an audience that‚Äôs no longer comprised mostly of entomologists. But the audience is mostly me, so I can live with it.‚Ü©Ô∏é</p></li>
<li id="fn2"><p>Although I did use it to <a href="https://www.rostrum.blog/2022/03/15/renv-profiles/">investigate a method with {renv}</a> for managing dependencies on a post-by-post basis.‚Ü©Ô∏é</p></li>
<li id="fn3"><p>In particular, {blogdown} <a href="https://gohugo.io/">depends on Hugo</a>, a ‚Äòframework for building websites‚Äô. Quarto blogs are just‚Ä¶ built on Quarto.‚Ü©Ô∏é</p></li>
<li id="fn4"><p>Especially things like <a href="https://github.com/coatless/quarto-webr">WebR for Quarto</a> that helps you embed interactive R chunks into your posts, which <a href="https://www.rostrum.blog/2023/03/16/webr-quarto/">I wrote about recently</a>.‚Ü©Ô∏é</p></li>
<li id="fn5"><p>‚Äòbd2q‚Äô as in ‚Äò{blogdown} to Quarto‚Äô. Which is a boring name, I know.‚Ü©Ô∏é</p></li>
<li id="fn6"><p>This was actually more painful than I was hoping. There‚Äôs no easy way to match consecutive strings between vectors. In other words, try to extract the sequence <code>c("a", "b", "c")</code>, in that order, from the vector <code>c("a", "b", "d", "a", "b", "c", "d")</code>. Surely there‚Äôs an R function that will do this? Anyway, I fudged it by collapsing all the lines of a post into a single string and then finding the matching (collapsed) string provided by the user. Of course, the string will have to be ‚Äòuncollapsed‚Äô to get a string per line, so you can use <code>paste()</code> with a string provide to the <code>collapse</code> argument. But this separator will need to be a string that doesn‚Äôt appear in any of your posts, otherwise the uncollapsing process will break a line that you didn‚Äôt intend to be broken! I went with <code>///</code> by default, but the user can change this with the <code>collapse_str</code> argument in <code>bd2q::replace_lines()</code>. Sheesh.‚Ü©Ô∏é</p></li>
</ol>
</aside><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div id="quarto-reuse" class="quarto-appendix-contents"><div>CC BY-NC-SA 4.0</div></div></section></div> ]]></description>
  <category>bd2q</category>
  <category>blog-meta</category>
  <category>blogdown</category>
  <category>quarto</category>
  <category>r</category>
  <guid>https://whimsical-wisp-30974e.netlify.app/posts/2023-05-07-bd2q/index.html</guid>
  <pubDate>Sat, 06 May 2023 23:00:00 GMT</pubDate>
</item>
<item>
  <title>Matt Dray Teaches (Data) Typing</title>
  <dc:creator>Matt Dray</dc:creator>
  <link>https://whimsical-wisp-30974e.netlify.app/posts/2023-04-23-type-convert/index.html</link>
  <description><![CDATA[ 




<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://whimsical-wisp-30974e.netlify.app/posts/2023-04-23-type-convert/resources/unown.png" class="img-fluid figure-img" style="width:100.0%" alt="A crudely drawn picture of three Pok√©mon as elements of a vector being constructed using R's 'c' function. All three are the Pok√©mon called Unown, which can be found in multiple forms that represent letters of the alphabet."></p>
<figcaption class="figure-caption">Confirmed: <a href="https://bulbapedia.bulbagarden.net/wiki/Unown_(Pok%C3%A9mon)">Unown</a> is character type.<sup>1</sup></figcaption>
</figure>
</div>
<section id="tldr" class="level2">
<h2 class="anchored" data-anchor-id="tldr">tl;dr</h2>
<p>I forgot that the base R function <code>type.convert()</code> exists. Handy for ‚Äòsimplifying‚Äô all the columns of a dataframe to appropriate data types.</p>
</section>
<section id="suppression-depression" class="level2">
<h2 class="anchored" data-anchor-id="suppression-depression">Suppression depression</h2>
<p><a href="https://co-analysis.github.io/a11ytables/">{a11ytables}</a> is an R package that lets you generate publishable spreadsheets that follow the UK government‚Äôs <a href="https://analysisfunction.civilservice.gov.uk/policy-store/releasing-statistics-in-spreadsheets/">best practice guidance</a>.</p>
<p>One requirement is to replace missing values with placeholder symbols. For example, suppressed data can be replaced with the string <code>"[c]"</code> (‚Äòconfidential‚Äô).</p>
<p>Of course, R‚Äôs behaviour means it can store only one data type per column, so a numeric-type column will be automatically converted to character when you introduce at least one string value (i.e.&nbsp;something in <code>"quotes"</code>).<sup>2</sup></p>
<p>For example, this vector is type ‚Äòdouble‚Äô (i.e.&nbsp;decimals and not ‚Äòwhole-number‚Äô integers) and has the more general ‚Äònumeric‚Äô class:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">nums <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">runif</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">typeof</span>(nums); <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">class</span>(nums)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "double"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "numeric"</code></pre>
</div>
</div>
<p>The whole thing is converted to character type if you append just one character value.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">typeof</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(nums, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[c]"</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "character"</code></pre>
</div>
</div>
<p>This is known behaviour, yes, but it causes a minor annoyance in the xlsx files output from an {a11ytables} workflow: Excel puts a warning marker in the corner of any cell in a text column that contains a numeric value.<sup>3</sup></p>
<p><img src="https://whimsical-wisp-30974e.netlify.app/posts/2023-04-23-type-convert/resources/number-text.png" class="img-fluid" style="width:100.0%" alt="Screenshot of an Excel worksheet. A cell containing a number has a warning that reads 'number stored as text'."></p>
<p><a href="https://github.com/co-analysis/a11ytables/issues/93">Cat left a GitHub issue</a> related to this: columns entirely made of numbers were being marked by Excel with the ‚Äònumber in a text column‚Äô warning. In this case, it was because Cat‚Äôs suppression process resulted in <em>all</em> columns being converted to character.</p>
<p>It would be great to convert back to numeric any columns that did not receive a placeholder symbol during the wrangling process. How can you do this?</p>
</section>
<section id="type-specimen" class="level2">
<h2 class="anchored" data-anchor-id="type-specimen">Type specimen</h2>
<p>Let‚Äôs consider a demo example. First I‚Äôll attach {dplyr}, which is commonly used by stats producers in the UK government.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">suppressPackageStartupMessages</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr))</span></code></pre></div>
</div>
<p>Here‚Äôs a very simple dataframe, <code>tbl</code>, to use as a demo. Column <code>x</code> contains values that will need to be suppressed because they‚Äôre lower than 5. There are no such values in column <code>y</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1337</span>)</span>
<span id="cb7-2"></span>
<span id="cb7-3">tbl <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb7-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">id =</span> LETTERS[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>],</span>
<span id="cb7-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x  =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">runif</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>),</span>
<span id="cb7-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y  =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">runif</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb7-7">)</span>
<span id="cb7-8"></span>
<span id="cb7-9">tbl</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 √ó 3
  id        x     y
  &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt;
1 A      5.76  7.33
2 B      5.65  9.79
3 C      0.74  7.12
4 D      4.54  6.98
5 E      3.73  6.58</code></pre>
</div>
</div>
<p>So, to borrow and simplify Cat‚Äôs approach: for each numeric column in <code>tbl</code> (i.e.&nbsp;<code>x</code> and <code>y</code>), replace any value of less than 5 with the placeholder string <code>"[c]"</code>, otherwise retain the original value.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">tbl_supp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> tbl <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb9-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb9-3">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(</span>
<span id="cb9-4">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">where</span>(is.numeric),</span>
<span id="cb9-5">      \(value) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">if_else</span>(</span>
<span id="cb9-6">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">condition =</span> value <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, </span>
<span id="cb9-7">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">true      =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[c]"</span>,</span>
<span id="cb9-8">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">false     =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.character</span>(value)</span>
<span id="cb9-9">      )</span>
<span id="cb9-10">    )</span>
<span id="cb9-11">  )</span>
<span id="cb9-12"></span>
<span id="cb9-13">tbl_supp</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 √ó 3
  id    x     y    
  &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;
1 A     5.76  7.33 
2 B     5.65  9.79 
3 C     [c]   7.12 
4 D     [c]   6.98 
5 E     [c]   6.58 </code></pre>
</div>
</div>
<p>So column <code>x</code> now contains text values and has predictably been converted to character, which you can see as <code>&lt;chr&gt;</code> in the tibble header. But notice that <code>y</code> is also character type despite all the numeric values being retained.</p>
<p>This happened because the <code>if_else()</code> we used to create <code>tbl_supp</code> required the <code>true</code> and <code>false</code> arguments to resolve to the same type. The <code>false</code> argument must use <code>as.character()</code> because <code>true</code> resolves to the character value <code>"[c]"</code>.</p>
<p>Ideally we‚Äôd perform our suppression step but column <code>x</code> would end up as character and <code>y</code> as numeric. How can we achieve this?</p>
</section>
<section id="adjust-my-type" class="level2">
<h2 class="anchored" data-anchor-id="adjust-my-type">Adjust my type</h2>
<p>In this section are some methods to fix the problem by:</p>
<ol type="1">
<li>Causing yourself further brainache</li>
<li>Using a (relatively little known?) base R function</li>
<li>Doing it ‚Äòproperly‚Äô from the outset</li>
</ol>
<section id="type-1-nah" class="level3">
<h3 class="anchored" data-anchor-id="type-1-nah">Type 1: nah</h3>
<p>Of course, we could run <code>tbl_supp |&gt; mutate(y = as.numeric(y))</code> to convert that specific column back to numeric. But imagine if you have a lot more columns and you can‚Äôt be sure which ones need to be converted.</p>
<p>Maybe you could apply <code>as.numeric()</code> across <em>all</em> columns? Columns of numbers stored as text will then be converted entirely to numeric:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"3"</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1 2 3</code></pre>
</div>
</div>
<p>But this causes a problem for character columns that contain text, like our placeholder symbol:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[c]"</span>))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  1 NA</code></pre>
</div>
</div>
<p>So <code>"1"</code> becomes <code>1</code>, but we‚Äôre warned that <code>"[c]"</code> has been converted to <code>NA</code> (well, <code>NA_real_</code>, which is the numeric form of <code>NA</code>).</p>
<p>We could do something convoluted, like see which columns didn‚Äôt gain <code>NA</code> values and should be retained as numeric. But that‚Äôs bonkers. This approach ultimately makes things worse because we‚Äôve actually lost information!</p>
<p>Really we want to check each column to see if it contains numbers only and then convert it to numeric. How?</p>
</section>
<section id="type-2-better" class="level3">
<h3 class="anchored" data-anchor-id="type-2-better">Type 2: better</h3>
<p>There‚Äôs a handy base R function that I had forgotten about: <code>type.convert()</code>.</p>
<p>It takes a vector and, in turn, tries to coerce it to each data type. The process stops when coercion occurs without error. As the help file (<code>?type.convert</code>) puts it:</p>
<blockquote class="blockquote">
<p>Given a vector, the function attempts to convert it to logical, integer, numeric or complex, and when additionally as.is = FALSE‚Ä¶ converts a character vector to factor. The first type that can accept all the non-missing values is chosen.</p>
</blockquote>
<p>And handily:</p>
<blockquote class="blockquote">
<p>When the data object x is a data frame or list, the function is called recursively for each column or list element.</p>
</blockquote>
<p>So we can pass our entire dataframe to <code>type.convert()</code> and it‚Äôll check them all for us:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1">tbl_supp_conv <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">type.convert</span>(tbl_supp, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">as.is =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb16-2"></span>
<span id="cb16-3">tbl_supp_conv</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 √ó 3
  id    x         y
  &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt;
1 A     5.76   7.33
2 B     5.65   9.79
3 C     [c]    7.12
4 D     [c]    6.98
5 E     [c]    6.58</code></pre>
</div>
</div>
<p>As we wanted, our character column <code>y</code> has become numeric type (<code>&lt;dbl&gt;</code>) while <code>x</code> remains as character. Neato.</p>
</section>
<section id="type-3-betterer" class="level3">
<h3 class="anchored" data-anchor-id="type-3-betterer">Type 3: betterer</h3>
<p>There are probably better approaches to this problem from the outset, rather than after-the-fact application of <code>type.convert()</code>.</p>
<p>As <a href="https://www.hiddenelephants.co.uk/">Tim</a> has pointed out, you could actually just use the base R form of <code>ifelse()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1">tbl <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb18-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb18-3">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(</span>
<span id="cb18-4">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">where</span>(is.numeric),</span>
<span id="cb18-5">      \(value) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(</span>
<span id="cb18-6">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">test =</span> value <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, </span>
<span id="cb18-7">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yes  =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[c]"</span>,</span>
<span id="cb18-8">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">no   =</span> value</span>
<span id="cb18-9">      )</span>
<span id="cb18-10">    )</span>
<span id="cb18-11">  )</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 √ó 3
  id    x         y
  &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt;
1 A     5.76   7.33
2 B     5.65   9.79
3 C     [c]    7.12
4 D     [c]    6.98
5 E     [c]    6.58</code></pre>
</div>
</div>
<p>I think people use <code>dplyr::if_else()</code> for (a) consistency if they‚Äôre already using tidyverse in the script and (b) it‚Äôs ‚Äòstrictness‚Äô compared to <code>ifelse()</code>. <code>if_else()</code> will force you to declare the <code>true</code> and <code>false</code> arguments so they resolve to the same type, whereas <code>ifelse()</code> will silently force type coercion, which may be undesirable in some cases.</p>
<p>Another method would be to iterate the suppression over only the columns that need it. For example, you could do that with a simple <code>for</code> and <code>if</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1">cols_numeric <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(tbl, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">where</span>(is.numeric)))</span>
<span id="cb20-2"></span>
<span id="cb20-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (col <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> cols_numeric) {</span>
<span id="cb20-4">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">any</span>(tbl[col] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)) {</span>
<span id="cb20-5">    tbl[col] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(</span>
<span id="cb20-6">      tbl[col] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,</span>
<span id="cb20-7">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"[c]"</span>,</span>
<span id="cb20-8">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.character</span>(tbl[[col]])</span>
<span id="cb20-9">    )</span>
<span id="cb20-10">  }</span>
<span id="cb20-11">}</span>
<span id="cb20-12"></span>
<span id="cb20-13">tbl</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 √ó 3
  id    x         y
  &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt;
1 A     5.76   7.33
2 B     5.65   9.79
3 C     [c]    7.12
4 D     [c]    6.98
5 E     [c]    6.58</code></pre>
</div>
</div>
<p>This reads as ‚Äòfor each numeric column that contains at least one value less than 5, replace those values with the placeholder symbol <code>"[c]"</code>.‚Äô</p>
</section>
</section>
<section id="preach-to-the-converted-types" class="level2">
<h2 class="anchored" data-anchor-id="preach-to-the-converted-types">Preach to the converted types</h2>
<p>It‚Äôs almost like this post could have just been a tweet saying ‚ÄòüòÆ yo, <code>type.convert()</code> is ü™Ñmagicü™Ñ y‚Äôall‚Äô. But this post is now a handy reference in case anyone has the same problems with Excel‚Äôs handling of {a11ytables} outputs in future.</p>
<p>Also I needed to hit my pun quota for the month.<sup>4</sup></p>
</section>



<div id="quarto-appendix" class="default"><section id="environment" class="level2 appendix"><h2 class="anchored quarto-appendix-heading">Environment</h2><div class="quarto-appendix-contents">

<details>
<summary>
Session info
</summary>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Last rendered: 2023-07-17 18:06:53 BST</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.3.1 (2023-06-16)
Platform: aarch64-apple-darwin20 (64-bit)
Running under: macOS Ventura 13.2.1

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: Europe/London
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
[1] dplyr_1.1.2

loaded via a namespace (and not attached):
 [1] digest_0.6.31     utf8_1.2.3        R6_2.5.1          fastmap_1.1.1    
 [5] tidyselect_1.2.0  xfun_0.39         magrittr_2.0.3    glue_1.6.2       
 [9] tibble_3.2.1      knitr_1.43.1      pkgconfig_2.0.3   htmltools_0.5.5  
[13] generics_0.1.3    rmarkdown_2.23    lifecycle_1.0.3   cli_3.6.1        
[17] fansi_1.0.4       vctrs_0.6.3       withr_2.5.0       compiler_4.3.1   
[21] rstudioapi_0.15.0 tools_4.3.1       pillar_1.9.0      evaluate_0.21    
[25] yaml_2.3.7        rlang_1.1.1       jsonlite_1.8.7    htmlwidgets_1.6.2</code></pre>
</div>
</div>
</details>


</div></section><aside id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>This is a Pok√©mon joke. I could have gone with <a href="https://bulbapedia.bulbagarden.net/wiki/Type:_Null_(Pok%C3%A9mon)">Type: Null</a>, but it‚Äôs too hard to draw.‚Ü©Ô∏é</p></li>
<li id="fn2"><p>There‚Äôs a sort of ‚Äòcoercion hierarchy‚Äô in R. The order is like logical &gt; integer &gt; numeric &gt; character, where the latter are ‚Äòdominant‚Äô to those prior (massive oversimplification). As an aside, this results in some oddities to the untrained eye: <code>sum(2, TRUE)</code> resolves to <code>3</code>, because <code>TRUE</code> is coerced to the numeric value <code>1</code> (<code>FALSE</code> is <code>0</code>) and so we get 2 + 1 = 3.‚Ü©Ô∏é</p></li>
<li id="fn3"><p>You can dismiss these warning markers in the Excel GUI, but I don‚Äôt think it‚Äôs possible to suppress these markers programmatically and proactively in {a11ytables}. Note also that {a11ytables} cheats a bit here for sake of presentation. The <code>generate_workbook()</code> function guesses that the column was intended to be numeric and adds style information to right-align the values in the output xlsx, which is how numeric values are normally treated in Excel.‚Ü©Ô∏é</p></li>
<li id="fn4"><p>Turns out there‚Äôs literally such a thing as <a href="https://en.wikipedia.org/wiki/Type_punning">type punning</a>.‚Ü©Ô∏é</p></li>
</ol>
</aside><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div id="quarto-reuse" class="quarto-appendix-contents"><div>CC BY-NC-SA 4.0</div></div></section></div> ]]></description>
  <category>a11ytables</category>
  <category>base</category>
  <category>ms-office</category>
  <category>r</category>
  <guid>https://whimsical-wisp-30974e.netlify.app/posts/2023-04-23-type-convert/index.html</guid>
  <pubDate>Sat, 22 Apr 2023 23:00:00 GMT</pubDate>
</item>
<item>
  <title>R is a game engine, fight me</title>
  <dc:creator>Matt Dray</dc:creator>
  <link>https://whimsical-wisp-30974e.netlify.app/posts/2023-04-02-splendid-r-games/index.html</link>
  <description><![CDATA[ 




<p><img src="https://whimsical-wisp-30974e.netlify.app/posts/2023-04-02-splendid-r-games/resources/snes-r.png" class="img-fluid" style="width:100.0%" alt="A crudely drawn image of the buttons from a Nintendo SNES controller, but the A, B, X and Y labels have all been changed to R."></p>
<section id="tldr" class="level2">
<h2 class="anchored" data-anchor-id="tldr">tl;dr</h2>
<p>R is ‚Äò<a href="https://www.r-project.org/">a free software environment for statistical computing and graphics</a>‚Äô. Ahahaha, no it‚Äôs not, it‚Äôs a game engine. I‚Äôve created <a href="https://github.com/matt-dray/awesome-r-games">a ‚Äòsplendid‚Äô list of games</a> you can play‚Äîwritten in R‚Äîto prove it. <a href="https://github.com/matt-dray/splendid-r-games/issues">Help expand it</a>.</p>
</section>
<section id="stats-only" class="level2">
<h2 class="anchored" data-anchor-id="stats-only">Stats only!</h2>
<p>R is not a general, multi-purpose programming language. It was written to do statistical analysis and make charts. You are literally not allowed to do anything else with it. You should use &lt;LANGUAGE&gt; instead, which is much more suited to your specific use case. R is a joke language for nerds.</p>
<p>You should not read beyond this point if you think, quite rightly, that mirth and frivolity are unsuited to an R session.</p>
</section>
<section id="stats-only-1" class="level2">
<h2 class="anchored" data-anchor-id="stats-only-1">Stats only?</h2>
<p>Unity. Unreal. GameMaker. Godot. All of these videogame engines are now obsolete.</p>
<p>It is R‚Äîhumble R!‚Äîthat represents the future of gaming.</p>
<p>To prove it, I‚Äôve created <a href="https://github.com/matt-dray/awesome-r-games">a list of ‚Äòsplendid R games‚Äô in a GitHub repo</a><sup>1</sup> that you are welcome to contribute to.<sup>2</sup></p>
<p>Yes, R can be used for fun. Do not tell R Core.</p>
</section>
<section id="wait-hes-serious" class="level2">
<h2 class="anchored" data-anchor-id="wait-hes-serious">Wait, he‚Äôs serious?</h2>
<p>I think there‚Äôs three kinds of ‚Äòplatform‚Äô for games written in R:</p>
<ol type="1">
<li>For the console</li>
<li>In Shiny</li>
<li>Ported</li>
</ol>
<p>Games played in the console are pretty straightforward and probably most common. You can run some code, or a function from a package, to launch some code in the R console that you can interact with. A simple option for this might involve use of <code>readline()</code> to receive user input, for example, like <a href="https://www.giorasimchoni.com/">Giora Simchoni</a>‚Äôs excellent text-based puzzler, <a href="https://github.com/gsimchoni/CastleOfR">Castle of R</a>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://whimsical-wisp-30974e.netlify.app/posts/2023-04-02-splendid-r-games/resources/castle.png" class="img-fluid figure-img" style="width:100.0%" alt="Screenshot of R running in the terminal. A text interface asks the user to identify their skill in R. The user has typed option '4', which corresponds to the text 'what is R?'. The resulting text says 'welcome to the Castle of R' and explains its purpose."></p>
<figcaption class="figure-caption">Giora‚Äôs Castle of R running in the terminal.</figcaption>
</figure>
</div>
<p>Shiny can give you a little more flexibility when it comes to graphics and user input, at the expense of needing to host the app and maybe some extra JavaScript skills. A great example of this is <a href="https://www.pedrocsilva.com/">Pedro Silva</a>‚Äôs winning entry (<a href="https://sparktuga.shinyapps.io/ShinyDecisions/">app</a>, <a href="https://github.com/pedrocoutinhosilva/shiny.decisions">source</a>) to <a href="https://posit.co/blog/winners-of-the-2nd-shiny-contest/">the Posit Shiny contest in 2020</a>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://whimsical-wisp-30974e.netlify.app/posts/2023-04-02-splendid-r-games/resources/decisions.png" class="img-fluid figure-img" style="width:100.0%" alt="A screenshot of a game that shows a world map with face, building and tree emojis on it. There are meters labelled 'wealth', 'opinion' and 'environment' and another with a halo on one end and devil horns the other. Text at the bottom says 'swipe left or right on the card to start'."></p>
<figcaption class="figure-caption">A still from Pedro‚Äôs Shiny Decisions app.</figcaption>
</figure>
</div>
<p>The third category is a little more boundary-pushing. Imagine if R was powerful enough to let you port existing games. Well, surprise, ya boi <a href="https://coolbutuseless.github.io/">Mike Cheng</a> (aka coolbutuseless) has pushed hard on expanding the capabilities of R to run fast enough and with realtime user input,<sup>3</sup> porting the classic <a href="https://en.wikipedia.org/wiki/Another_World_(video_game)"><em>Another World</em></a> (1991) to R, which was showcased at 2022‚Äôs Posit conference (<a href="https://github.com/coolbutuseless/anotherworld">source</a>, <a href="https://www.youtube.com/watch?v=LPotWAJnE_s">video</a>, <a href="https://coolbutuseless.github.io/2022/07/29/anotherworld-game-written-playable-in-r-with-nara-and-eventloop/">blog</a>).</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://whimsical-wisp-30974e.netlify.app/posts/2023-04-02-splendid-r-games/resources/another-world.png" class="img-fluid figure-img" style="width:100.0%" alt="A screenshot of the game with the main character apparently waving to a shadowy silhouette in the foreground. The overalid title says 'moonshot' and text at the bottom is a quote by Mike Cheng saying 'i will commit myself to achieving the goal, before the year is out, of writing and playing a videogame in R'."></p>
<figcaption class="figure-caption">A still from Mike‚Äôs rstudio::conf(2022) presentation, featuring Another World.</figcaption>
</figure>
</div>
<p>Of course, within these ‚Äòplatforms‚Äô are genres like word games, arcade games, puzzle games, etc. Will you be the first to create an MMORPG (a massively-multiplayer online R-powered game)?</p>
</section>
<section id="i-am-an-indie-game-dev-now" class="level2">
<h2 class="anchored" data-anchor-id="i-am-an-indie-game-dev-now">I am an indie game dev now</h2>
<p>I‚Äôve always been interested in how videogames are coded,<sup>4</sup> wishing that I could do the same myself. Of course I could simply learn ‚Äòreal‚Äô programming languages.</p>
<p>Except that‚Äôs blasphemy. Of course I‚Äôd rather break my own mind and spirit in an attempt to make R achieve 0.1% of what might be possible in P*thon.</p>
<p>Case in point, I‚Äôve made a few R packages containing some little toys (in order of gooddest to baddest):</p>
<ul>
<li>{r.oguelike} (<a href="https://github.com/matt-dray/r.oguelike">source</a>, <a href="https://www.rostrum.blog/tags/r.oguelike/">blogs</a>) for a procedural-dungeon explorer with enemy pathfinding and inventory</li>
<li>{tamRgo} (<a href="https://github.com/matt-dray/tamRgo">source</a>, <a href="https://github.com/matt-dray/tamRgo">blog</a>) for a cyber pet in your R console that persists between sessions</li>
<li>{safar6} (<a href="https://github.com/matt-dray/safar6">source</a>, <a href="https://github.com/matt-dray/safar6">blog</a>) for a text-based re-make of the Safari Zone from the first generation of Pok√©mon games</li>
<li>{ActionSquirrel} (<a href="https://www.rostrum.blog/2021/10/03/squirrel/">source</a>, <a href="https://github.com/matt-dray/ActionSquirrel">blog</a>) for a tile-based, turn-based minigame in the R console</li>
<li>{hokey} (<a href="https://github.com/matt-dray/hokey">source</a>, <a href="https://www.rostrum.blog/2022/01/19/keypress/">blog</a>) for minigames that use <a href="https://github.com/gaborcsardi/keypress">direct keypress inputs with {keypress}</a></li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://whimsical-wisp-30974e.netlify.app/posts/2023-04-02-splendid-r-games/resources/kevin.png" class="img-fluid figure-img" style="width:100.0%" alt="Screenshot of R running in the terminal. The get_stats and see_pet functions from the tamRgo package have been run. The first prints some output showing characteristics and status of a cyber pet. The latter prints an image of the pet to the browser. The pet is called Kevin and is 139 in age. It appears to be unalive."></p>
<figcaption class="figure-caption">Hint when playing {tamRgo}: do not forget about your pet for 138 days. RIP Kevin XVIII.</figcaption>
</figure>
</div>
<p>I‚Äôve got something in the pipeline that involves extremely rudimentary physics in the R console. Wow! For release in 2023 (because game launches never go wrong).</p>
</section>
<section id="ready-player-2" class="level2">
<h2 class="anchored" data-anchor-id="ready-player-2">Ready Player 2</h2>
<p>The splendid list must be missing a bunch of games. Please leave an issue or pull request <a href="https://github.com/matt-dray/splendid-r-games">in the splendid-r-games repo</a> to add more examples.</p>
<p>Next stop: letting people run R games in the browser without an installed copy of R. This is already possible with a service like <a href="https://mybinder.org/">Binder</a>, which can spin up an instance of RStudio with packages pre-installed <a href="https://github.com/matt-dray/play-r.oguelike">I did this for {r.oguelike}</a>).</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://whimsical-wisp-30974e.netlify.app/posts/2023-04-02-splendid-r-games/resources/mobile-r.oguelike.png" class="img-fluid figure-img" style="width:100.0%" alt="RStudio running a browser on a mobile phone playing the tile-based game from the r.oguelike package."></p>
<figcaption class="figure-caption">Just like <a href="https://en.wikipedia.org/wiki/N-Gage_(device)">the Nokia N-Gage</a>, amirite?</figcaption>
</figure>
</div>
<p>But soon you might be able to <a href="https://github.com/r-wasm/webr">use WebR to play games in the browser</a> without even spinning up RStudio, ooh. So look out for an R version of <a href="https://itch.io/">itch.io</a> in future, lol.</p>
</section>



<div id="quarto-appendix" class="default"><section id="environment" class="level2 appendix"><h2 class="anchored quarto-appendix-heading">Environment</h2><div class="quarto-appendix-contents">

<details>
<summary>
Session info
</summary>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Last rendered: 2023-07-02 12:50:56 BST</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.3.1 (2023-06-16)
Platform: aarch64-apple-darwin20 (64-bit)
Running under: macOS Ventura 13.2.1

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: Europe/London
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

loaded via a namespace (and not attached):
 [1] htmlwidgets_1.6.2 compiler_4.3.1    fastmap_1.1.1     cli_3.6.1        
 [5] tools_4.3.1       htmltools_0.5.5   rstudioapi_0.14   yaml_2.3.7       
 [9] rmarkdown_2.22    knitr_1.43.1      jsonlite_1.8.5    xfun_0.39        
[13] digest_0.6.31     rlang_1.1.1       evaluate_0.21    </code></pre>
</div>
</div>
</details>


</div></section><aside id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>I originally labelled the GitHub repo as <a href="https://github.com/sindresorhus/awesome">an ‚Äòawesome‚Äô repo</a>, which I later learned has <a href="https://github.com/matt-dray/splendid-r-games/issues/4#issuecomment-1205015274">a very specific meaning</a>. You might have seen awesome lists before, like the <a href="https://github.com/mcanouil/awesome-quarto">awesome-quarto repo</a> by <a href="https://github.com/mcanouil">Micka√´l</a>, or the new <a href="https://github.com/nanxstats/awesome-webr">awesome-webr list</a> by <a href="https://nanx.me/">Nan Xiao</a>. ‚ÄòSplendid‚Äô is much more of a Bri‚Äôish word than ‚Äòawesome‚Äô, so it feels more natural anyway.‚Ü©Ô∏é</p></li>
<li id="fn2"><p>Note that I have carefully released this post just after April fool‚Äôs day, which means I am super, super serious. As usual.‚Ü©Ô∏é</p></li>
<li id="fn3"><p>See the <a href="https://coolbutuseless.github.io/package/nara/index.html">{nara}</a> and <a href="https://coolbutuseless.github.io/package/eventloop/index.html">{eventloop}</a> packages in particular.‚Ü©Ô∏é</p></li>
<li id="fn4"><p>I like YouTube devlogs by folks like <a href="https://www.youtube.com/c/SebastianLague">Seb Lague</a>, <a href="https://www.youtube.com/@ThinMatrix">ThinMatrix</a>, <a href="https://www.youtube.com/@SquidGodDev">SquidGod</a>, <a href="https://www.youtube.com/c/jonastyroller">Jonas</a>, <a href="https://www.youtube.com/@Tantandev">TanTan</a> and others. R can never achieve what they‚Äôre up to, but I like listening through the logic of what they‚Äôre doing.‚Ü©Ô∏é</p></li>
</ol>
</aside><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div id="quarto-reuse" class="quarto-appendix-contents"><div>CC BY-NC-SA 4.0</div></div></section></div> ]]></description>
  <category>r</category>
  <category>shiny</category>
  <category>videogames</category>
  <guid>https://whimsical-wisp-30974e.netlify.app/posts/2023-04-02-splendid-r-games/index.html</guid>
  <pubDate>Sat, 01 Apr 2023 23:00:00 GMT</pubDate>
</item>
<item>
  <title>Playgrounds with WebR and Quarto</title>
  <dc:creator>Matt Dray</dc:creator>
  <link>https://whimsical-wisp-30974e.netlify.app/posts/2023-03-16-webr-quarto/index.html</link>
  <description><![CDATA[ 




<p><img src="https://whimsical-wisp-30974e.netlify.app/posts/2023-03-16-webr-quarto/resources/webr-quarto-test.png" class="img-fluid" style="width:100.0%" alt="A screenshot of a webpage that has an embedded R code block. Some text asks the user to adjust the code and then click a button that says 'run code'. A shocked Pikachu appears in the corner."></p>
<section id="tldr" class="level2">
<h2 class="anchored" data-anchor-id="tldr">tl;dr</h2>
<p><a href="https://docs.r-wasm.org/webr/latest/">WebR</a> lets you run R in the browser(!). Now you can <a href="https://github.com/coatless/quarto-webr">make WebR chunks in Quarto</a> that render to editable, executable blocks(!).</p>
</section>
<section id="sliding-into-tedium" class="level2">
<h2 class="anchored" data-anchor-id="sliding-into-tedium">Sliding into tedium</h2>
<p>I wrote recently <a href="https://www.rostrum.blog/2023/03/03/getparsedata/">a simple introduction to how R parses code</a>. I provided a function that I said the reader could go away and run themselves.</p>
<p>As in‚Ä¶ copy-paste it into an instance of R running on their machine. Gross.</p>
<p>Wouldn‚Äôt it be better if people could just tinker with the code right there in the post? This kind of ‚Äòplayground‚Äô could be great for explaining concepts and teaching.<sup>1</sup></p>
</section>
<section id="i-seesaw-a-solution" class="level2">
<h2 class="anchored" data-anchor-id="i-seesaw-a-solution">I seesaw a solution</h2>
<p>WebR lets you run R in the browser. Read that again! This is a landmark piece of work from George Stagg and Lionel Henry.</p>
<p>I won‚Äôt go into technicals and limitations here. For more information, see:</p>
<ul>
<li><a href="https://docs.r-wasm.org/webr/latest/">the docs</a></li>
<li><a href="https://www.tidyverse.org/blog/2023/03/webr-0-1-0/">the v0.1 launch post</a></li>
<li><a href="https://github.com/nanxstats/awesome-webr">an ‚Äòawesome‚Äô list of resources</a></li>
</ul>
<p>Crucially for my needs, you can now <a href="https://github.com/coatless/quarto-webr">run WebR chunks in a Quarto document</a>, thanks to James J Balamuta. This renders interactive blocks of R code that the reader can adjust and execute with button-click:</p>
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><img src="https://whimsical-wisp-30974e.netlify.app/posts/2023-03-16-webr-quarto/resources/webr-demo.gif" class="img-fluid figure-img" style="width:40.0%" alt="Animated gif showing a code block with R code inside that sets the value of 'x' to 'world' then pastes it together with the string 'hello'. A 'run code' button is clicked and the string 'hello world' is printed. The word 'hello' is then changed to 'ahoy' and the code is re-run and the printout changes to 'ahoy world'."></p>
<figcaption class="figure-caption">Beware: this is a gif, not an embedded demo!</figcaption>
</figure>
</div>
<p>Check out James‚Äôs <a href="https://github.com/coatless/quarto-webr">coatless/quarto-webr</a> GitHub repo for the source. There‚Äôs also <a href="https://rd.thecoatlessprofessor.com/webR-quarto-demos/webr-quarto-html-demo.html">a live demo</a> and <a href="https://github.com/coatless-r-n-d/webR-quarto-demos/blob/main/webr-quarto-html-demo.qmd">its source</a>.</p>
</section>
<section id="swinging-into-action" class="level2">
<h2 class="anchored" data-anchor-id="swinging-into-action">Swinging into action</h2>
<p>To have a go yourself, do follow <a href="https://github.com/coatless/quarto-webr">the setup steps</a> in James‚Äôs quarto-webr README and look at <a href="https://github.com/coatless-r-n-d/webR-quarto-demos/blob/main/webr-quarto-html-demo.qmd">the source of his demo</a>.</p>
<p>Ultimately you can:</p>
<ol type="1">
<li>Install the extension to your project folder by running <code>quarto add coatless/quarto-webr</code> in the terminal</li>
<li>Set <code>filter: webr</code> in the YAML of your qmd file<sup>2</sup></li>
<li>Write code chunks in the qmd using the <code>{webr}</code> engine</li>
</ol>
<p>This made it straightforward to prepare a little Quarto doc with chunks powered by the ‚Äòwebr‚Äô engine, which I deployed to the web via <a href="https://www.netlify.com/">Netlify</a>.<sup>3</sup></p>
<p>You can <a href="https://webr-parse-test.netlify.app/">visit that live page</a> or see the underlying <a href="https://github.com/matt-dray/webr-parse-test">source on GitHub</a>.<sup>4</sup></p>
<p>So now you <em>can</em> tinker with the example I gave in the original blogpost about parsing R code. Unfortunately I can‚Äôt add this directly to the post, since this blog is not made with Quarto.</p>
</section>
<section id="a-blog-platform-merry-go-round" class="level2">
<h2 class="anchored" data-anchor-id="a-blog-platform-merry-go-round">A blog-platform merry-go-round</h2>
<p>I‚Äôve written this quick demo and post because I was excited about what George &amp; Lionel and James have put together. There‚Äôs so many system-independent applications of this approach that could help with teaching and learning, or explaining simple ideas in a blog post.</p>
<p>In fact, this blog may eventually switch from {blogdown} to Quarto to take advantage of WebR. It‚Äôll be a pain to convert old posts, but luckily I already missed the earlier {blogdown}-to-{distill} bandwagon, lol.<sup>5</sup></p>
</section>



<div id="quarto-appendix" class="default"><section id="environment" class="level2 appendix"><h2 class="anchored quarto-appendix-heading">Environment</h2><div class="quarto-appendix-contents">

<details>
<summary>
Session info
</summary>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Last rendered: 2023-07-21 18:39:33 BST</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.3.1 (2023-06-16)
Platform: aarch64-apple-darwin20 (64-bit)
Running under: macOS Ventura 13.2.1

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: Europe/London
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

loaded via a namespace (and not attached):
 [1] htmlwidgets_1.6.2 compiler_4.3.1    fastmap_1.1.1     cli_3.6.1        
 [5] tools_4.3.1       htmltools_0.5.5   rstudioapi_0.15.0 yaml_2.3.7       
 [9] rmarkdown_2.23    knitr_1.43.1      jsonlite_1.8.7    xfun_0.39        
[13] digest_0.6.33     rlang_1.1.1       evaluate_0.21    </code></pre>
</div>
</div>
</details>


</div></section><aside id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>A nice example of this in a teaching context is W3 Schools, who have a <a href="https://www.w3schools.com/html/tryit.asp?filename=tryhtml_intro">‚ÄòTry It Yourself‚Äô</a> space that lets you take code from the lessons and tinker with it yourself in the browser.‚Ü©Ô∏é</p></li>
<li id="fn2"><p>Set also <code>engine: knitr</code> in the YAML to use {knitr} instead of Jupyter to handle the conversion. You can add <code>format: html</code> to ensure that the output is rendered to HTML.‚Ü©Ô∏é</p></li>
<li id="fn3"><p>Self-deployment and Netlify are viable for now, GitHub Pages is coming later. Netlify is how this blog is deployed.‚Ü©Ô∏é</p></li>
<li id="fn4"><p>Originally I tried to embed the Quarto demo in an iframe, but WebR failed to load inside it when the blog was rendered. That‚Äôs interesting.‚Ü©Ô∏é</p></li>
<li id="fn5"><p>But came close when I thought I‚Äôd found <a href="https://www.rostrum.blog/2022/03/15/renv-profiles/">a system for making individual posts reproducible</a>.‚Ü©Ô∏é</p></li>
</ol>
</aside><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div id="quarto-reuse" class="quarto-appendix-contents"><div>CC BY-NC-SA 4.0</div></div></section></div> ]]></description>
  <category>quarto</category>
  <category>r</category>
  <category>webr</category>
  <guid>https://whimsical-wisp-30974e.netlify.app/posts/2023-03-16-webr-quarto/index.html</guid>
  <pubDate>Thu, 16 Mar 2023 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Fun and learning. In a dungeon!</title>
  <dc:creator>Matt Dray</dc:creator>
  <link>https://whimsical-wisp-30974e.netlify.app/posts/2023-03-15-in-a-dungeon/index.html</link>
  <description><![CDATA[ 




<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://whimsical-wisp-30974e.netlify.app/posts/2023-03-15-in-a-dungeon/resources/mobile-r.oguelike.png" class="img-fluid figure-img" style="width:100.0%" alt="RStudio running a browser on a mobile phone playing the tile-based game from the r.oguelike package."></p>
<figcaption class="figure-caption">Learn hard and you too can be a mobile gamedev like me.</figcaption>
</figure>
</div>
<section id="tldr" class="level2">
<h2 class="anchored" data-anchor-id="tldr">tl;dr</h2>
<p>Today I spoke at a public sector<sup>1</sup> event for data scientists<sup>2</sup>. I said that learning is best when focused into little projects that are fun.</p>
</section>
<section id="to-the-point" class="level2">
<h2 class="anchored" data-anchor-id="to-the-point">To the point</h2>
<p>The abstract sums it up, obviously:</p>
<blockquote class="blockquote">
<p>Ever done a technical training module and then immediately forgot what you learnt? Do you sometimes feel like you‚Äôre ticking boxes instead of actually developing your skills? Yeah, me too. Luckily, more active styles of learning are available. Maybe you can try working on a small, focused project where you can make mistakes and have fun. I‚Äôve had success with this and, as a bonus, accidentally learnt more than I had planned to. I‚Äôll give you an example of my experience and some ideas for how you might be able to do it yourself. The talk will involve a detour to an underground cave, but you won‚Äôt need any extra equipment.<sup>3</sup></p>
</blockquote>
<p>Yes, a cheeky teaser there to pique the interest. But everyone came to my talk anyway because it was the only one at that timeslot.</p>
<p>You can just look at the slides below if you want (<a href="https://matt-dray.github.io/in-a-dungeon">direct link</a>, <a href="https://github.com/matt-dray/in-a-dungeon">source</a>). Press ‚Äòs‚Äô to pop out the speaker notes.</p>
<div class="cell">
<div class="cell-output-display">
<div class="shareagain" style="min-width:300px;margin:1em auto;" data-exeternal="1">
<iframe src="https://matt-dray.github.io/in-a-dungeon" width="1600" height="900" style="border:none;" loading="lazy" allowfullscreen=""></iframe>
<script>fitvids('.shareagain', {players: 'iframe'});</script>
</div>
</div>
</div>
<p>These were made with <a href="https://quarto.org/docs/presentations/revealjs/">Revealjs via Quarto</a>, of course.</p>
</section>
<section id="on-my-soapbox" class="level2">
<h2 class="anchored" data-anchor-id="on-my-soapbox">On my soapbox</h2>
<p>So what incredible insight did I bring to the event?</p>
<p>Basically, I think ‚Äòmodule-based‚Äô learning‚Äîoften passive video walkthroughs with comprehension exercises‚Äîare too generic and I usually struggle to remember anything from them.</p>
<p>I think ‚Äòproject-based‚Äô learning is preferable. Think about what you actually want to learn and develop a small-scope, discrete project around it. Make the subject matter fun. Fail meaningfully by be being open, recording what you‚Äôve found, and involving your community.</p>
<p>My contrived soundbite is that module-based is done <em>to</em> you and project-based is done <em>by</em> you.</p>
<p>Is this a new thought technology? No.&nbsp;Is it always true and applicable to everyone in every conceivable scenario and with every learning need? No.&nbsp;What‚Äôs my expertise? None, really. I‚Äôve just spent a long time in lots of different departments and I can tell you what has worked for me<sup>4</sup> as someone who entered the public sector with little computing or coding ability.</p>
<p>Am I all too aware of how self-indulgent this all sounds? Yes. Did I need a whole talk to explain this? No, probably not. I‚Äôm happy if just one person stops to think about this next time they want to learn something. I‚Äôm also content if one person panicked slightly when they realised that R is a game engine now.</p>
</section>



<div id="quarto-appendix" class="default"><section id="environment" class="level2 appendix"><h2 class="anchored quarto-appendix-heading">Environment</h2><div class="quarto-appendix-contents">

<details>
<summary>
Session info
</summary>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Last rendered: 2023-07-06 19:26:56 BST</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.3.1 (2023-06-16)
Platform: aarch64-apple-darwin20 (64-bit)
Running under: macOS Ventura 13.2.1

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: Europe/London
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

loaded via a namespace (and not attached):
 [1] htmlwidgets_1.6.2   compiler_4.3.1      fastmap_1.1.1      
 [4] cli_3.6.1           tools_4.3.1         htmltools_0.5.5    
 [7] xaringanExtra_0.7.0 rstudioapi_0.14     yaml_2.3.7         
[10] rmarkdown_2.23      knitr_1.43.1        jsonlite_1.8.7     
[13] xfun_0.39           digest_0.6.31       rlang_1.1.1        
[16] evaluate_0.21      </code></pre>
</div>
</div>
</details>


</div></section><aside id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>On the same day as train and public sector strikes, oof.‚Ü©Ô∏é</p></li>
<li id="fn2"><p>I‚Äôm becoming more convinced that I don‚Äôt know what ‚Äòdata scientist‚Äô means anymore. ‚ÄòOld man yells at cloud (computing)‚Äô, etc.‚Ü©Ô∏é</p></li>
<li id="fn3"><p>A reference of, course, to my little toy <a href="https://github.com/matt-dray/r.oguelike">{r.oguelike}</a> project. This is an R package I wrote to achieve some learning goals and also to have some fun; it contains a novelty tile- and turn-based game that the player interacts with in the console. This also fit the themes of the conference‚Äîconnectivity and patterns‚Äîbecause it contains <a href="https://www.rostrum.blog/2022/05/01/dungeon/">a procedural dungeon generator</a> and <a href="https://www.rostrum.blog/2022/06/10/basic-search/">enemy pathfinding</a>.‚Ü©Ô∏é</p></li>
<li id="fn4"><p>Would‚Äôve been smarter to bring, y‚Äôknow, actual evidence rather than anecdotes to a data science conference, eh?‚Ü©Ô∏é</p></li>
</ol>
</aside><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div id="quarto-reuse" class="quarto-appendix-contents"><div>CC BY-NC-SA 4.0</div></div></section></div> ]]></description>
  <category>event</category>
  <category>r</category>
  <category>r.oguelike</category>
  <category>talk</category>
  <guid>https://whimsical-wisp-30974e.netlify.app/posts/2023-03-15-in-a-dungeon/index.html</guid>
  <pubDate>Wed, 15 Mar 2023 00:00:00 GMT</pubDate>
</item>
<item>
  <title>I can‚Äôt be parsed, mate</title>
  <dc:creator>Matt Dray</dc:creator>
  <link>https://whimsical-wisp-30974e.netlify.app/posts/2023-03-03-getparsedata/index.html</link>
  <description><![CDATA[ 




<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://whimsical-wisp-30974e.netlify.app/posts/2023-03-03-getparsedata/resources/handegg.png" class="img-fluid figure-img" style="width:100.0%" alt="An American football quarterback about to pass the ball. He has the R logo on his shirt. Text above says 'pass the ball', text below is R code reading 'parse(text = 'the('ball')')'. The format is a 'deep-fried', highly pixellated meme where the centre of the iumage bloats out. A wide-eyed, smiling and crying emoji is in the corner."></p>
<figcaption class="figure-caption">Image by <a href="https://pixabay.com/users/keithjj-2328014/">Keith Johnston</a> from <a href="https://pixabay.com">Pixabay</a>. Deep fried by Matt Dray.<sup>1</sup></figcaption>
</figure>
</div>
<section id="tldr" class="level2">
<h2 class="anchored" data-anchor-id="tldr">tl;dr</h2>
<p>R is capable of reading R code. Obviously. You can use <code>getParseData(parse())</code> to see what‚Äôs going on. A very naive intro.</p>
</section>
<section id="at-an-imparse" class="level2">
<h2 class="anchored" data-anchor-id="at-an-imparse">At an imparse</h2>
<p>There‚Äôs many things that delight me about R coding.<sup>2</sup> One meta thing I like is the idea that R has to recognise the code that you give it as‚Ä¶ R code.</p>
<p>For example, does <code>x&lt;-1</code> mean ‚Äòx is less than minus-one‚Äô? Hm, actually R recognises <code>&lt;-</code> as a ‚Äòleft-assignment operator‚Äô‚Äîa special ‚Äòtoken‚Äô‚Äîthat gives the name <code>x</code> the value of <code>1</code>. Subtle, but important.</p>
<p>Another example: the tokens <code>&lt;-</code> and <code>=</code> have an equivalent role in <code>x &lt;- 1</code> and <code>x = 1</code>. For style reasons, you‚Äôll probably want to replace <code>=</code> with <code>&lt;-</code>.<sup>3</sup> But don‚Äôt just ‚Äòfind and replace‚Äô because <code>=</code> is context dependent. Consider:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">subset</span>(mtcars, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subset =</span> carb <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span></code></pre></div>
</div>
<p>Here, <code>=</code> is used to assign (<code>=</code>), to set a function argument (<code>=</code>) and as part of the equivalence operator (<code>==</code>). Oof.</p>
<p>How can a mere human understand this better?</p>
</section>
<section id="parsed-tense" class="level2">
<h2 class="anchored" data-anchor-id="parsed-tense">Parsed tense</h2>
<p>The cool (‚Äòcool‚Äô) thing is that R gives you tools to be able to see the world as R sees it.</p>
<p>This is sometimes called ‚Äòstatic code analysis‚Äô, in that you can interrogate the code for syntax errors <em>before</em> it executes. Packages like <a href="https://lintr.r-lib.org/">{lintr}</a> can even help tidy up (‚Äòlint‚Äô) your code by adjusting or replacing the tokens.<sup>4</sup></p>
<p>I‚Äôve used this approach before to:</p>
<ul>
<li><a href="https://www.rostrum.blog/2020/11/14/hello-r2eng/">create the {r2eng} package</a>, which matches tokens against words so an expression can be translated to English (e.g.&nbsp;<code>&lt;-</code> is matched to the word ‚Äògets‚Äô)</li>
<li><a href="https://www.rostrum.blog/2021/08/31/add-biscuits/">write an RStudio addin that auto-labels closing parentheses</a> with the name of the function they belong to (known cutely as a ‚Äòbiscuit‚Äô)</li>
<li><a href="https://www.rostrum.blog/2021/03/13/assign/">identify and destroy files that contain equals assignment</a> (<code>x = 1</code>), rather than the superior assignment arrow (<code>x &lt;- 1</code>)</li>
</ul>
<p>How might you tinker about with this yourself? Read on for a quickstart.</p>
</section>
<section id="parse-the-parcel" class="level2">
<h2 class="anchored" data-anchor-id="parse-the-parcel">Parse the parcel</h2>
<p>I‚Äôll talk about two main functions: <code>parse()</code> and <code>getParseData()</code>, which are both part of base R.</p>
<p>You can pass a string of R code to <code>parse()</code> for it to be recognised as an ‚Äòexpression‚Äô. Let‚Äôs use the equals-rich <code>subset()</code> example from above.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">code_str <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x = subset(mtcars, subset = carb == 8)"</span></span>
<span id="cb2-2">code_expr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">parse</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">text =</span> code_str)</span>
<span id="cb2-3">code_expr</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>expression(x = subset(mtcars, subset = carb == 8))</code></pre>
</div>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">class</span>(code_expr)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "expression"</code></pre>
</div>
</div>
<p>So the string is recognised as R code at this point, which will allow us to break it down into its individual tokens. You could jump ahead here and just <code>eval()</code>uate this expression object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">eval</span>(code_expr)</span>
<span id="cb6-2">x</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              mpg cyl disp  hp drat   wt qsec vs am gear carb
Maserati Bora  15   8  301 335 3.54 3.57 14.6  0  1    5    8</code></pre>
</div>
</div>
<p>As a result, the dataframe <code>x</code> is now in our environment and, as expected, contains only rows of the <code>mtcars</code> that have 8 <code>carb</code>uretors.<sup>5</sup></p>
<p>So we have the power to delay code execution, like some kind of wizard. Jeepers! That‚Äôs great, but now lets pick apart the frozen expression into its constituent tokens. This is where <code>getParseData()</code> comes in.</p>
<p>The function takes an expression object as the input and returns a dataframe with one token per row and several columns of handy information related to positioning and the relatedness between the tokens.</p>
<p>For now I‚Äôm going to simplify the output to show only the units of <code>text</code> that have been recognised as tokens, along with the name that R gives to each <code>token</code> under the hood (e.g.&nbsp;<code>&lt;-</code> is recognised as <code>LEFT_ASSIGN</code>).<sup>6</sup></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">code_parsed <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">getParseData</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">parse</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">text =</span> code_str, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">keep.source =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>))</span>
<span id="cb8-2">code_parsed[code_parsed<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>text <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"token"</span>)]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     text                token
1       x               SYMBOL
2       =            EQ_ASSIGN
5  subset SYMBOL_FUNCTION_CALL
6       (                  '('
8  mtcars               SYMBOL
9       ,                  ','
14 subset           SYMBOL_SUB
15      =               EQ_SUB
16   carb               SYMBOL
17     ==                   EQ
19      8            NUM_CONST
21      )                  ')'</code></pre>
</div>
</div>
<p>Oh neato, so you can see <code>=</code> is indeed recognised as the token <code>EQ_ASSIGN</code> (‚Äòequals assign‚Äô), <code>=</code> as <code>EQ_SUB</code> (equals in the context of supplying function arguments) and <code>==</code> as in <code>EQ</code> (the equivalence operator).</p>
<p>If you‚Äôre wondering, the <code>keep.source = TRUE</code> bit was needed to encourage <code>parse()</code> to return its output, which is a necessary step within this non-interactive blog post.</p>
</section>
<section id="parseltongue" class="level2">
<h2 class="anchored" data-anchor-id="parseltongue">Parseltongue</h2>
<p>Want to take a look at the tokens in a given string of R code yourself? You can use this little function that contains <code>parse()</code> and <code>getParseData()</code> and returns you the simplified dataframe I showed above if <code>simplify = TRUE</code>, otherwise it gives the full read out.<sup>7</sup></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">parse_out <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(string, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">simplify =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) {</span>
<span id="cb10-2">  p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">parse</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">text =</span> string, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">keep.source =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb10-3">  pd <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">getParseData</span>(p)</span>
<span id="cb10-4">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (simplify) {</span>
<span id="cb10-5">    keep_cols <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"token"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text"</span>)</span>
<span id="cb10-6">    pd <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> pd[pd<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>text <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, keep_cols]</span>
<span id="cb10-7">  }</span>
<span id="cb10-8">  pd</span>
<span id="cb10-9">}</span></code></pre></div>
</div>
<p>So you could use it like:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">parse_out</span>(</span>
<span id="cb11-2">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mean(CO2[CO2$Plant == 'Qn1', CO2$uptake]) -&gt; mean_uptake"</span></span>
<span id="cb11-3">)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                  token        text
1  SYMBOL_FUNCTION_CALL        mean
2                   '('           (
4                SYMBOL         CO2
5                   '['           [
7                SYMBOL         CO2
8                   '$'           $
10               SYMBOL       Plant
12                   EQ          ==
13            STR_CONST       'Qn1'
14                  ','           ,
20               SYMBOL         CO2
21                  '$'           $
23               SYMBOL      uptake
25                  ']'           ]
30                  ')'           )
35         RIGHT_ASSIGN          -&gt;
36               SYMBOL mean_uptake</code></pre>
</div>
</div>
<div class="tip">
<p> <b>Note</b></p>
<p>Since I wrote this post, it‚Äôs become possible to <a href="https://github.com/coatless/quarto-webr">include editable R blocks in a rendered Quarto document</a>, which can be run in the browser thanks to <a href="https://docs.r-wasm.org/webr/latest/">WebR</a>(!). <a href="https://webr-parse-test.netlify.app/">I‚Äôve made a quick demo</a> and <a href="https://www.rostrum.blog/2023/03/16/webr-quarto/">post</a> so you can play around with a simplified version of the parsing function above.</p>
</div>
</section>
<section id="lateral-parse" class="level2">
<h2 class="anchored" data-anchor-id="lateral-parse">Lateral parse</h2>
<p>I‚Äôll leave you with another interesting thing that shows you the inner workings of R, which you might not realise as you run your code. We can look at how the code is actually executed, not just the tokens that it‚Äôs composed of.</p>
<p>Consider how the {magrittr} pipe <code>%&gt;%</code> is used. Here I‚Äôve slightly adjusted the input to filter for 6 and 8 <code>carb</code>uretors; you‚Äôll see why in a second.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">parse_out</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mtcars %&gt;% subset(carb %in% c(6, 8))"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                  token   text
1                SYMBOL mtcars
2               SPECIAL    %&gt;%
4  SYMBOL_FUNCTION_CALL subset
5                   '('      (
7                SYMBOL   carb
8               SPECIAL   %in%
10 SYMBOL_FUNCTION_CALL      c
11                  '('      (
13            NUM_CONST      6
15                  ','      ,
19            NUM_CONST      8
21                  ')'      )
26                  ')'      )</code></pre>
</div>
</div>
<p>Okay yeah, <code>%&gt;%</code> is recognised as a token called <code>SPECIAL</code> between the left-hand side of <code>mtcars</code> and the right-hand side of <code>subset(carb %in% c(6, 8))</code>. Notice also that <code>%in%</code> is also recognised as <code>SPECIAL</code>.</p>
<p>In fact, this is how R recognises <a href="https://adv-r.hadley.nz/functions.html?q=infix%20operator#infix-functions">‚Äòinfix operators‚Äô</a> that are bound by percent symbols. This is some special syntactical magic that lets you put the function name <em>between</em> two arguments. So <code>x %&gt;% head</code> is equivalent to <code>`%&gt;%`(mtcars, head)</code>. Perhaps <code>SPECIAL</code> instead of a more specific name because infix operators can be created on the fly?</p>
<p>If <code>%&gt;%</code> is <code>SPECIAL</code>, how do you think the base pipe is recognised in this simpler example?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">parse_out</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mtcars |&gt; head()"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 token   text
1               SYMBOL mtcars
2                 PIPE     |&gt;
4 SYMBOL_FUNCTION_CALL   head
5                  '('      (
7                  ')'      )</code></pre>
</div>
</div>
<p>Not that surprising: it‚Äôs recognised as <code>PIPE</code> and not a <code>SPECIAL</code>, since it‚Äôs a proper base R token in its own right (<a href="https://www.rostrum.blog/2022/06/01/try-r/">as of R v4.1</a>) .</p>
<p>Okay, so we‚Äôve seen how R parses these tokens, what about how it actually executes the code? One way to see this is to look at an ‚Äòabstract syntax tree‚Äô with <a href="https://lobstr.r-lib.org/">the {lobstr} package</a>.<sup>8</sup> A ‚Äòtree‚Äô to show the nested structure of code and variables and so on.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(lobstr)    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># install from CRAN</span></span>
<span id="cb17-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(magrittr)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># install from CRAN</span></span>
<span id="cb17-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ast</span>(mtcars <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>())</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>‚ñà‚îÄ`%&gt;%` 
‚îú‚îÄmtcars 
‚îî‚îÄ‚ñà‚îÄhead </code></pre>
</div>
</div>
<p>Yeah, like I said: <code>x %&gt;% head()</code> is ultimately executed by R like a normal function (block symbol in the output from <code>ast()</code> above), in the form <code>`%&gt;%`(mtcars, head)</code>. You can see how the <code>`%&gt;%`</code> is a parent to <code>mtcars</code> and <code>head()</code> below it.</p>
<p>So the same happens for the base pipe, right?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ast</span>(mtcars <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>())</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>‚ñà‚îÄhead 
‚îî‚îÄmtcars </code></pre>
</div>
</div>
<p>Surprise! <code>mtcars |&gt; head</code> is not executed like <code>`|&gt;`(mtcars, head)</code>. It‚Äôs literally executed like <code>head(mtcars)</code>. The base pipe is so special because it‚Äôs baked right into the R source code as a separate type of token that is recognised to have a job distinct from a basic <code>SPECIAL</code>. This should make it a little faster to run compared to <code>%&gt;%</code> as well.</p>
</section>
<section id="parse-away" class="level2">
<h2 class="anchored" data-anchor-id="parse-away">Parse away</h2>
<p>Well, ‚Äòcool‚Äô I guess. Now it‚Äôs up to you: you can either parse on this knowledge, or leave it in the parsed.<sup>9</sup></p>
</section>



<div id="quarto-appendix" class="default"><section id="environment" class="level2 appendix"><h2 class="anchored quarto-appendix-heading">Environment</h2><div class="quarto-appendix-contents">

<details>
<summary>
Session info
</summary>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Last rendered: 2023-07-17 18:08:02 BST</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.3.1 (2023-06-16)
Platform: aarch64-apple-darwin20 (64-bit)
Running under: macOS Ventura 13.2.1

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: Europe/London
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
[1] magrittr_2.0.3 lobstr_1.1.2  

loaded via a namespace (and not attached):
 [1] digest_0.6.31     fastmap_1.1.1     xfun_0.39         fontawesome_0.5.1
 [5] knitr_1.43.1      htmltools_0.5.5   rmarkdown_2.23    cli_3.6.1        
 [9] compiler_4.3.1    rstudioapi_0.15.0 tools_4.3.1       evaluate_0.21    
[13] yaml_2.3.7        crayon_1.5.2      rlang_1.1.1       jsonlite_1.8.7   
[17] htmlwidgets_1.6.2</code></pre>
</div>
</div>
</details>


</div></section><aside id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>You too <a href="https://www.rostrum.blog/2021/11/07/deepfry/">can use R to deep fry a meme</a>.‚Ü©Ô∏é</p></li>
<li id="fn2"><p>Things that I‚Äôm sure are quite trivial to gatekeepers. I learnt minimal amounts of R to help me wrangle ecological data and ‚Äòdo statistics‚Äô. I‚Äôm not a computer scientist, nor was I trained as a programmer.‚Ü©Ô∏é</p></li>
<li id="fn3"><p>Of course, I‚Äôm not mentioning right assignment (<code>-&gt;</code>) here, nor the plucky upstart of <a href="https://www.rostrum.blog/2022/06/07/assign-down/">down-asignment</a>, which is certain to be the future for assignment in R.‚Ü©Ô∏é</p></li>
<li id="fn4"><p>You may also enjoy <a href="https://renkun.me/2020/11/08/using-parse-data-to-analyze-r-code/">a post by Kun Ren</a> about how this approach is useful for static analysis in <a href="https://github.com/REditorSupport/languageserver">the {languageserver} package</a>, which is a handy download for using R in VS Code.‚Ü©Ô∏é</p></li>
<li id="fn5"><p>Not <code>carb</code>ohydrates. ‚ÄòNon-car people‚Äô should take a look at the ‚ÄòFormat‚Äô section of <code>?mtcars</code>. I mean, <code>drat</code> means ‚Äòrear axle ratio‚Äô, what?‚Ü©Ô∏é</p></li>
<li id="fn6"><p>You can <a href="https://github.com/wch/r-source/blob/0ee550ff68f22b8a1807377e728f99f2775cc43c/src/main/gram.y#L2312-L2350">see a list of these with English translations</a> in Winston Chang‚Äôs GitHub copy of R‚Äôs source code. So <code>NUM_CONST</code> is ‚Äònumeric constant‚Äô, for example.‚Ü©Ô∏é</p></li>
<li id="fn7"><p>An exercise for the reader is to alter this function to accept an R script file rather than a string (hint: <code>parse()</code> takes a <code>file</code> argument).‚Ü©Ô∏é</p></li>
<li id="fn8"><p>A package with one of my favourite names and <a href="https://lobstr.r-lib.org/logo.png">hex logos</a>. The ‚Äòstr‚Äô is from ‚Äòstructure‚Äô, as in ‚Äòthe structure of code‚Äô. The logo is a lobster snipping apart the ‚Äòlob‚Äô from ‚Äòstr‚Äô text. I mean, *(lobster) chef‚Äôs kiss* on that one. ü¶û‚Ü©Ô∏é</p></li>
<li id="fn9"><p>Yeah, I‚Äôm hoping you didn‚Äôt read this far. Obviously I didn‚Äôt know how to end the post, sorry.‚Ü©Ô∏é</p></li>
</ol>
</aside><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div id="quarto-reuse" class="quarto-appendix-contents"><div>CC BY-NC-SA 4.0</div></div></section></div> ]]></description>
  <category>lobstr</category>
  <category>r</category>
  <guid>https://whimsical-wisp-30974e.netlify.app/posts/2023-03-03-getparsedata/index.html</guid>
  <pubDate>Fri, 03 Mar 2023 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Repaying Tom Nook with {S7}</title>
  <dc:creator>Matt Dray</dc:creator>
  <link>https://whimsical-wisp-30974e.netlify.app/posts/2023-02-26-nook-s7/index.html</link>
  <description><![CDATA[ 




<p><img src="https://whimsical-wisp-30974e.netlify.app/posts/2023-02-26-nook-s7/resources/acnh-s7-knit.jpg" class="img-fluid" style="width:100.0%" alt="Fish-eye lens selfie of the player-character from the game Animal Crossing New Horizons. The character is wearing a knitted black hoodie with bright green letters that say 'S7'. The picture is taken in the Resident Services building. Tom Nook, a raccoon-dog character, is in the background staring ominously at the player."></p>
<section id="tldr" class="level2">
<h2 class="anchored" data-anchor-id="tldr">tl;dr</h2>
<p>The <del>R7</del> <a href="https://rconsortium.github.io/OOP-WG/">S7 object-oriented system</a> is coming to R. I‚Äôve done a little R6-to-S7 translation on <a href="https://www.rostrum.blog/2020/04/04/repaying-tom-nook-with-r6/">an old project</a> to get a very cursory feel for it, featuring <a href="https://www.animal-crossing.com/new-horizons/">Animal Crossing New Horizons</a>.</p>
<div class="tip">
<p>‚ùóÔ∏è <b>Warning</b></p>
<p>The S7 system and package are under development and could change at any time, rendering everything in this post useless.<sup>1</sup> Heck, last time I checked, the system was called ‚ÄòR7‚Äô. There‚Äôs also a chance that S7 elements may have been integrated into base R itself by the time you read this.</p>
</div>
</section>
<section id="again-oh-no" class="level2">
<h2 class="anchored" data-anchor-id="again-oh-no">2020 again, oh no</h2>
<p>Animal Crossing New Horizons (ACNH) was the perfect pandemic game. And the pandemic was the perfect time to <a href="https://www.rostrum.blog/2020/04/04/repaying-tom-nook-with-r6/">build an ersatz version of the ACNH in-game banking system</a> to solve <a href="https://adv-r.hadley.nz/r6.html#exercises-44">an exercise in the Advanced R book</a> using <a href="https://r6.r-lib.org/">the {R6} package for object-oriented programming (OOP)</a> in R.</p>
<p>The exercise helped me fantasize about defeating the game‚Äôs main boss, the predatory loanshark (loanraccoon?) <a href="https://animalcrossing.fandom.com/wiki/Tom_Nook">Tom Nook</a>, via endless wire transfers of hard-earned in-game currency, called ‚ÄòBells‚Äô.</p>
<p>Of course, a lot has changed since 2020. Most importantly, <a href="https://github.com/RConsortium/OOP-WG">a new OOP system for R is being developed</a>. Conversely, Tom Nook has not changed. He is still a scourge.</p>
<p>Anyway, maybe this is a chance to twitch my OOP muscles with this new system.</p>
</section>
<section id="oop-they-did-it-again" class="level2">
<h2 class="anchored" data-anchor-id="oop-they-did-it-again">OOP they did it again</h2>
<p>The <a href="https://www.r-consortium.org/">R Consortium</a>‚Äôs OOP working group has been beavering (raccooning?) away to develop a new OOP system from the ground up: S7<sup>2</sup> (<a href="https://github.com/RConsortium/OOP-WG/issues/262">S3 + S4</a>, geddit?).</p>
<p>The idea is to take the best elements of <a href="https://adv-r.hadley.nz/oo.html">the existing and in-built S3 and S4 systems</a>, interface with them and improve on them.</p>
<p>You can <a href="https://rconsortium.github.io/OOP-WG/">read various design docs and meeting minutes on their documentation site</a>, which is housed in their <a href="https://github.com/RConsortium/OOP-WG/">‚ÄòOOP-WG‚Äô GitHub repo</a>, and try out the current iteration of the associated package, fittingly called {S7}.</p>
<p>You should refer to their docs in the first instance, or a useful third party review. For example, <a href="https://www.jumpingrivers.com/">Jumping Rivers</a> have‚Ä¶ jumped the river on this one and produced <a href="https://www.jumpingrivers.com/blog/r7-oop-object-oriented-programming-r/">a handy intro</a>.</p>
</section>
<section id="a-new-horizon-for-oop" class="level2">
<h2 class="anchored" data-anchor-id="a-new-horizon-for-oop">A new horizon for OOP</h2>
<p>Naturally, I should revisit my post on <a href="https://www.rostrum.blog/2020/04/04/repaying-tom-nook-with-r6/">Repaying Tom Nook with {R6}</a> by replicating it with {S7}. Naturally.</p>
<p>Aha, but actually the {S7} package is more like a development of S3 and S4 objects, and is not a ‚Äònew version‚Äô of {R6}! Ah well. I‚Äôm noodling around with {S7} for my own devices and thought I‚Äôd post it here so I can refer back to it later.</p>
<p>Basically I‚Äôm recycling content from a previous post to get a feel for the new system. But only in the most superficial, basic way. I spent about 15 minutes on this. Look elsewhere for actually-usefully material. You have been warned.</p>
</section>
<section id="install" class="level2">
<h2 class="anchored" data-anchor-id="install">Install</h2>
<p>For now, the {S7} package is in <a href="https://github.com/RConsortium/OOP-WG/">the R Consortium‚Äôs OOP-WG GitHub repo</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install.packages</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"remotes"</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># if not yet installed</span></span>
<span id="cb1-2">remotes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install_github</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RConsortium/OOP-WG"</span>)</span></code></pre></div>
</div>
<p>And for some glamour we‚Äôll also use the quintessential <a href="https://emilhvitfeldt.github.io/emoji/">{emoji} package</a><sup>3</sup></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install.packages</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"emoji"</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># if not yet installed</span></span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(emoji)</span></code></pre></div>
</div>
</section>
<section id="that-is-class" class="level2">
<h2 class="anchored" data-anchor-id="that-is-class">That is class</h2>
<p>A new class is constructed with‚Ä¶ <code>new_class()</code></p>
<p>We can give it a name. We can also give it properties: fields that contain data and can be provided a type check and default value. It‚Äôs possible to build validators for these as well, which ensure that certain conditions are met when the properties are adjusted. I‚Äôll keep this simple for now: I just want the values to remain equal or greater than zero.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">ABD <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new_class</span>(</span>
<span id="cb3-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ABD"</span>,</span>
<span id="cb3-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">properties =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb3-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">savings =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new_property</span>(class_integer, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">default =</span> 0L),</span>
<span id="cb3-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">loan =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new_property</span>(class_integer, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">default =</span> 2498000L)</span>
<span id="cb3-6">  ),</span>
<span id="cb3-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">validator =</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(self) {</span>
<span id="cb3-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (self<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>savings <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> 0L) {</span>
<span id="cb3-9">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"@savings must be zero or more"</span></span>
<span id="cb3-10">    } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (self<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>loan <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> 0L) {</span>
<span id="cb3-11">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"@loan must be zero or more"</span></span>
<span id="cb3-12">    }</span>
<span id="cb3-13">  }</span>
<span id="cb3-14">)</span></code></pre></div>
</div>
<p>For new methods, you can create a new ‚Äògeneric‚Äô and define a function for it. For example, the ‚Äòdeposit‚Äô method is pretty straightforward: it just adds an amount to the current savings value.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">deposit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new_generic</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"deposit"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x"</span>)</span>
<span id="cb4-2"></span>
<span id="cb4-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">method</span>(deposit, ABD) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x, amount) {</span>
<span id="cb4-4">  x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>savings <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>savings <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> amount</span>
<span id="cb4-5">  x</span>
<span id="cb4-6">}</span></code></pre></div>
</div>
<p>I specified some other methods, but I hid them because they‚Äôre not much more complicated.</p>
<details>
<summary>
Click for more methods
</summary>
<p>The ‚Äòwithdraw‚Äô method subtracts a specified amount from the savings property. You‚Äôre warned if you specify an amount greater than the amount available.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">withdraw <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new_generic</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"withdraw"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x"</span>)</span>
<span id="cb5-2"></span>
<span id="cb5-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">method</span>(withdraw, ABD) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x, amount) {</span>
<span id="cb5-4">  </span>
<span id="cb5-5">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>savings <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> amount <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> 0L) {</span>
<span id="cb5-6">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">warning</span>(</span>
<span id="cb5-7">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Withdrew all savings: "</span>, x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>savings, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" Bells.</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, </span>
<span id="cb5-8">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">call. =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span></span>
<span id="cb5-9">    )</span>
<span id="cb5-10">    x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>savings <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> 0L</span>
<span id="cb5-11">  } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb5-12">    x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>savings <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>savings <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> amount</span>
<span id="cb5-13">  }</span>
<span id="cb5-14">  </span>
<span id="cb5-15">  x</span>
<span id="cb5-16">  </span>
<span id="cb5-17">}</span></code></pre></div>
</div>
<p>The ‚Äòpay‚Äô method moves funds from savings to loan. You‚Äôre warned if the loan is already paid, if you specify a greater amount than there are savings, or if you pay a greater amount than the loan remaining. You‚Äôll get a victory message if you pay off the whole loan.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">pay <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new_generic</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pay"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x"</span>)</span>
<span id="cb6-2"></span>
<span id="cb6-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">method</span>(pay, ABD) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x, amount) {</span>
<span id="cb6-4">  </span>
<span id="cb6-5">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>loan <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> 0L) {</span>
<span id="cb6-6">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stop</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"You already finished paying your loan!</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">call. =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span>
<span id="cb6-7">  }</span>
<span id="cb6-8">  </span>
<span id="cb6-9">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>savings <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> amount <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> 0L) {</span>
<span id="cb6-10">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">warning</span>(</span>
<span id="cb6-11">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Paid total amount from savings instead: "</span>, x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>savings, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" Bells.</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,</span>
<span id="cb6-12">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">call. =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span></span>
<span id="cb6-13">    )</span>
<span id="cb6-14">    x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>loan <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>loan <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>savings</span>
<span id="cb6-15">    x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>savings <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> 0L</span>
<span id="cb6-16">  } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>loan <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> amount <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> 0L) {</span>
<span id="cb6-17">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">warning</span>(</span>
<span id="cb6-18">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Paid total remaining loan instead: "</span>, x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>loan, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" Bells.</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,</span>
<span id="cb6-19">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">call. =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span></span>
<span id="cb6-20">    )</span>
<span id="cb6-21">    x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>savings <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>savings <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>loan </span>
<span id="cb6-22">    x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>loan <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> 0L</span>
<span id="cb6-23">  } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb6-24">    x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>savings <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>savings <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> amount</span>
<span id="cb6-25">    x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>loan <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>loan <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> amount</span>
<span id="cb6-26">  }</span>
<span id="cb6-27">  </span>
<span id="cb6-28">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>loan <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> 0L) {</span>
<span id="cb6-29">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(</span>
<span id="cb6-30">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">emoji</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"smiley"</span>),</span>
<span id="cb6-31">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Sweet! I finally finished paying off my very last home loan!"</span>,</span>
<span id="cb6-32">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">emoji</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tada"</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb6-33">    )</span>
<span id="cb6-34">  }</span>
<span id="cb6-35">  </span>
<span id="cb6-36">  x</span>
<span id="cb6-37">  </span>
<span id="cb6-38">}</span></code></pre></div>
</div>
<p>The check method is basically a print method. It reports the loan and savings amounts currently stored in the bank.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">check <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">new_generic</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"check"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x"</span>)</span>
<span id="cb7-2"></span>
<span id="cb7-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">method</span>(check, ABD) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x) {</span>
<span id="cb7-4"></span>
<span id="cb7-5">  loan_formatted <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">format</span>(x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>loan, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">big.mark =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">","</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scientific =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span>
<span id="cb7-6"></span>
<span id="cb7-7">  savings_formatted <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">format</span>(x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>savings, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">big.mark =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">","</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scientific =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span>
<span id="cb7-8"></span>
<span id="cb7-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Automatic Bell Dispenser (ABD)</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb7-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">emoji</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bell"</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Loan Balance:"</span>, loan_formatted, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bells</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb7-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">emoji</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pig2"</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Savings Balance:"</span>, savings_formatted, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Bells</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb7-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(</span>
<span id="cb7-13">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Please make a selection from the menu below</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,</span>
<span id="cb7-14">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">emoji</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"house"</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pay()</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,</span>
<span id="cb7-15">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">emoji</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"arrow_up"</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"deposit()</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>,</span>
<span id="cb7-16">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">emoji</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"arrow_down"</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"withdraw()"</span></span>
<span id="cb7-17">  )</span>
<span id="cb7-18"></span>
<span id="cb7-19">}</span></code></pre></div>
</div>
</details>
<p>You can start a new instance of the ABD class by, y‚Äôknow, calling it.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">bank <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ABD</span>()</span></code></pre></div>
</div>
<p>When you check the class of this object, you‚Äôll see both the custom class name and a reminder that it has the ‚ÄòS7‚Äô class.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">class</span>(bank)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "ABD"       "S7_object"</code></pre>
</div>
</div>
<p>The vanilla print method exposes the properties and their startup values:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1">bank</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;ABD&gt;
 @ savings: int 0
 @ loan   : int 2498000</code></pre>
</div>
</div>
<p>Note that the properties are prepended with <code>@</code>. This indicates that we can use the ‚Äòat‚Äô symbol to access these ‚Äòslots‚Äô (like S4) from the object, like:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1">bank<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>loan</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2498000</code></pre>
</div>
</div>
<p>While we‚Äôre printing stuff, we can use the <code>check()</code> method (that I‚Äôve pre-specified) to see the properties in a manner that more closely resembles the game.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">check</span>(bank)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Automatic Bell Dispenser (ABD)

üîî Loan Balance: 2,498,000 Bells
üêñ Savings Balance: 0 Bells

Please make a selection from the menu below

 üè† pay()
 ‚¨ÜÔ∏è deposit()
 ‚¨áÔ∏è withdraw()</code></pre>
</div>
</div>
<p>You can easily and directly change the properties. To add 10 Bells:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1">bank<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>savings <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">9.99</span></span></code></pre></div>
</div>
<pre><code>Error: &lt;ABD&gt;@savings must be &lt;integer&gt;, not &lt;double&gt;</code></pre>
<p>Haha, whoops. Remember I specified that the property can only be an integer, so we need to provide an integer value instead of a double value. In other words, we can only provide whole numbers of Bells. Remember that the <code>L</code> suffix is used in R to signify an integer.<sup>4</sup></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1">bank<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>savings <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> 10L</span></code></pre></div>
</div>
<p>Is there an overdraft? Tom Nook would probably love that and would ask for massive overdraft fees, but it‚Äôs not programmed into the game. This is where our validator comes in handy. We specified that you can‚Äôt have a negative amount of savings, so this causes an error:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1">bank<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>savings <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>11L</span></code></pre></div>
</div>
<pre><code>Error: &lt;ABD&gt; object is invalid:
- @savings must be zero or more</code></pre>
<p>That‚Äôs fine, but I have sometimes I have extra logic I want to evaluate when I adjust the properties. That‚Äôs why I created new methods earlier on. It means I can use a function to add to the savings property instead, for example.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1">bank <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">deposit</span>(bank, 10L)</span>
<span id="cb22-2">bank<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>savings</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 10</code></pre>
</div>
</div>
<p>We can retrieve Bells in this fashion too:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1">bank <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">withdraw</span>(bank, 10L)</span>
<span id="cb24-2">bank<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>savings</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
</div>
<p>What if we deposit enough Bells to pay the loan?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1">bank <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">deposit</span>(bank, 2500000L)</span>
<span id="cb26-2">bank <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pay</span>(bank, 2500000L)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Paid total remaining loan instead: 2498000 Bells.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>üòÉ Sweet! I finally finished paying off my very last home loan! üéâ </code></pre>
</div>
</div>
<p>The method warns us when we try to pay off a value greater than the remaining loan and prints a nice congratulatory message if we‚Äôve cleared the whole debt.</p>
<p>And so we end up with this view:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">check</span>(bank)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Automatic Bell Dispenser (ABD)

üîî Loan Balance: 0 Bells
üêñ Savings Balance: 2,000 Bells

Please make a selection from the menu below

 üè† pay()
 ‚¨ÜÔ∏è deposit()
 ‚¨áÔ∏è withdraw()</code></pre>
</div>
</div>
<p>Huzzah. Get rekt, raccoon dog. More like Tom <em>Crook</em> amirite.</p>
<p><img src="https://whimsical-wisp-30974e.netlify.app/posts/2023-02-26-nook-s7/resources/acnh-s7-knit-2.jpg" class="img-fluid" style="width:100.0%" alt="Fish-eye lens selfie of the player-character from the game Animal Crossing New Horizons. The character is wearing a knitted black hoodie with bright green letters that say 'S7'. The picture is taken in the Resident Services building."></p>
</section>



<div id="quarto-appendix" class="default"><section id="environment" class="level2 appendix"><h2 class="anchored quarto-appendix-heading">Environment</h2><div class="quarto-appendix-contents">

<details>
<summary>
Session info
</summary>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Last rendered: 2023-07-06 19:26:57 BST</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.3.1 (2023-06-16)
Platform: aarch64-apple-darwin20 (64-bit)
Running under: macOS Ventura 13.2.1

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: Europe/London
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
[1] emoji_15.0    S7_0.0.0.9000

loaded via a namespace (and not attached):
 [1] digest_0.6.31     fastmap_1.1.1     xfun_0.39         magrittr_2.0.3   
 [5] glue_1.6.2        stringr_1.5.0     knitr_1.43.1      htmltools_0.5.5  
 [9] rmarkdown_2.23    lifecycle_1.0.3   cli_3.6.1         compiler_4.3.1   
[13] rstudioapi_0.14   tools_4.3.1       evaluate_0.21     yaml_2.3.7       
[17] rlang_1.1.1       jsonlite_1.8.7    htmlwidgets_1.6.2 stringi_1.7.12   </code></pre>
</div>
</div>
</details>


</div></section><aside id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>‚ÄòUseless‚Äô is an extremely relative term with regard to this blog.‚Ü©Ô∏é</p></li>
<li id="fn2"><p>95% certain that ‚ÄòS7‚Äô is pronounced how a snake might say ‚Äòseven‚Äô: like ‚Äòsseven‚Äô.‚Ü©Ô∏é</p></li>
<li id="fn3"><p><a href="https://github.com/hadley/emo">{emo}</a> is dead, long live <a href="https://emilhvitfeldt.github.io/emoji/">{emoji}</a>. Haha, joke‚Äôs on you, emo will never die. I know this because ‚Äòemo‚Äô was in my top 5 genres on Spotify Wrapped 2022, lololol.‚Ü©Ô∏é</p></li>
<li id="fn4"><p>Why <code>L</code>? <a href="https://stackoverflow.com/questions/22191324/clarification-of-l-in-r/22192378#22192378">Shrug</a>. Just take the L.‚Ü©Ô∏é</p></li>
</ol>
</aside><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div id="quarto-reuse" class="quarto-appendix-contents"><div>CC BY-NC-SA 4.0</div></div></section></div> ]]></description>
  <category>oop</category>
  <category>r</category>
  <category>r6</category>
  <category>s7</category>
  <category>videogames</category>
  <guid>https://whimsical-wisp-30974e.netlify.app/posts/2023-02-26-nook-s7/index.html</guid>
  <pubDate>Sun, 26 Feb 2023 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Porting a Twitter bot to Mastodon</title>
  <dc:creator>Matt Dray</dc:creator>
  <link>https://whimsical-wisp-30974e.netlify.app/posts/2023-02-09-londmapbotstodon/index.html</link>
  <description><![CDATA[ 




<p><img src="https://whimsical-wisp-30974e.netlify.app/posts/2023-02-09-londmapbotstodon/resources/toot-hyde.jpg" class="img-fluid" style="width:100.0%" alt="Aerial image of Hyde Park, London, with three emoji mammoths overlaid, each one tooting on an emoji trumpet, with the word 'toot' coming out the end of the trumpet."></p>
<section id="tldr" class="level2">
<h2 class="anchored" data-anchor-id="tldr">tl;dr</h2>
<p>I‚Äôve (finally) ported the <a href="https://github.com/matt-dray/londonmapbot">londonmapbot</a> <a href="https://twitter.com/londonmapbot">Twitter</a> bot to <a href="https://botsin.space/@londonmapbot">Mastodon</a>. Like a mammoth rising from the ashes.</p>
</section>
<section id="tooooooot" class="level2">
<h2 class="anchored" data-anchor-id="tooooooot">TOOOOOOOT</h2>
<p>Twitter is burning to the ground, yada yada.</p>
<p>For example, it appears that the free API tier will disappear soon. Soon like‚Ä¶ <a href="https://twitter.com/TwitterDev/status/1621026986784337922">today</a>. Oh wait, <a href="https://twitter.com/TwitterDev/status/1623467615539859456">maybe not yet</a>?<sup>1</sup> Cool customer communication, brah.</p>
<p>Anyway, this news will obviously devastate contributors and fans of <a href="https://mobile.twitter.com/i/lists/1492559073287581707">the mapbotverse Twitter list</a>.</p>
<p>You don‚Äôt know what the mapbotverse is? Oof. It‚Äôs a collection of 25 bot accounts that take some inspiration from <a href="https://twitter.com/londonmapbot">my londonmapbot account</a>, which uses <a href="https://github.com/features/actions">GitHub Actions</a> and <a href="https://docs.ropensci.org/rtweet/">the {rtweet} package</a> to tweet on schedule a picture of a random spot in Greater London via <a href="https://www.mapbox.com/">MapBox</a>.</p>
<p>And so it‚Äôs time to update <a href="https://github.com/matt-dray/londonmapbot">the code behind londonmapbot</a> so that it continues to <a href="https://twitter.com/londonmapbot">post to Twitter</a> for as long as it survives. But also so that it lives on by <a href="https://botsin.space/@londonmapbot">posting to Mastodon</a> via <a href="https://schochastics.github.io/rtoot/">the {rtoot} package</a> as well.</p>
<p>Mastowhat? Something something <a href="https://en.wikipedia.org/wiki/Mastodon_(social_network)">federated Twitter-replacement</a> sort of thing. Tooooooot tooooooot.</p>
<div class="tip">
<p> <b>Note</b></p>
<p>I finally turned off londonmapbot on Twitter in May 2023.</p>
</div>
</section>
<section id="masto-do-or-masto-do-not" class="level2">
<h2 class="anchored" data-anchor-id="masto-do-or-masto-do-not">Masto-do or masto-do-not</h2>
<p>I‚Äôm slightly behind the curve on this: <a href="https://lapsedgeographer.london/">Matt Kerlogue</a> has already ported his <a href="https://t.co/gP6YeqHzAL">narrowbotR</a> (‚Äònarrow boater‚Äô) bot from <a href="https://twitter.com/narrowbotR">Twitter</a> to <a href="https://fosstodon.org/@narrowbotr@botsin.space">Mastodon</a> and <a href="https://lapsedgeographer.london/2022-11/mastodon-switch/">written about it</a>.</p>
<p>The fix was fairly rudimentary in the end, thanks to standing on the shoulder of mammoths. Particularly the creators of <a href="https://schochastics.github.io/rtoot/">the {rtoot} R package</a>.</p>
<p>{rtoot} lets you interact with the <a href="https://docs.joinmastodon.org/api/">Mastodon API</a>. It‚Äôs a sort-of analogue to <a href="https://docs.ropensci.org/rtweet/">the {rtweet} package</a> for <a href="https://developer.twitter.com/en/docs/twitter-api">the Twitter API</a>. {rtoot} was stood up very quickly by <a href="https://www.mr.schochastics.net/">David Schoch</a> (with co-author <a href="http://www.chainsawriot.com/">Chung-hong Chan</a> and contributor <a href="https://www.johannesbgruber.eu/">Johannes Gruber</a>) when it became clear that Mastodon was becoming the platform-du-jour for nerds.</p>
<section id="set-up-mastodon" class="level3">
<h3 class="anchored" data-anchor-id="set-up-mastodon">Set up Mastodon</h3>
<p>It‚Äôs easier to set yourself up with API access for Mastodon compared to Twitter:</p>
<ol type="1">
<li>Set up a Mastodon account on the dedicated bot server <a href="https://botsin.space/">botsin.space</a> (londonmapbot is <a href="https://botsin.space/@londonmapbot"><span class="citation" data-cites="londonmapbot">@londonmapbot</span><span class="citation" data-cites="botsin.space">@botsin.space</span></a>).<sup>2</sup></li>
<li>Install the {rtoot} package.</li>
<li>Authorise yourself with Mastodon and get an API token.</li>
<li>???</li>
<li>Absolutely do not profit whatsoever.</li>
</ol>
<p>Steps 2 and 3 look like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install.packages</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rtoot"</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># on CRAN</span></span>
<span id="cb1-2"></span>
<span id="cb1-3">rtoot<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">auth_setup</span>(</span>
<span id="cb1-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">instance  =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"botsin.space"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the Mastodon server the account is on</span></span>
<span id="cb1-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type      =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>,          <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># i.e. for posting from R</span></span>
<span id="cb1-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name      =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"londonmapbot"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># name the token file</span></span>
<span id="cb1-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">clipboard =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>             <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># copy to clipboard</span></span>
<span id="cb1-8">)</span></code></pre></div>
</div>
<p>This process interrupts you to interactively authorise the {rtoot} package in a browser window and copy a big long code to a dialogue box that appears in your R session.</p>
<p><img src="https://whimsical-wisp-30974e.netlify.app/posts/2023-02-09-londmapbotstodon/resources/rtoot-permission.png" class="img-fluid" style="width:75.0%" alt="A prompt on the Mastodon website that asks the user to provide authorisation for the rtoot package to have permission for read and write access. There's a big blue button that says 'authorise' and a big red one that says 'deny'."></p>
<p>It‚Äôll then return:</p>
<pre><code>Token of type "user" for instance botsin.space is valid
Token (in environment variable format) has been copied to clipboard.
&lt;mastodon bearer token&gt; for instance: botsin.space of type: user </code></pre>
<p>I pasted this API token to a safe place and also stored it as <a href="https://docs.github.com/en/rest/actions/secrets">a GitHub repo secret</a> in the londonmapbot GitHub repo so it could be referred to while the GitHub Action was running.</p>
</section>
<section id="post-to-mastodon" class="level3">
<h3 class="anchored" data-anchor-id="post-to-mastodon">Post to Mastodon</h3>
<p>Now we can use the <code>post_toot()</code> function to‚Ä¶ toot a post. Publish a toot? Entoot a noote. It requires a <code>token</code> argument that takes a special ‚Äòbearer token‚Äô with a particular structure that‚Äôs not too dissimilar from what the rtweet package expects of the object passed to its own <code>token</code> function.</p>
<p>Aside: token setup is made easy in {rtweet} thanks to the <code>rtweet_bot()</code> function, to which you can pass your API keys and secrets. It‚Äôs a little less obvious in {rtoot}, which was initially built with the intention of running API calls from your personal machine, so you could just store your keys in your .Renviron file or whatever.</p>
<p>But actually you can just mimic how {rtweet} accepts the token. To do this, I did not use my brain at all and simply ripped-off <a href="https://lapsedgeographer.london/">Matt Kerlogue‚Äôs post</a>.<sup>3</sup> <a href="https://github.com/matt-dray/londonmapbot/blob/main/post-image.R">My updated R script</a> now contains this:<sup>4</sup></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">mastodon_token <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">structure</span>(</span>
<span id="cb3-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># it's just a list</span></span>
<span id="cb3-3">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bearer   =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Sys.getenv</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"RTOOT_DEFAULT_TOKEN"</span>),</span>
<span id="cb3-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type     =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># i.e. to post from R</span></span>
<span id="cb3-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">instance =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"botsin.space"</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the server</span></span>
<span id="cb3-6">  ),</span>
<span id="cb3-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rtoot_bearer"</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># special token class</span></span>
<span id="cb3-8">)</span></code></pre></div>
</div>
<p>Where <code>RTOOT_DEFAULT_TOKEN</code> is that API token from earlier, which is required for accessing Mastodon. As mentioned, it‚Äôs stored as <a href="https://docs.github.com/en/rest/actions/secrets">a GitHub repo secret</a> and called into the GitHub Action environment thanks to the <code>${{ secrets.RTOOT_DEFAULT_TOKEN }}</code> call in <a href="https://github.com/matt-dray/londonmapbot/blob/main/.github/workflows/post-image.yml">the YAML file</a>.</p>
<p>This object can be passed quite happily to the <code>post_toot()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">rtoot<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">post_toot</span>(</span>
<span id="cb4-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">status   =</span> latlon_details,</span>
<span id="cb4-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">media    =</span> temp_file,</span>
<span id="cb4-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alt_text =</span> alt_text,</span>
<span id="cb4-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">token    =</span> mastodon_token</span>
<span id="cb4-6">)</span></code></pre></div>
</div>
<p>Where the <code>status</code> (body text), <code>media</code> (image file) and <code>alt_text</code> (alternative text for the image) objects have been generated already (<a href="https://github.com/matt-dray/londonmapbot/blob/main/post-image.R">see the R script</a> for details).</p>
<p>This is then executed on schedule according to the <a href="https://en.wikipedia.org/wiki/Cron">cron string</a><sup>5</sup> specified in <a href="https://github.com/matt-dray/londonmapbot/blob/main/.github/workflows/post-image.yml">the YAML file</a> (currently twice a day at 0914 and 1714) to publish stuff like this:</p>
<p><img src="https://whimsical-wisp-30974e.netlify.app/posts/2023-02-09-londmapbotstodon/resources/londonmapbot-mastodon.png" class="img-fluid" style="width:100.0%" alt="Example of a toot on Mastodon from the londonmapbot account. The image is an aerial image of London. The text provides the latitude and longitude of the centre of the image and also an OpenStreetMap link."></p>
</section>
<section id="await-twitter-implosion" class="level3">
<h3 class="anchored" data-anchor-id="await-twitter-implosion">Await Twitter implosion</h3>
<p>I want the bot to keep posting to Twitter for as long as I‚Äôm allowed to. In other words, we should <em>try</em> to post a tweet and <em>catch</em> any error silently, without disrupting the GitHub Action. So naturally I wrapped <code>post_tweet()</code> in a <code>tryCatch()</code> statement, yes? No, actually I used <code>purrr::possibly()</code> instead.</p>
<p>Why? Basically because the syntax is easy to remember, lol. And what difference does it make to have one extra dependency for this task? To use it, you wrap your function of interest in <code>possibly()</code> and then it can fail without erroring-out the whole function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">possibly_post_tweet <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> purrr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">possibly</span>(rtweet<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>post_tweet)</span>
<span id="cb5-2"></span>
<span id="cb5-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">possibly_post_tweet</span>(</span>
<span id="cb5-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">status         =</span> latlon_details,</span>
<span id="cb5-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">media          =</span> temp_file,</span>
<span id="cb5-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">media_alt_text =</span> alt_text,</span>
<span id="cb5-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">token          =</span> twitter_token</span>
<span id="cb5-8">)</span></code></pre></div>
</div>
</section>
<section id="fiddle-while-frisco-burns" class="level3">
<h3 class="anchored" data-anchor-id="fiddle-while-frisco-burns">Fiddle while Frisco burns</h3>
<p>While I was messing about with the londonmapbot code, I made a few things in the repo a bit more generic. For example, I altered the name of the GitHub Actions YAML file and the R script to be called ‚Äòpost-image‚Äô. This is more descriptive and it removes the need for someone forking the repo to have to manually change the name away from ‚Äòlondonmapbot‚Äô. You are so welcome.</p>
</section>
</section>
<section id="parp" class="level2">
<h2 class="anchored" data-anchor-id="parp">Parp</h2>
<p>Farewell, until the next time we have to port londonmapot to another API-enabled microblogging site. We‚Äôve had bird- and mammal-themed sites; my prediction is that the next site will be called ‚ÄòSeacucumber‚Äô and we won‚Äôt ‚Äòtweet‚Äô or ‚Äòtoot‚Äô, we‚Äôll ‚Äòeviscerate‚Äô.<sup>6</sup></p>
<p>I mean, inverting one‚Äôs stomach is a daily reaction on Twitter anyway, amirite?</p>
</section>



<div id="quarto-appendix" class="default"><section id="environment" class="level2 appendix"><h2 class="anchored quarto-appendix-heading">Environment</h2><div class="quarto-appendix-contents">

<details>
<summary>
Session info
</summary>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Last rendered: 2023-07-17 18:09:04 BST</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.3.1 (2023-06-16)
Platform: aarch64-apple-darwin20 (64-bit)
Running under: macOS Ventura 13.2.1

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: Europe/London
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

loaded via a namespace (and not attached):
 [1] htmlwidgets_1.6.2 compiler_4.3.1    fastmap_1.1.1     cli_3.6.1        
 [5] tools_4.3.1       htmltools_0.5.5   rstudioapi_0.15.0 yaml_2.3.7       
 [9] rmarkdown_2.23    knitr_1.43.1      jsonlite_1.8.7    xfun_0.39        
[13] digest_0.6.31     rlang_1.1.1       fontawesome_0.5.1 evaluate_0.21    </code></pre>
</div>
</div>
</details>


</div></section><aside id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Happy Valentine‚Äôs to all my fellow monetisable users.‚Ü©Ô∏é</p></li>
<li id="fn2"><p>During this process you have to explain why you want to set up the account. Don‚Äôt forget to say the magic word in your application, wink wink.‚Ü©Ô∏é</p></li>
<li id="fn3"><p>‚ÄòMatt hivemind prerogative‚Äô, this is called.‚Ü©Ô∏é</p></li>
<li id="fn4"><p>Kerlogue influenced the {rtoot} team to <a href="https://github.com/schochastics/rtoot/issues/68">update the package</a> to handle environmental variables, but I could not get this to work, alas.‚Ü©Ô∏é</p></li>
<li id="fn5"><p>Did I mention I made <a href="https://github.com/matt-dray/dialga">the R package {dialga}</a> to convert R to cron to English, lol?‚Ü©Ô∏é</p></li>
<li id="fn6"><p>I <a href="https://en.wikipedia.org/wiki/Evisceration_(autotomy)">fact-checked myself on Wikipedia</a> and read this brand new sentence: ‚Äò[evisceration] causes the wall of the cloaca to tear and the anus to gape.‚Äô‚Ü©Ô∏é</p></li>
</ol>
</aside><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div id="quarto-reuse" class="quarto-appendix-contents"><div>CC BY-NC-SA 4.0</div></div></section></div> ]]></description>
  <category>api</category>
  <category>github-actions</category>
  <category>londonmapbot</category>
  <category>social-media</category>
  <category>r</category>
  <category>rtoot</category>
  <category>rtweet</category>
  <guid>https://whimsical-wisp-30974e.netlify.app/posts/2023-02-09-londmapbotstodon/index.html</guid>
  <pubDate>Thu, 09 Feb 2023 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Wrapping Pok√©API with {trapinch}</title>
  <dc:creator>Matt Dray</dc:creator>
  <link>https://whimsical-wisp-30974e.netlify.app/posts/2023-02-02-trapinch/index.html</link>
  <description><![CDATA[ 




<p><img src="https://whimsical-wisp-30974e.netlify.app/posts/2023-02-02-trapinch/resources/trapinch_hex.png" class="img-fluid" style="width:40.0%" alt="Hex sticker design for the 'trapinch' R package. An orange background and grey border are sampled from the official art of the Pok√©mon trapinch. A pixellated black zig-zag goes left-to-right above centre to represent the Pok√©mon trapinch's distinctive mouth. A pixellated font says 'trapinch' in the font used for the original Pok√©mon Game Boy games and underneath it says 'R interface to Pok√©API'."></p>
<section id="tldr" class="level2">
<h2 class="anchored" data-anchor-id="tldr">tl;dr</h2>
<p>I‚Äôve used <a href="https://httr2.r-lib.org/">the {httr2} R package</a> to create <a href="https://github.com/matt-dray/trapinch">{trapinch}</a>, a package that wraps <a href="https://pokeapi.co/">Pok√©API</a> for fetching Pok√©mon data.</p>
<div class="tip">
<p> <b>Note</b></p>
<p>I had found a couple of older, non-{httr2} Pok√©API wrappers for R (see footnotes), but had <a href="https://fosstodon.org/@ashbaldry/109806406291422128">somehow missed one</a> that already uses {httr2}: see <a href="https://ashbaldry.github.io/">Ash Baldry</a>‚Äôs <a href="https://github.com/ashbaldry/pokeapi">{pokeapi} package</a>, which he wrote months ago!</p>
</div>
</section>
<section id="httr-me-baby-one-more-time" class="level2">
<h2 class="anchored" data-anchor-id="httr-me-baby-one-more-time">{httr} me baby one more time</h2>
<p><a href="https://httr2.r-lib.org/">The {httr2} package</a> lets you talk to the internet. Or, if you‚Äôre fancy, it ‚Äòhelps you deal programmatically with HTTP requests and responses‚Äô so you can use it to fetch data from <a href="https://en.wikipedia.org/wiki/API">Application Programming Interfaces</a> (APIs).</p>
<p>{httr2} has functions that are prefixed consistently (<code>req_*()</code>, <code>resp_*()</code>, etc), are narrow in scope, pipeable (<code>|&gt;</code>) and which return nice errors and messages. These are neat improvements on <a href="https://httr.r-lib.org/">the original {httr} package</a>.</p>
<p>I‚Äôve used {httr} before to <a href="https://www.rostrum.blog/2021/08/27/zzz/">explore R package startup messages</a> and <a href="https://www.rostrum.blog/2021/07/10/linkrot/">detect linkrot</a>. It‚Äôs time to try out {httr2}. What simple API can I wrap into an R package?<sup>1</sup></p>
</section>
<section id="poke-an-api" class="level2">
<h2 class="anchored" data-anchor-id="poke-an-api">Poke an API</h2>
<p>Regular readers will be unsurprised that I‚Äôve chosen <a href="https://pokeapi.co/">the Pok√©API API</a> for fetching all sorts of information related to <a href="https://en.wikipedia.org/wiki/Pok%C3%A9mon">the Pok√©mon game franchise</a>.<sup>2</sup></p>
<p>Pok√©API provides a <a href="https://pokeapi.co/docs/v2">relatively simple API</a>. You don‚Äôt need to sign-up or use API tokens, you can only read (‚ÄòGET‚Äô) data from it‚Äôs not <a href="https://en.wikipedia.org/wiki/Rate_limiting">rate-limited</a>.</p>
<p>URL paths for fetching data are also straightforward: you append an endpoint and a resource of interest to the base URL in the form <code>https://pokeapi.co/api/v2/{endpoint}/{resource}</code>.<sup>3</sup></p>
<p>In other words, you could type <a href="https://pokeapi.co/api/v2/pokemon/lotad"><code>https://pokeapi.co/api/v2/pokemon/lotad</code></a> in your browser and the API would respond with a JSON file containing data about <a href="https://archives.bulbagarden.net/media/upload/2/2c/Lotad_PMRS.png">Lotad, the best Pok√©mon</a>.</p>
<p>{httr2} lets us do this programmatically and can return a more R-friendly list object.</p>
</section>
<section id="its-a-trapinch" class="level2">
<h2 class="anchored" data-anchor-id="its-a-trapinch">It‚Äôs a trapinch</h2>
<p>So, I‚Äôve created <a href="https://github.com/matt-dray/trapinch">the {trapinch} package</a>.</p>
<p>It‚Äôs a proof of concept; a work in progress. There‚Äôs probably <a href="https://bulbapedia.bulbagarden.net/wiki/Bug_(type)">bugs</a>. I‚Äôm sharing it in case I don‚Äôt take it any further, or if you want to contribute <a href="https://github.com/matt-dray/trapinch/issues">an issue</a> or pull request.</p>
<p>You can download it from GitHub. It depends on {httr2} (obviously), <a href="https://CRAN.R-project.org/package=RCurl">{rcurl}</a> and R version 4.1 or higher<sup>4</sup> and can be downloaded from GitHub:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install.packages</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"remotes"</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># if not yet installed</span></span>
<span id="cb1-2">remotes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install_github</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"matt-dray/trapinch"</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># v0.0.1 in this post</span></span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(trapinch)</span></code></pre></div>
</div>
<p>Don‚Äôt be surprised if function names or general functionality change in future. In particular, I‚Äôd like to look at <a href="https://github.com/matt-dray/trapinch/issues/13">throttling</a> (limiting the number of API calls to prevent misuse) and to provide sensible errors for <a href="https://github.com/matt-dray/trapinch/issues/12">timeouts</a> or if <a href="https://github.com/matt-dray/trapinch/issues/10">the service is down</a>.</p>
<section id="gotta-get-em-all" class="level3">
<h3 class="anchored" data-anchor-id="gotta-get-em-all">Gotta GET ‚Äôem all</h3>
<p>There‚Äôs a generic low-level function, <code>get_pokeapi()</code>, to which you pass the <code>endpoint</code> and <code>resource</code> ID (numeric) or name (character) of interest. Each endpoint also has its own dedicated function, like <code>get_item()</code> or <code>get_move()</code> that calls <code>get_pokeapi()</code> under the hood.</p>
<p>You can look at the inbuilt <code>resource_lookups</code> list to get a dataframe of resource IDs and names for each endpoint, as well as the full URL needed to query the API. Here‚Äôs the first few:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(resource_lookups))</span></code></pre></div>
</div>
<pre><code>[1] "ability"        "berry"          "berry-firmness" "berry-flavor"  
[5] "characteristic" "contest-effect"</code></pre>
<p>So here‚Äôs the first few rows of the resource dataframe for the ‚Äòpokemon‚Äô endpoint:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(resource_lookups[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pokemon"</span>]])</span></code></pre></div>
</div>
<pre><code>  id       name                                  url
1  1  bulbasaur https://pokeapi.co/api/v2/pokemon/1/
2  2    ivysaur https://pokeapi.co/api/v2/pokemon/2/
3  3   venusaur https://pokeapi.co/api/v2/pokemon/3/
4  4 charmander https://pokeapi.co/api/v2/pokemon/4/
5  5 charmeleon https://pokeapi.co/api/v2/pokemon/5/
6  6  charizard https://pokeapi.co/api/v2/pokemon/6/</code></pre>
<p>One of these resource names is ‚Äòmew‚Äô, <a href="https://bulbapedia.bulbagarden.net/wiki/Mew_(Pok%C3%A9mon)">the legendary first-generation Pok√©mon</a>.<sup>5</sup> You could use <code>get_pokeapi("pokemon", "mew")</code> to retrieve its data, or more simply:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">mew <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_pokemon</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mew"</span>)</span></code></pre></div>
</div>
<p>The function returns a list of lists, which is parsed from the JSON response returned by the API. So for the ‚Äòpokemon‚Äô endpoint we get 18 different elements of various classes:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str</span>(mew, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max.level =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
</div>
<pre><code>List of 18
 $ abilities               :List of 1
 $ base_experience         : int 300
 $ forms                   :List of 1
 $ game_indices            :List of 20
 $ height                  : int 4
 $ held_items              :List of 1
 $ id                      : int 151
 $ is_default              : logi TRUE
 $ location_area_encounters: chr "https://pokeapi.co/api/v2/pokemon/151/encounters"
 $ moves                   :List of 363
 $ name                    : chr "mew"
 $ order                   : int 248
 $ past_types              : list()
 $ species                 :List of 2
 $ sprites                 :List of 10
 $ stats                   :List of 6
 $ types                   :List of 1
 $ weight                  : int 40</code></pre>
<p>I‚Äôve shown only the top level <code>str</code>ucture to hide some of the complexity. For example, the ‚Äòmoves‚Äô item contains all the moves a Pok√©mon can learn, at what level it can learn them, in which game it learns them, and so on. Grabbing the first of the 363 ‚Äòmoves‚Äô items (!) listed for Mew looks like this (oof):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">mew[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"moves"</span>]][[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]][[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"move"</span>]][[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"name"</span>]]</span></code></pre></div>
</div>
<pre><code>[1] "pound"</code></pre>
<p>A future task might be to simplify some of this complexity by collapsing deep lists into dataframes where possible.</p>
</section>
<section id="thumbing-the-pok√©dex" class="level3">
<h3 class="anchored" data-anchor-id="thumbing-the-pok√©dex">Thumbing the Pok√©dex</h3>
<p>The API responses are ‚Äòpaged‚Äô, meaning that you must make successive requests of a set size to retrieve all the data for a given endpoint. The <code>get_*()</code> functions automatically expand the request to ask for all the items in one go.</p>
<p>We know the maximum number of items to be returned from an endpoint because the stored in the <code>resource_lookups</code> object, so this can be appended automatically to the request string.</p>
</section>
<section id="bills-pc" class="level3">
<h3 class="anchored" data-anchor-id="bills-pc">BILL‚Äôs PC</h3>
<p>Responses are cached, which means that the data is saved on your computer. If you make the same request, the data will be retrieved first from the cache rather than calling the API again. That means there‚Äôs one less request for the API to deal with.</p>
<p>The cache is the path resolved by <code>R_user_dir("trapinch", "cache")</code>. This function was introduced in R v4.0 for platform-independent storage of package-related data on a user‚Äôs machine.<sup>6</sup> You can delete everything from the cache with <code>clear_cache()</code>.</p>
</section>
<section id="substitute" class="level3">
<h3 class="anchored" data-anchor-id="substitute">Substitute</h3>
<p><a href="https://enpiar.com/httptest2/">{httptest2}</a> is a handy package that lets you test code written with {httr2}, specifically.</p>
<p>Why would you need special testing for API calls? The idea is that you should be able to test your package without the need for an active internet connection. {httptest2} ‚Äòrecords‚Äô the calls you make when you run your tests, then chooses when testing between this ‚Äòmock‚Äô response and a ‚Äòlive‚Äô response.</p>
<p>The approach is pretty simple if you‚Äôve tested before with {testthat}: you wrap your normal <code>test_that()</code> call with <code>httr2::with_mock_dir()</code>. Here‚Äôs an example of a test that make sure we get a list back from the API when we use <code>get_pokeapi()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">with_mock_dir</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"endpoint"</span>, {</span>
<span id="cb11-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">test_that</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"a list is returned"</span>, {</span>
<span id="cb11-3">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expect_type</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_pokeapi</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"move-battle-style"</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"list"</span>)</span>
<span id="cb11-4">  })</span>
<span id="cb11-5">})</span></code></pre></div>
</div>
<p>By wrapping the test in <code>with_mock_dir()</code>, {httptest2} creates the directory <code>tests/endpoint/</code> that stores a copy of the JSON returned for this call when an internet connection was live.</p>
<p>As an aside, I learnt about <code>curl::has_internet()</code> in <a href="https://colinfay.me/build-api-wrapper-package-r/">Colin‚Äôs blogpost</a>, which can <code>stop()</code> the <code>get_*()</code> functions if there‚Äôs no internet connection. But <code>has_internet()</code> will trigger if you‚Äôre offline when you test, defeating the purpose of {httptest2}! Luckily, I saw <a href="https://blog.r-hub.io/2023/01/23/code-switch-escape-hatch-test/">a timely post by Ma√´lle</a> about integrating this type of check into an ‚Äòescape hatch‚Äô so your unit tests can be run successfully in this scenario.</p>
<p>The <a href="https://books.ropensci.org/http-testing/">rOpenSci HTTP Testing book</a> is a good general port of call as well.</p>
</section>
</section>
<section id="inside-the-pok√©-ball" class="level2">
<h2 class="anchored" data-anchor-id="inside-the-pok√©-ball">Inside the Pok√© Ball</h2>
<p>The user-facing functions of {trapinch} are therefore pretty simple. I could leave it at that.</p>
<p>But how daunting does the underlying {httr2} code look in the back-end? Turns out that it‚Äôs not that scary, thanks to those friendly and modular functions of {httr2}.</p>
<p>We can walk through that earlier <code>get_pokemon("mew")</code> call using bare {httr2} functions by:</p>
<ol type="1">
<li>Starting with the base API URL</li>
<li>Appending the endpoint and resource as extensions (i.e.&nbsp;in the form <code>/pokemon/mew</code>)</li>
<li>Adding a query for the maximum number of items in this endpoint-resource combo (i.e.&nbsp;<code>?limit=1279</code>)</li>
<li>Announcing to the API, as courtesy, who has made the call (i.e.&nbsp;who is the ‚Äòuser agent‚Äô)</li>
<li>Specifying the cache location for results to be saved</li>
</ol>
<p>First some variables:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1">endpoint <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pokemon"</span></span>
<span id="cb12-2">resource <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mew"</span></span>
<span id="cb12-3">base_url <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://pokeapi.co/api/v2/"</span></span>
<span id="cb12-4">user_agent <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"trapinch (http://github.com/matt-dray/trapinch)"</span></span>
<span id="cb12-5">resource_count <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(trapinch<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>resource_lookups[[endpoint]])</span>
<span id="cb12-6">cache_dir <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> tools<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">R_user_dir</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"trapinch"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">which =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cache"</span>)</span></code></pre></div>
</div>
<p>And now we can build our request with {httr2} functions prefixed with <code>req</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(httr2)</span>
<span id="cb13-2"></span>
<span id="cb13-3">mew_request <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">request</span>(base_url) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb13-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">req_url_path_append</span>(endpoint, resource) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb13-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">req_url_query</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">limit =</span> resource_count) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb13-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">req_user_agent</span>(user_agent) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb13-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">req_cache</span>(cache_dir)</span></code></pre></div>
</div>
<p>Printing the object summarises the request:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1">mew_request</span></code></pre></div>
</div>
<pre><code>&lt;httr2_request&gt;
GET https://pokeapi.co/api/v2/pokemon/mew?limit=1279
Body: empty
Options:
‚Ä¢ useragent: 'trapinch (http://github.com/matt-dray/trapinch)'
Policies:
‚Ä¢ cache_path: '/Users/mattdray/Library/Caches/org.R-project.R/R/trapinch'
‚Ä¢ cache_use_on_error: FALSE
‚Ä¢ cache_debug: FALSE</code></pre>
<p>Then we can actually execute the request:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1">mew_perform <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">req_perform</span>(mew_request)</span></code></pre></div>
</div>
<p>Again, we can peek at the object to get some extra information about the processing of the request:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1">mew_perform</span></code></pre></div>
</div>
<pre><code>&lt;httr2_response&gt;
GET https://pokeapi.co/api/v2/pokemon/mew?limit=1279
Status: 200 OK
Content-Type: application/json
Body: In memory (561317 bytes)</code></pre>
<p>We can see the request was successful, since the HTTP status was <code>200 OK</code>. Other <a href="https://en.wikipedia.org/wiki/List_of_HTTP_status_codes">status values</a> are possible and may require us to try again later, for example.</p>
<p>A couple of functions to mention here are <code>last_request()</code> and <code>last_response()</code>, which will also (surprise!) spit out info about the last request you made and the response received.</p>
<p>Finally we can parse the JSON returned by the API. Again, I‚Äôm presenting the top-level <code>str</code>ucture only, given its complexity:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1">mew_response <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">resp_body_json</span>(mew_perform)</span>
<span id="cb19-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str</span>(mew_response, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max.level =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
</div>
<pre><code>List of 18
 $ abilities               :List of 1
 $ base_experience         : int 300
 $ forms                   :List of 1
 $ game_indices            :List of 20
 $ height                  : int 4
 $ held_items              :List of 1
 $ id                      : int 151
 $ is_default              : logi TRUE
 $ location_area_encounters: chr "https://pokeapi.co/api/v2/pokemon/151/encounters"
 $ moves                   :List of 363
 $ name                    : chr "mew"
 $ order                   : int 248
 $ past_types              : list()
 $ species                 :List of 2
 $ sprites                 :List of 10
 $ stats                   :List of 6
 $ types                   :List of 1
 $ weight                  : int 40</code></pre>
<p>Boom: this matches the information we retrieved earlier with <code>get_pokemon("mew")</code>.</p>
</section>
<section id="whos-that-pok√©mon" class="level2">
<h2 class="anchored" data-anchor-id="whos-that-pok√©mon">Who‚Äôs that Pok√©mon?</h2>
<p>I know you‚Äôre thinking ‚Äòwhy trapinch?‚Äô In short, <a href="https://bulbapedia.bulbagarden.net/wiki/Trapinch_(Pok%C3%A9mon)">it‚Äôs the name of a Pok√©mon</a> that contains the letters ‚ÄòR API‚Äô, which is cute. It also makes for an easy hex sticker with the Pok√©mon‚Äôs characteristic zigzag mouth and colour palette of orange and grey.</p>
<p>So why not ‚Äòrapidash‚Äô, which starts with ‚ÄòR API‚Äô? Easy, lol: trapinch isn‚Äôt taken yet on <a href="https://cheeaun.github.io/repokemon/">Repok√©mon</a>, a page by <a href="https://github.com/cheeaun">Chee Aun</a> that lists GitHub repositories that are named after Pok√©mon.<sup>7</sup></p>
<p><img src="https://whimsical-wisp-30974e.netlify.app/posts/2023-02-02-trapinch/resources/trapinch-repokemon.png" class="img-fluid" style="width:40.0%" alt="A screenshot of a portion of the Repok√©mon webpage. It's an image of the Pok√©mon called trapinch. Underneath is its name and then the blurb, fork- and star-count for the matt-dray/trapinch GitHub repository."></p>
<p>Join me next time as I continue my quest to write (sometimes) useful R packages that help me squat all the remaining spots on Repok√©mon (I call this ‚ÄòRDD‚Äô).<sup>8</sup></p>
</section>



<div id="quarto-appendix" class="default"><section id="environment" class="level2 appendix"><h2 class="anchored quarto-appendix-heading">Environment</h2><div class="quarto-appendix-contents">

<details>
<summary>
Session info
</summary>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Last rendered: 2023-07-25 15:02:37 BST</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.3.1 (2023-06-16)
Platform: aarch64-apple-darwin20 (64-bit)
Running under: macOS Ventura 13.2.1

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: Europe/London
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

loaded via a namespace (and not attached):
 [1] htmlwidgets_1.6.2 compiler_4.3.1    fastmap_1.1.1     cli_3.6.1        
 [5] tools_4.3.1       htmltools_0.5.5   rstudioapi_0.15.0 yaml_2.3.7       
 [9] rmarkdown_2.23    knitr_1.43.1      jsonlite_1.8.7    xfun_0.39        
[13] digest_0.6.33     rlang_1.1.1       fontawesome_0.5.1 evaluate_0.21    </code></pre>
</div>
</div>
</details>


</div></section><aside id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>There‚Äôs <a href="https://github.com/public-apis/public-apis">a GitHub repo with a big long list of free APIs</a> that you can try out.‚Ü©Ô∏é</p></li>
<li id="fn2"><p><a href="https://pokeapi.co/docs/v2#wrap">The Pok√©API website</a> notes several wrappers in various languages. There exist R wrappers like <a href="https://github.com/UBC-MDS/pokedex">UBC-MDS‚Äôs {pokedex}</a> and <a href="https://nguyeneva.github.io/2020-02-06-rwrapper/">Eva Nguyen‚Äôs {pokeWrapper}</a>, but these appear smaller in scope and haven‚Äôt been updated for a while. (Edit: as noted at the top of this post, see also <a href="https://ashbaldry.github.io/">Ash Baldry</a>‚Äôs {httr2}-powered <a href="https://github.com/ashbaldry/pokeapi">{pokeapi} package</a>, which I had somehow missed!)‚Ü©Ô∏é</p></li>
<li id="fn3"><p>There‚Äôs one exception: for Pok√©mon encounters you need the form <code>/pokemon/{resource}/encounters</code>. The <code>get_pokeapi()</code> function handles this extension with a third argument, <code>ext</code>, which is pre-filled with the string <code>"encounters"</code> in the <code>get_pokemon_location_areas()</code> function, so you don‚Äôt have to think about it.‚Ü©Ô∏é</p></li>
<li id="fn4"><p>This is entirely because I wanted to use <code>tools::R_user_dir()</code> for caching, which was introduced in v4.0. And if we‚Äôre depending on v4.0, why not bump to v4.1 and use the base pipe, <code>|&gt;</code>?‚Ü©Ô∏é</p></li>
<li id="fn5"><p>I‚Äôll say it: <a href="https://bulbapedia.bulbagarden.net/wiki/Mew_(Pok%C3%A9mon)#Sprites">the original Japanese Red/Green Mew sprite</a> was baller. Battle me.‚Ü©Ô∏é</p></li>
<li id="fn6"><p>I made a mockery of <code>R_user_dir</code>‚Äôs functionality in <a href="https://www.rostrum.blog/2022/11/13/tamrgo/">my toy package {tamRgo}</a>, which uses the location to store data for a persistent cyberpet (like a <a href="https://en.wikipedia.org/wiki/Tamagotchi">Tamagotchi</a>) that you can interact with in the R console.‚Ü©Ô∏é</p></li>
<li id="fn7"><p>I have history with this: <a href="https://www.rostrum.blog/2021/04/10/dialga/">my {dialga} package</a> is named for <a href="https://bulbapedia.bulbagarden.net/wiki/Dialga_(Pok%C3%A9mon)">the legendary ‚Äòtemporal‚Äô Pok√©mon</a> from the <em>Diamond</em> and <em>Pearl</em> games, which is fitting because the package converts between R code, <a href="https://en.wikipedia.org/wiki/Cron">cron strings</a> and English.‚Ü©Ô∏é</p></li>
<li id="fn8"><p>Repok√©mon-Driven Development.‚Ü©Ô∏é</p></li>
</ol>
</aside><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div id="quarto-reuse" class="quarto-appendix-contents"><div>CC BY-NC-SA 4.0</div></div></section></div> ]]></description>
  <category>api</category>
  <category>httr2</category>
  <category>httptest2</category>
  <category>r</category>
  <category>trapinch</category>
  <guid>https://whimsical-wisp-30974e.netlify.app/posts/2023-02-02-trapinch/index.html</guid>
  <pubDate>Thu, 02 Feb 2023 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Stiliyan Petrov: Jesus?</title>
  <dc:creator>Matt Dray</dc:creator>
  <link>https://whimsical-wisp-30974e.netlify.app/posts/2023-01-08-petrov/index.html</link>
  <description><![CDATA[ 




<p><img src="https://whimsical-wisp-30974e.netlify.app/posts/2023-01-08-petrov/resources/petrov.jpg" class="img-fluid" style="width:100.0%" alt="Close up of former footballer Stiliyan Petrov playing for Bulgaria. Text around his head says 'Stan Petrov', 'am jebus?', 'nativity' and 'get rekt opta' in Comic Sans font."></p>
<section id="tldr" class="level2">
<h2 class="anchored" data-anchor-id="tldr">tl;dr</h2>
<p>In which I prove wrong a tweeted <a href="https://en.wikipedia.org/wiki/Opta_Sports">Opta</a> football statistic, using R and Transfermarkt data. Oh wait, actually Opta were right. Ah, heck.</p>
</section>
<section id="petrov-rescue" class="level2">
<h2 class="anchored" data-anchor-id="petrov-rescue">Petrov Rescue</h2>
<p>Basically, for little reason, I dislike the style of the tweets on <a href="https://twitter.com/OptaJoe/">the Twitter feed for Opta</a><sup>1</sup> (the company who do all the football stats).</p>
<p>What is so outrageous? Each tweet always ends in a single, summary word that makes me cringe.</p>
<p>Wait, what? Let‚Äôs take a look at <a href="https://twitter.com/OptaJoe/status/1611735498233622534?s=20">their most recent tweet</a> at time of writing:</p>
<blockquote class="blockquote">
<p>14 - Harry Kane has scored 14 goals in his last 14 appearances in the FA Cup, averaging a goal every 63 minutes in the competition in this period. Guarantee.</p>
</blockquote>
<p>‚ÄòGuarantee‚Äô. Gah.</p>
<p>Or <a href="https://twitter.com/OptaJoe/status/1611722890298404866?s=20">this tweet</a>:</p>
<blockquote class="blockquote">
<p>16 - Since his first appearance in the competition in January 2016, Leicester‚Äôs Kelechi Iheanacho has scored more FA Cup goals than any other player (16). Specialist.</p>
</blockquote>
<p>‚ÄòSpecialist‚Äô. Sigh.</p>
<p>A completely small and pointless thing to be annoyed by, right?</p>
<p>But here‚Äôs the scenario. Over the yuletide period (on Christmas day!) they ran <a href="https://twitter.com/OptaJoe/status/1607028528289030144?s=20">this tweet</a>:</p>
<blockquote class="blockquote">
<p>1 - Stiliyan Petrov (<span class="citation" data-cites="StanPetrov19">@StanPetrov19</span>) is the only player to have played in the Premier League whose name contains all the letters in the word ‚ÄòNativity‚Äô. Star.</p>
</blockquote>
<p>Obviously, I have absolutely nothing against <a href="https://en.wikipedia.org/wiki/Stiliyan_Petrov">‚ÄòBig Stan‚Äô</a>. He‚Äôs a legend; a ‚Äòstar‚Äô, if you will. Captain of Aston Villa! Bulgaria! Battled leukaemia and still made it to nearly 600 games. One of the best Bulgarian/Premier League ‚ÄòPetrovs‚Äô, along with cult legend <a href="https://en.wikipedia.org/wiki/Martin_Petrov">Martin</a>.</p>
<p>But could this stat possibly be true? Surely there‚Äôs at least one other player. Perhaps a window of opportunity for me to avenge my feelings of cringe?</p>
<p>Oh, and obviously you can ignore the candid dismissals in the tweet‚Äôs replies, <a href="https://twitter.com/duke_smyles/status/1607052807680524289?s=20">for example</a>:</p>
<blockquote class="blockquote">
<p>What are we supposed to do with this information? [Picture of wryly-smiling duck.]</p>
</blockquote>
<p>No, this is more important than any Opta tweet ever: what if it‚Äôs‚Ä¶ <em>wrong</em>?</p>
</section>
<section id="stan-in-r-but-not-rstan" class="level2">
<h2 class="anchored" data-anchor-id="stan-in-r-but-not-rstan">Stan in R, but not {rstan}</h2>
<p>So I looked into it using R, of course.</p>
<p>Turns out it‚Äôs pretty straightforward with <a href="https://jaseziv.github.io/worldfootballR/">the excellent {worldfootballR} package by Jason Zivkovic</a>, which helps fetch player data from <a href="https://www.transfermarkt.com/">Transfermarkt</a> (among other suppliers).</p>
<p>Basically, we can fetch data about footballers from every team in a given league‚Äôs season since its inception. So, aha, you cannot escape, Opta!</p>
<p>My little <a href="https://github.com/matt-dray/soccercolleagues">{soccercolleagues} package</a> that <a href="https://www.rostrum.blog/2022/02/04/soccercolleagues/">I wrote about in early 2022</a> is built heavily (heavily!) around {worldfootballR} and has a convenience function we can use.</p>
<p>The niche<sup>2</sup> primary objective of {soccercolleagues} is to let you <a href="https://www.rostrum.blog/2022/02/04/soccercolleagues/">find pairs of football players that were colleagues at some point</a>. Like: ‚Äòwhich current Premier League footballer has been team mates with each of the following: Kevin Phillips, Mark Viduka, Dejan Lovren, Danny Ings and Nicky Butt?‚Äô<sup>3</sup></p>
<p>Follow along. As ever, you can install the {soccercolleagues} package from GitHub:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">require</span>(remotes)) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install.packages</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"remotes"</span>)</span>
<span id="cb1-2">remotes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install_github</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"matt-dray/soccercolleagues"</span>)</span></code></pre></div>
</div>
<p>We‚Äôll also use the {tidyverse} for wrangling.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(soccercolleagues)</span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span></code></pre></div>
</div>
<p>So we can ask Transfermarkt for all the years of the English Premier League, which began in 1992:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># This will take quite a long time...</span></span>
<span id="cb3-2">epl_players <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> soccercolleagues<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_players</span>(</span>
<span id="cb3-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seasons =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1992</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2022</span>,</span>
<span id="cb3-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">country =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"England"</span></span>
<span id="cb3-5">)</span></code></pre></div>
</div>
<p>And now we can look for the players whose names contain the letters in ‚Äònativity‚Äô:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">epl_players <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb4-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">distinct</span>(player_name) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb4-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb4-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">player_name =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_remove_all</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tolower</span>(player_name), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" "</span>),</span>
<span id="cb4-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n_count =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_count</span>(player_name, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n"</span>),</span>
<span id="cb4-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">a_count =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_count</span>(player_name, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"a"</span>),</span>
<span id="cb4-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">t_count =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_count</span>(player_name, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"t"</span>),</span>
<span id="cb4-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i_count =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_count</span>(player_name, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"i"</span>),</span>
<span id="cb4-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">v_count =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_count</span>(player_name, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"v"</span>),</span>
<span id="cb4-10">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y_count =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_count</span>(player_name, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y"</span>)</span>
<span id="cb4-11">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb4-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(</span>
<span id="cb4-13">    n_count <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span></span>
<span id="cb4-14">      a_count <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span></span>
<span id="cb4-15">      t_count <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span></span>
<span id="cb4-16">      i_count <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span></span>
<span id="cb4-17">      v_count <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span></span>
<span id="cb4-18">      y_count <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb4-19">  )</span></code></pre></div>
</div>
<pre><code># A tibble: 1 √ó 7
  player_name    n_count a_count t_count i_count v_count y_count
  &lt;chr&gt;            &lt;int&gt;   &lt;int&gt;   &lt;int&gt;   &lt;int&gt;   &lt;int&gt;   &lt;int&gt;
1 stiliyanpetrov       1       1       2       2       1       1</code></pre>
<p>Oof‚Ä¶ they were right. He is the only one.</p>
<p>Wow, this humble pie is so delicious, thank you so much Opta for unintentionally spoonfeeding it to me.</p>
<p>To be clear: Opta‚Äôs data analysts have a good track record, as far as I know. But I‚Äôve got my eye on you! You‚Äôll slip up one day!</p>
<p>‚Ä¶But wait. Opta were misnaming Stan as ‚ÄòStylian Petrov‚Äô <a href="https://twitter.com/OptaJoe/status/169439820584714240?s=20">in tweets as late as 2012</a>. Get rekt! You missed the extra ‚Äòi‚Äô you need in ‚Äònativity‚Äô, fools! Put respect on Stiliyan‚Äôs name!</p>
<p>‚ÄòResult‚Äô.<sup>4</sup></p>
</section>



<div id="quarto-appendix" class="default"><section id="environment" class="level2 appendix"><h2 class="anchored quarto-appendix-heading">Environment</h2><div class="quarto-appendix-contents">

<details>
<summary>
Session info
</summary>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Last rendered: 2023-07-06 19:27:34 BST</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.3.1 (2023-06-16)
Platform: aarch64-apple-darwin20 (64-bit)
Running under: macOS Ventura 13.2.1

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: Europe/London
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

loaded via a namespace (and not attached):
 [1] htmlwidgets_1.6.2 compiler_4.3.1    fastmap_1.1.1     cli_3.6.1        
 [5] tools_4.3.1       htmltools_0.5.5   rstudioapi_0.14   yaml_2.3.7       
 [9] rmarkdown_2.23    knitr_1.43.1      jsonlite_1.8.7    xfun_0.39        
[13] digest_0.6.31     rlang_1.1.1       evaluate_0.21    </code></pre>
</div>
</div>
</details>


</div></section><aside id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>This post is not guerilla marketing for Opta. It would be <em>extremely</em> guerilla if they wanted to advertise on <em>this</em> blog.‚Ü©Ô∏é</p></li>
<li id="fn2"><p>There is definitely a burgeoning crossover of football stats and R users, see <a href="https://ryo-n7.github.io/">Ryo</a>, <a href="https://torvaney.github.io/">Ben</a> and <a href="https://tonyelhabr.rbind.io/">Tony</a>, for example.‚Ü©Ô∏é</p></li>
<li id="fn3"><p>Hint: it‚Äôs a very ‚Äòboring‚Äô footballer, lol.‚Ü©Ô∏é</p></li>
<li id="fn4"><p>By which I mean I lost 1-0.‚Ü©Ô∏é</p></li>
</ol>
</aside><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div id="quarto-reuse" class="quarto-appendix-contents"><div>CC BY-NC-SA 4.0</div></div></section></div> ]]></description>
  <category>r</category>
  <category>soccercolleagues</category>
  <category>sport</category>
  <guid>https://whimsical-wisp-30974e.netlify.app/posts/2023-01-08-petrov/index.html</guid>
  <pubDate>Sun, 08 Jan 2023 00:00:00 GMT</pubDate>
</item>
<item>
  <title>.-././‚Äì/‚Äî/.-./‚Ä¶/.</title>
  <dc:creator>Matt Dray</dc:creator>
  <link>https://whimsical-wisp-30974e.netlify.app/posts/2023-01-06-remorse/index.html</link>
  <description><![CDATA[ 




<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://whimsical-wisp-30974e.netlify.app/posts/2023-01-06-remorse/resources/morse.png" class="img-fluid figure-img" style="width:100.0%" alt="Crudely drawn lineart of a Morse Code tapping machine with text saying 'dit' and 'dah' above it."></p>
<figcaption class="figure-caption">You may not believe it, but I am releasing this art under CC0.</figcaption>
</figure>
</div>
<section id="tldr" class="level2">
<h2 class="anchored" data-anchor-id="tldr">tl;dr</h2>
<p>On a whim, I‚Äôve written <a href="https://github.com/matt-dray/remorse">{remorse}</a>: a tiny R package that converts text to <a href="https://en.wikipedia.org/wiki/Morse_code">Morse Code</a> to audio.</p>
</section>
<section id="beat-a-dead-morse" class="level2">
<h2 class="anchored" data-anchor-id="beat-a-dead-morse">Beat a dead morse</h2>
<p>In <a href="https://www.rostrum.blog/2023/01/04/rogue-sfx/">the last post</a> I mentioned <a href="https://cran.r-project.org/package=sonify">{sonify}</a> for making R do little audible beeps and boops.</p>
<p>It reminded me of one (of many) unwritten micro-projects I‚Äôve got kicking around in my brain: obviously you could use {sonify} to communicate Morse Code. And why not translate from text to Morse (and back) while you‚Äôre at it?<sup>1</sup></p>
<p>To be honest this was a classic case of name-driven development (NDD): I thought {remorse} was a funny name for a package and worked backwards from there.</p>
<p>Obviously it says ‚ÄòMorse‚Äô in the name, but also ‚Äòremorse‚Äô is usually what I feel after putting together a small pointless package; pointless-package existentialism (PPE) is something I have <a href="https://matt-dray.github.io/projects/">a track history</a> with.</p>
<p>But of course, the true remorse is that I didn‚Äôt find the better package-name pun: {morseinspector}. But maybe that‚Äôs too long of a name and maybe non-Brits wouldn‚Äôt understand <a href="https://en.wikipedia.org/wiki/Inspector_Morse_(TV_series)">the reference</a>. Maybe I‚Äôm thinking too hard.<sup>2</sup></p>
</section>
<section id="oh-dit-dit-dahling" class="level2">
<h2 class="anchored" data-anchor-id="oh-dit-dit-dahling">Oh dit-dit-dahling</h2>
<p>Consider this highly plausible scenario: it‚Äôs 20XX, the apocalypse has come, and the remaining humans on planet Earth communicate by Morse Code. For some reason.<sup>3</sup></p>
<p>Wow, wouldn‚Äôt it be handy to have a text-to-Morse translator?</p>
<p>Well friend, if you‚Äôve managed to find an electronic thinking box in the apocalyptic barren wastelands (assuming electricity is still available (and the machine has R installed (and the {remorse} package was downloaded before the world‚Äôs internet cut out (and you know how to use R (and you don‚Äôt own a simpler, more portable Morse Code translation pamphlet))))), then you will have this incredible power at your fingertips.</p>
<p>Or maybe you‚Äôd rather risk it? Pfft.</p>
</section>
<section id="use-the-morse" class="level2">
<h2 class="anchored" data-anchor-id="use-the-morse">Use the Morse‚Ä¶</h2>
<p>That‚Äôs an awful lot of build-up for a very simple package. Let‚Äôs take a look at what little it does.</p>
<p>As usual, {remorse} lives on GitHub<sup>4</sup>, so it can be downloaded with a little help from the typographically-adjacent {remotes} package:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install.github</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"remotes"</span>)</span>
<span id="cb1-2">remotes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install_github</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"matt-dray/remorse"</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># v0.1.1 here</span></span></code></pre></div>
</div>
<p>That‚Äôll install {sonify} as well, which is needed for the audio.</p>
<p>Right so: text to Morse Code.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">text_in <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Ahoy pal!"</span></span>
<span id="cb2-2">morse <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> remorse<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">txt2morse</span>(text_in)</span>
<span id="cb2-3">morse</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] ".-/..../---/-.-- .--./.-/.-../-.-.--"</code></pre>
</div>
</div>
<p>So each letter has been translated to the relevant string of ‚Äòdits and dahs‚Äô (‚Äòdots‚Äô and ‚Äòdashes‚Äô) that make up Morse Code. I‚Äôve used a period (<code>.</code>) and hyphen (<code>-</code>) to represent these in {remorse}, with forward slashes (<code>/</code>) between Morse groups that represent individual characters, and a space for the spaces between words.</p>
<p>Note that not all characters can be converted to Morse Code. I did some research (Wikipedia) to discover the mappings from letters, numbers and punctuation to Morse Code. This information is used internally as a lookup, but is also exported in <code>morse_lookup</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">remorse<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>morse_lookup</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       A        B        C        D        E        F        G        H 
    ".-"   "-..."   "-.-."    "-.."      "."   "..-."    "--."   "...." 
       I        J        K        L        M        N        O        P 
    ".."   ".---"    "-.-"   ".-.."     "--"     "-."    "---"   ".--." 
       Q        R        S        T        U        V        W        X 
  "--.-"    ".-."    "..."      "-"    "..-"   "...-"    ".--"   "-..-" 
       Y        Z        0        1        2        3        4        5 
  "-.--"   "--.."  "-----"  ".----"  "..---"  "...--"  "....-"  "....." 
       6        7        8        9        &amp;        '        @        ) 
 "-...."  "--..."  "---.."  "----."  ".-..." ".----." ".--.-." "-.--.-" 
       (        :        ,        =        !        .        -        * 
 "-.--." "---..." "--..--"  "-...-" "-.-.--" ".-.-.-" "-....-"   "-..-" 
       +        "        ?        /          
 ".-.-." ".-..-." "..--.."  "-..-."      " " </code></pre>
</div>
</div>
<p>Of course, this means we can map backwards from Morse Code to letters, numbers and punctuation:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">text_out <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> remorse<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">morse2txt</span>(morse)</span>
<span id="cb6-2">text_out</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "AHOY PAL!"</code></pre>
</div>
</div>
<p>Morse Code has no sense of case, so it just converts it all to uppercase. Like you‚Äôre shouting; the most clear form of communication.</p>
<p>So, you can argue justifiably that <code>txt2morse("yo") |&gt; morse2txt()</code> is just a worse version of <code>toupper()</code> that strips out certain unmappable characters.</p>
<p>But of course it does so much more. Well, one thing more. Let‚Äôs go from Morse to audio.</p>
<p>First a reminder of the code from earlier:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">morse</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] ".-/..../---/-.-- .--./.-/.-../-.-.--"</code></pre>
</div>
</div>
<p>And to generate audio you just:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">remorse<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">morse2sfx</span>(morse)</span></code></pre></div>
</div>
<p>The output sounds like this:</p>

<audio controls="">
<source src="resources/remorse.wav" type="audio/wav">
</audio>

<p>Wow. It plays audible dits (one ‚Äòtime unit‚Äô, default is <code>dit_length = 0.05</code> in seconds), dahs (three), spaces between dits and dahs (one), spaces between Morse character groupings (three) and spaces between words (seven). Tell all your friends.</p>
<p>So, do I still feel remorse for writing {remorse}, even after demonstrating its incredible power? Yes. All I ask is that you think of me in those apocalyptic wastelands.</p>
<div class="tip">
<p> <b>Note</b></p>
<p>I just realised you can turn Morse Code into‚Ä¶ Morse Code. Mind blown.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1">remorse<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">txt2morse</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hi"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb11-2">  remorse<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">txt2morse</span>()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] ".-.-.-/.-.-.-/.-.-.-/.-.-.-/-..-./.-.-.-/.-.-.-"</code></pre>
</div>
</div>
<p>‚ÄòMorsest Code‚Äô. Why? Absolutely.</p>
<p>Maybe I‚Äôve been watching <a href="https://www.youtube.com/watch?v=HLRdruqQfRk">too much Tom7</a> recently.</p>
</div>
</section>



<div id="quarto-appendix" class="default"><section id="environment" class="level2 appendix"><h2 class="anchored quarto-appendix-heading">Environment</h2><div class="quarto-appendix-contents">

<details>
<summary>
Session info
</summary>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Last rendered: 2023-07-17 18:10:00 BST</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.3.1 (2023-06-16)
Platform: aarch64-apple-darwin20 (64-bit)
Running under: macOS Ventura 13.2.1

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: Europe/London
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

loaded via a namespace (and not attached):
 [1] htmlwidgets_1.6.2 compiler_4.3.1    fastmap_1.1.1     cli_3.6.1        
 [5] tools_4.3.1       htmltools_0.5.5   remorse_0.1.1     rstudioapi_0.15.0
 [9] yaml_2.3.7        rmarkdown_2.23    knitr_1.43.1      jsonlite_1.8.7   
[13] xfun_0.39         digest_0.6.31     rlang_1.1.1       fontawesome_0.5.1
[17] evaluate_0.21    </code></pre>
</div>
</div>
</details>


</div></section><aside id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Which completes my hattrick of ‚ÄòR translation‚Äô packages, I suppose. <a href="https://www.rostrum.blog/2020/11/14/hello-r2eng/">The {r2eng} package</a> attempts to <a href="https://www.rostrum.blog/2020/11/14/hello-r2eng/">translate R code to spoken English and have your computer speak it out loud</a>. <a href="https://www.github.com/matt-dray/dialga/">The {dialga} package</a> takes R code and <a href="https://www.rostrum.blog/2021/04/10/dialga/">translates it to cron strings and those cron strings to English</a>.‚Ü©Ô∏é</p></li>
<li id="fn2"><p>Not to mention that it‚Äôs a bad pun: the package doesn‚Äôt ‚Äòinspect‚Äô Morse; it translates it. Yep, definitely I‚Äôm thinking too hard about this.‚Ü©Ô∏é</p></li>
<li id="fn3"><p>Personally I‚Äôd rather see <a href="https://en.wikipedia.org/wiki/Telegraphy">telegraphy</a> make a comeback.‚Ü©Ô∏é</p></li>
<li id="fn4"><p>Wow, how edgy, maybe he‚Äôs had a bad run in with the CRAN maintainers, or perhaps he‚Äôs read the bit of <a href="https://cran.r-project.org/web/packages/policies.html">the CRAN repository policy</a> that says ‚Äòa package‚Äôs contribution has to be non-trivial‚Äô (<a href="https://fosstodon.org/@mattdray/109644645694966586">whatever that means</a>). Or he‚Äôs just lazy.‚Ü©Ô∏é</p></li>
</ol>
</aside><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div id="quarto-reuse" class="quarto-appendix-contents"><div>CC BY-NC-SA 4.0</div></div></section></div> ]]></description>
  <category>r</category>
  <category>remorse</category>
  <category>sonify</category>
  <guid>https://whimsical-wisp-30974e.netlify.app/posts/2023-01-06-remorse/index.html</guid>
  <pubDate>Fri, 06 Jan 2023 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Ding! Sound effects in {r.oguelike}</title>
  <dc:creator>Matt Dray</dc:creator>
  <link>https://whimsical-wisp-30974e.netlify.app/posts/2023-01-04-rogue-sfx/index.html</link>
  <description><![CDATA[ 




<iframe width="560" height="315" src="https://www.youtube.com/embed/HD1cPWcQUc4" title="Demo of {r.oguelike} for R" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen="">
</iframe>
<p class="caption">
new wr ‚Äî r.oguelike any% tenkeyless noglitch
</p>
<section id="tldr" class="level2">
<h2 class="anchored" data-anchor-id="tldr">tl;dr</h2>
<p><a href="https://github.com/matt-dray/r.oguelike">The {r.oguelike} package</a>‚Äîa toy roguelike microadventure for the R console‚Äînow has little sound effects <a href="https://cran.r-project.org/package=sonify">thanks to {sonify}</a>. Pew pew!</p>
</section>
<section id="the-adventure-continues" class="level2">
<h2 class="anchored" data-anchor-id="the-adventure-continues">The adventure continues?</h2>
<p>Apparently this is part 5 of the {r.oguelike} <a href="https://en.wiktionary.org/wiki/devlog">devlog</a>. You can read earlier posts about:</p>
<ul>
<li><a href="https://www.rostrum.blog/2022/04/25/r.oguelike-dev/">its inception</a></li>
<li><a href="https://www.rostrum.blog/2022/05/01/dungeon/">creating simple procedural dungeons</a></li>
<li><a href="https://www.rostrum.blog/2022/06/10/basic-search/">making an enemy chase the player</a></li>
<li><a href="https://www.rostrum.blog/2022/06/28/isometric-dungeon/">3D dungeons and continuous keypress inputs</a></li>
</ul>
<p>Alas, this is also probably the last installment.</p>
<p>Yes, the dungeons have been dank (cool, edgy), but also <em>dank</em> (cool, damp, claustrophobic). Time to unspelunk myself.</p>
<p>There may be time for a {r.oguelike2} in future. I‚Äôd like to try a class-based approach to help limit code spaghetti and make it more extensible. Perhaps it will even have a proper game loop! Call me when you‚Äôre ready, Kojima.</p>
<p>Until then, one more little feature to tie things up. Beeeeeeep. BOOOOOOOP.</p>
</section>
<section id="hi-sonifi" class="level2">
<h2 class="anchored" data-anchor-id="hi-sonifi">Hi-Sonifi</h2>
<p>So, yes: {r.oguelike} now has sound effects with quality as high as its graphics and gameplay. See all these in concert in the video embedded at the top of this page.</p>
<p>I used <a href="https://cran.r-project.org/package=sonify">the {sonify} package</a> to create a few little beeps and toots that I think fit the game‚Äôs retro aesthetic.<sup>1</sup> These are fired when the player moves and interacts with things in the dungeon.</p>
<p>I‚Äôve written about {sonify} before when I sonified data about <a href="https://www.rostrum.blog/2021/02/02/sonify-covid/">COVID-19 infections</a> and <a href="https://www.rostrum.blog/2021/02/21/skyphone/">GitHub activity</a> (incredible juxtaposition), which can offer a more interesting and accessible way of presenting data.</p>
<p>You can also demean {sonify} by making funny little honks and parps, which is what I‚Äôve done for {r.oguelike}.</p>
<p>How did I arrive at the soundscape for {r.oguelike}? I did the bare minimum of fiddling around with the arguments in <code>sonify::sonify()</code> until the noises amused me.</p>
</section>
<section id="demo-cassette" class="level2">
<h2 class="anchored" data-anchor-id="demo-cassette">Demo cassette</h2>
<p>Sounds are played in the code of the package via functions after each triggering event. The user can prevent these sounds from playing with the logical <code>has_sfx</code> argument in the <code>start_game()</code> function.</p>
<p>For example, here‚Äôs the function for the simplest sound effect:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">.sfx_move <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(has_sfx) {</span>
<span id="cb1-2">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (has_sfx) sonify<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sonify</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">duration =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.001</span>)</span>
<span id="cb1-3">}</span></code></pre></div>
</div>
<p>The <code>sonify()</code> outputs are <a href="https://CRAN.R-project.org/package=tuneR">{tuneR}</a> objects. I‚Äôve saved these as wav files with <code>tuneR::writeWav()</code> so they can be embedded in this post.</p>
<details>
<summary>
Click for illustrative code to create the wav files.
</summary>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(sonify)</span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tuneR)</span>
<span id="cb2-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(purrr)</span>
<span id="cb2-4"></span>
<span id="cb2-5">sfx <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb2-6">  </span>
<span id="cb2-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">move =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sonify</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">duration =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.001</span>),</span>
<span id="cb2-8">  </span>
<span id="cb2-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bump =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sonify</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">duration =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">flim =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">110</span>)),</span>
<span id="cb2-10">  </span>
<span id="cb2-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gold =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind</span>(</span>
<span id="cb2-12">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sonify</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">duration =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">flim =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">800</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">800</span>)),</span>
<span id="cb2-13">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sonify</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">duration =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">flim =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>))</span>
<span id="cb2-14">  ),</span>
<span id="cb2-15">  </span>
<span id="cb2-16">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">apple =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sonify</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">duration =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>),</span>
<span id="cb2-17">  </span>
<span id="cb2-18">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eat =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sonify</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">duration =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>),</span>
<span id="cb2-19">  </span>
<span id="cb2-20">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">win =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind</span>(</span>
<span id="cb2-21">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sonify</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">duration =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">flim =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">600</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">600</span>)),</span>
<span id="cb2-22">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sonify</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">duration =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">flim =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">600</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">600</span>)),</span>
<span id="cb2-23">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sonify</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">duration =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">flim =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">800</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">800</span>))</span>
<span id="cb2-24">  ),</span>
<span id="cb2-25">  </span>
<span id="cb2-26">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lose =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind</span>(</span>
<span id="cb2-27">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sonify</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">duration =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">flim =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">600</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">600</span>)),</span>
<span id="cb2-28">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sonify</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">duration =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">flim =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">600</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">600</span>)),</span>
<span id="cb2-29">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sonify</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">duration =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">flim =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">400</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">400</span>))</span>
<span id="cb2-30">  )</span>
<span id="cb2-31">  </span>
<span id="cb2-32">)</span>
<span id="cb2-33"></span>
<span id="cb2-34"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">walk2</span>(</span>
<span id="cb2-35">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.x =</span> sfx,</span>
<span id="cb2-36">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.y =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(sfx), </span>
<span id="cb2-37">  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">writeWave</span>(.x, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(.y, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".wav"</span>))</span>
<span id="cb2-38">)</span></code></pre></div>
</div>
</details>
<p>In reality, the sounds play a little slower in the game itself, but it was a bit fiddly to reproduce it for these clips. You‚Äôll get the idea.</p>
<section id="move" class="level3">
<h3 class="anchored" data-anchor-id="move">Move</h3>
<p>Step onto unoccupied floor tile (<code>.</code>) and you‚Äôll hear the very quick tap of your boot.</p>
<p>Click to play the sound:</p>

<audio controls="">
<source src="resources/move.wav" type="audio/wav">
</audio>

<p>And here‚Äôs the corresponding code to reproduce it:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sonify</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">duration =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.001</span>)</span></code></pre></div>
</div>
<p>But bump into the dungeon wall (<code>#</code>) and you‚Äôll get a dull thud, you absolute clod.</p>

<audio controls="">
<source src="resources/bump.wav" type="audio/wav">
</audio>

<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sonify</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">duration =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">flim =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">110</span>))</span></code></pre></div>
</div>
<p>Yes, <code>flim</code>, as in: ‚Äòthis post is absolute flimflam‚Äô.</p>
</section>
<section id="food" class="level3">
<h3 class="anchored" data-anchor-id="food">Food</h3>
<p>Would you pick up an apple (<code>a</code>) you found on the floor of a cave? Here‚Äôs what it might sound like as it pops into your inventory.</p>

<audio controls="">
<source src="resources/apple.wav" type="audio/wav">
</audio>

<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sonify</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">duration =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>),</span></code></pre></div>
</div>
<p>More importantly, would you eat an apple (<code>a</code>) you found on the floor of a cave? Here‚Äôs how it would sound as it rolls down your gullet.</p>

<audio controls="">
<source src="resources/eat.wav" type="audio/wav">
</audio>

<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sonify</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">duration =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>)</span></code></pre></div>
</div>
</section>
<section id="gold" class="level3">
<h3 class="anchored" data-anchor-id="gold">Gold</h3>
<p>Collecting gold (<code>$</code>) grants you a celebratory chirp of excitement. Although there‚Äôs not actually anything in the dungeon to spend it on, sorry.</p>

<audio controls="">
<source src="resources/gold.wav" type="audio/wav">
</audio>

<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sonify</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">duration =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">flim =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">800</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">800</span>))</span>
<span id="cb7-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sonify</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">duration =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">flim =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>))</span></code></pre></div>
</div>
</section>
<section id="defeat-enemy" class="level3">
<h3 class="anchored" data-anchor-id="defeat-enemy">Defeat enemy</h3>
<p>A powerful victory ditty after you crush your enemies (<code>E</code>).</p>

<audio controls="">
<source src="resources/win.wav" type="audio/wav">
</audio>

<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sonify</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">duration =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">flim =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">600</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">600</span>))</span>
<span id="cb8-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sonify</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">duration =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">flim =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">600</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">600</span>))</span>
<span id="cb8-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sonify</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">duration =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">flim =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">800</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">800</span>))</span></code></pre></div>
</div>
</section>
<section id="lose" class="level3">
<h3 class="anchored" data-anchor-id="lose">Lose</h3>
<p>Conversely, a sad lament for being crushed by your enemies (<code>E</code>) or running out of turns (<code>T</code>).</p>

<audio controls="">
<source src="resources/lose.wav" type="audio/wav">
</audio>

<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sonify</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">duration =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">flim =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">600</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">600</span>))</span>
<span id="cb9-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sonify</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">duration =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">flim =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">600</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">600</span>))</span>
<span id="cb9-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sonify</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">duration =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">flim =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">400</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">400</span>))</span></code></pre></div>
</div>
</section>
</section>
<section id="echo-echo-echo" class="level2">
<h2 class="anchored" data-anchor-id="echo-echo-echo">Echo echo echo</h2>
<p>If you want to try out {r.oguelike}, you can install it from GitHub:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install.github</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"remotes"</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># if not yet installed</span></span>
<span id="cb10-2">remotes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install_github</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"matt-dray/r.oguelike"</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># v0.1 currently</span></span>
<span id="cb10-3">r.oguelike<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">start_game</span>()</span></code></pre></div>
</div>
<p>You can also <a href="https://mybinder.org/v2/gh/matt-dray/play-r.oguelike/main?urlpath=rstudio">run {r.oguelike} in an RStudio instance in your browser</a> (!), thanks to <a href="https://mybinder.org/">the Binder project</a>.</p>
<p>Free feel to highlight any bugs via <a href="https://github.com/matt-dray/rostrum-blog/issues">the issues</a>, or create a pull request that adds all the things that stop me from calling {r.oguelike} a proper ‚Äògame‚Äô.<sup>2</sup></p>
<p><img src="https://whimsical-wisp-30974e.netlify.app/posts/2023-01-04-rogue-sfx/resources/r.oguelike-hex.png" class="img-fluid" style="width:25.0%" alt="Hex sticker design for the 'r.oguelike' R package. Black background with bright green font, reminiscent of old computer terminal output. In the centre, a three-by-ten arrangement of hashmarks and periods, along with a single at symbol and dollar sign, which looks like a classic ASCII tile-based roguelike game. The text 'r.oguelike' is underneath."></p>
<p>Most importantly, don‚Äôt forget to wishlist me on Steam and remember that pre-order bonuses will include an apple that‚Äôs been left on a dungeon floor for a few months.</p>
</section>



<div id="quarto-appendix" class="default"><section id="environment" class="level2 appendix"><h2 class="anchored quarto-appendix-heading">Environment</h2><div class="quarto-appendix-contents">

<details>
<summary>
Session info
</summary>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Last rendered: 2023-07-21 19:28:31 BST</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.3.1 (2023-06-16)
Platform: aarch64-apple-darwin20 (64-bit)
Running under: macOS Ventura 13.2.1

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: Europe/London
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

loaded via a namespace (and not attached):
 [1] htmlwidgets_1.6.2 compiler_4.3.1    fastmap_1.1.1     cli_3.6.1        
 [5] tools_4.3.1       htmltools_0.5.5   rstudioapi_0.15.0 yaml_2.3.7       
 [9] rmarkdown_2.23    knitr_1.43.1      jsonlite_1.8.7    xfun_0.39        
[13] digest_0.6.33     rlang_1.1.1       evaluate_0.21    </code></pre>
</div>
</div>
</details>


</div></section><aside id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Meanwhile, I‚Äôm looking forward to what <a href="https://twitter.com/coolbutuseless/status/1561664096860524545">Mike (coolbutuseless) is up to with audio for games in R</a>.‚Ü©Ô∏é</p></li>
<li id="fn2"><p>Find some actual real R games in <a href="https://github.com/matt-dray/awesome-r-games">this list I‚Äôve put together</a>.‚Ü©Ô∏é</p></li>
</ol>
</aside><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div id="quarto-reuse" class="quarto-appendix-contents"><div>CC BY-NC-SA 4.0</div></div></section></div> ]]></description>
  <category>gamedev</category>
  <category>r</category>
  <category>r.oguelike</category>
  <category>sonify</category>
  <category>videogames</category>
  <guid>https://whimsical-wisp-30974e.netlify.app/posts/2023-01-04-rogue-sfx/index.html</guid>
  <pubDate>Wed, 04 Jan 2023 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Animate sprites in R with {pixeltrix}</title>
  <dc:creator>Matt Dray</dc:creator>
  <link>https://whimsical-wisp-30974e.netlify.app/posts/2022-12-11-pixeltrix-animate/index.html</link>
  <description><![CDATA[ 




<p><img src="https://whimsical-wisp-30974e.netlify.app/posts/2022-12-11-pixeltrix-animate/resources/mario.gif" class="img-fluid" style="width:32.0%" alt="The walk cycle of the Mario sprite from the original Super Mario Bros game"> <img src="https://whimsical-wisp-30974e.netlify.app/posts/2022-12-11-pixeltrix-animate/resources/mario.gif" class="img-fluid" style="width:32.0%"> <img src="https://whimsical-wisp-30974e.netlify.app/posts/2022-12-11-pixeltrix-animate/resources/mario.gif" class="img-fluid" style="width:32.0%"></p>
<section id="tldr" class="level2">
<h2 class="anchored" data-anchor-id="tldr">tl;dr</h2>
<p>I‚Äôve updated <a href="https://github.com/matt-dray/pixeltrix">the {pixeltrix} package</a> so you can create animated sprite gifs with a simple, interactive pixel editor from within R‚Äôs plot window.</p>
</section>
<section id="pix-all-the-right-boxes" class="level2">
<h2 class="anchored" data-anchor-id="pix-all-the-right-boxes">Pix all the right boxes</h2>
<p>The {pixeltrix} package‚Äîwhich I‚Äôve <a href="https://www.rostrum.blog/2022/09/24/pixeltrix/">written about before</a>‚Äîlets you open an interactive R plot that you can click to turn ‚Äòpixels‚Äô on and off.</p>
<p>I created it for one purpose: to quickly create simple, blocky sprites for <a href="https://github.com/matt-dray/tamRgo">my {tamRgo} package</a>, which lets you keep a persistent cyberpet on your computer (<a href="https://www.rostrum.blog/2022/11/13/tamrgo/">yes, really</a>).</p>
<p>But wouldn‚Äôt it be nice if {pixeltrix} were more‚Ä¶ general? Read on for a couple of improvements to the package that might help.</p>
<div class="tip">
<p> <b>Note</b></p>
<p>The package has been updated again since this post. From version 0.2 you:</p>
<ul>
<li>can provide colours as input to <code>click_pixels()</code> and <code>frame_pixels()</code></li>
<li>receive a <code>colours</code> attribute with the output matrices, which encodes the state and colour values</li>
</ul>
</div>
</section>
<section id="pixellate-to-accumulate" class="level2">
<h2 class="anchored" data-anchor-id="pixellate-to-accumulate">Pixellate to accumulate</h2>
<p>First, you can <a href="https://github.com/matt-dray/pixeltrix">install the updated package from GitHub</a>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">remotes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">install_github</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"matt-dray/pixeltrix"</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># v0.1.2 in this post</span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(pixeltrix)</span></code></pre></div>
</div>
<p>Now the improvements: plotting with colour, and creating gif animations.</p>
<section id="plot" class="level3">
<h3 class="anchored" data-anchor-id="plot">1. Plot</h3>
<p>The <code>click_pixel()</code> function opens an interactive plot. If <code>n_state = 3</code>, for example, then each pixel will cycle through three states as you keep clicking it. You‚Äôre returned a matrix of these values when you hit <kbd>Esc</kbd>.</p>
<p>That was enough for {tamRgo}: I turned a binary matrix into a 1-bit sprite. But wouldn‚Äôt it be good‚Äîfundamental!‚Äîto be able to plot the matrix as an image with user-specified colours? So I made <code>draw_pixels()</code>.</p>
<p>I‚Äôve added a three-state matrix, <code>blue</code>, into the package as an example dataset. Let‚Äôs plot it with simple colours:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">draw_pixels</span>(</span>
<span id="cb2-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">m =</span> pixeltrix<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>blue, </span>
<span id="cb2-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">colours =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#879afb"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gray20"</span>)</span>
<span id="cb2-4">)</span></code></pre></div>
</div>
<p><img src="https://whimsical-wisp-30974e.netlify.app/posts/2022-12-11-pixeltrix-animate/resources/blue_draw.png" class="img-fluid" style="width:33.0%" alt="A 14 by 16 pixel grid with a sprite of the main character from the first generation of Pokemon games for the Game Boy. The background is white, the outlines are dark grey and the highlights are light blue."></p>
<p>Of course, it‚Äôs the subtly-coloured player character from <em>Pok√©mon Blue</em> (1996) as seen on the Nintendo Game Boy Color.</p>
</section>
<section id="animate" class="level3">
<h3 class="anchored" data-anchor-id="animate">2. Animate</h3>
<p>Naturally, you could use <code>click_pixels()</code> and <code>draw_pixels()</code> to generate several images and combine them as ‚Äòframes‚Äô of an animation. Why not have a function that does this automatically?</p>
<p>So that‚Äôs what I did:</p>
<ul>
<li><code>frame_pixels()</code> calls <code>click_pixels()</code> and adds the output as the first element of a list, then it passes that matrix into <code>edit_pixels()</code> as the template for the next frame (and so on until you choose to stop making frames)</li>
<li><code>gif_pixels()</code> takes the list of matrices created by <code>frame_pixels()</code> and draws, combines and writes them to a gif</li>
</ul>
<p>I‚Äôve prepared <code>pixeltrix::mario</code> as an example of an output from <code>frame_pixels()</code>. It contains each of three frames that comprise Mario‚Äôs walk cycle from <em>Super Mario Bros</em> on the NES.</p>
<p>Here‚Äôs what the console output looked like when I made <code>mario</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">mario <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">frame_pixels</span>(</span>
<span id="cb3-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n_rows   =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>,</span>
<span id="cb3-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n_cols   =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>,</span>
<span id="cb3-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n_states =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># background + 3 colours</span></span>
<span id="cb3-5">)</span></code></pre></div>
</div>
<pre><code>Click squares in the plot window. Press &lt;Esc&gt; to end.
Add a frame? y/n: y
Click squares in the plot window. Press &lt;Esc&gt; to end.
Current frame count: 2
Add a frame? y/n: y
Click squares in the plot window. Press &lt;Esc&gt; to end.
Current frame count: 3
Add a frame? y/n: n
Final frame count: 3</code></pre>
<p>You can see there‚Äôs interactivity; the user is prompted to add another frame with <code>Add a frame? y/n:</code>, where <code>y</code> will let you create a new frame and <code>n</code> will stop the process and return the list of matrices.</p>
<p>And so you can see it‚Äôs a list of three matrices:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str</span>(mario)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>List of 3
 $ : int [1:16, 1:16] 0 0 0 0 0 0 0 0 1 1 ...
 $ : int [1:16, 1:16] 0 0 0 0 0 0 0 0 0 0 ...
 $ : int [1:16, 1:16] 0 0 0 0 0 0 0 0 0 0 ...</code></pre>
</div>
</div>
<p>You can then convert the list to a gif with <code>gif_pixels()</code>, which engifs the frames using <a href="https://cloud.r-project.org/web/packages/gifski/index.html">{gifski}</a>.<sup>1</sup></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gif_pixels</span>(</span>
<span id="cb7-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">frames =</span> mario,</span>
<span id="cb7-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">colours =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb7-4">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"white"</span>,    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># background</span></span>
<span id="cb7-5">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#FDA428"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># skin (yellowish)</span></span>
<span id="cb7-6">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#FC0D1B"</span>,  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># overalls/hat (red)</span></span>
<span id="cb7-7">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#A32B2E"</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># hair, eyes, shirt, boots (brown)</span></span>
<span id="cb7-8">  ),</span>
<span id="cb7-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">file =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mario.gif"</span>,</span>
<span id="cb7-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">delay =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.15</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># passed via dots to gifski::save_gif()</span></span>
<span id="cb7-11">)</span></code></pre></div>
</div>
<pre><code>Inserting image 3 at 0.30s (100%)...
Encoding to gif... done!
[1] "mario.gif"</code></pre>
<p>And if we open that file:</p>
<p><img src="https://whimsical-wisp-30974e.netlify.app/posts/2022-12-11-pixeltrix-animate/resources/mario.gif" class="img-fluid" style="width:33.0%" alt="An animated 16 by 16 pixel grid with a coloured sprite of Mario from the original Super Mario Bros for the NES. There are three frames that each show a step in Mario's walk cycle."></p>
<p>Yahoooooo, created entirely with R. Noice.</p>
</section>
<section id="pix-n-mix" class="level3">
<h3 class="anchored" data-anchor-id="pix-n-mix">Pix n mix</h3>
<p>So {pixeltrix} finally got a couple of nice-to-have (well, must-have) functions. This is enough for me to continue just messing around with it as a novelty<sup>2</sup>.</p>
<p>I mean, come on: animated pixelart created in an interactive R plot window? Why? I mean, er‚Ä¶ wow!</p>
</section>
</section>



<div id="quarto-appendix" class="default"><section id="environment" class="level2 appendix"><h2 class="anchored quarto-appendix-heading">Environment</h2><div class="quarto-appendix-contents">

<details>
<summary>
Session info
</summary>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Last rendered: 2023-07-17 18:10:37 BST</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.3.1 (2023-06-16)
Platform: aarch64-apple-darwin20 (64-bit)
Running under: macOS Ventura 13.2.1

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: Europe/London
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
[1] pixeltrix_0.2.1.9000

loaded via a namespace (and not attached):
 [1] htmlwidgets_1.6.2 compiler_4.3.1    fastmap_1.1.1     cli_3.6.1        
 [5] tools_4.3.1       htmltools_0.5.5   rstudioapi_0.15.0 yaml_2.3.7       
 [9] rmarkdown_2.23    knitr_1.43.1      jsonlite_1.8.7    xfun_0.39        
[13] digest_0.6.31     rlang_1.1.1       fontawesome_0.5.1 evaluate_0.21    </code></pre>
</div>
</div>
</details>


</div></section><aside id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>The {pixeltrix} package has no dependencies and I didn‚Äôt want to force a user to install {gifski} if they weren‚Äôt going to use <code>gif_pixels()</code>. It‚Äôs therefore up to the user to install it. <a href="https://github.com/matt-dray/pixeltrix/issues/15">I also wonder</a> if I should provide an argument for the user to name a ‚Äògif engine‚Äô of choice, e.g.&nbsp;{gifski} or {magick}, depending on what they‚Äôve got installed on their machine.‚Ü©Ô∏é</p></li>
<li id="fn2"><p>It‚Äôs never, ever going to have the features and quality of a premium pixel-art program like <a href="https://www.aseprite.org/">Aseprite</a>, obviously.‚Ü©Ô∏é</p></li>
</ol>
</aside><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div id="quarto-reuse" class="quarto-appendix-contents"><div>CC BY-NC-SA 4.0</div></div></section></div> ]]></description>
  <category>art</category>
  <category>gifski</category>
  <category>locator</category>
  <category>pixeltrix</category>
  <category>r</category>
  <category>videogames</category>
  <guid>https://whimsical-wisp-30974e.netlify.app/posts/2022-12-11-pixeltrix-animate/index.html</guid>
  <pubDate>Sun, 11 Dec 2022 00:00:00 GMT</pubDate>
</item>
</channel>
</rss>
